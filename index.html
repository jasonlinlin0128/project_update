<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å¤šåŠŸèƒ½å°ˆæ¡ˆç®¡ç†èˆ‡æºé€šå„€è¡¨æ¿">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>å¤šåŠŸèƒ½æ•´åˆå„€è¡¨æ¿ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- å‚™ç”¨å­—é«”å’Œæ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Theme (Default) */
            --bg-gradient-1: #e0f2fe;
            --bg-gradient-2: #dbeafe;
            --bg-gradient-3: #fce7f3;
            --bg-gradient-4: #e0e7ff;
            --bg-gradient-5: #f0fdfa;

            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;

            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.8);
            --card-bg: rgba(255, 255, 255, 0.85);
            --input-bg: rgba(255, 255, 255, 0.6);
        }

        body.dark-theme {
            /* Dark Theme */
            --bg-gradient-1: #1e293b;
            --bg-gradient-2: #334155;
            --bg-gradient-3: #4c1d95;
            --bg-gradient-4: #1e3a8a;
            --bg-gradient-5: #164e63;

            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-tertiary: #d1d5db;

            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(30, 41, 59, 0.85);
            --input-bg: rgba(15, 23, 42, 0.6);
        }

        /* Glassmorphism - Gradient Background with Theme Support */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg,
                var(--bg-gradient-1) 0%,
                var(--bg-gradient-2) 25%,
                var(--bg-gradient-3) 50%,
                var(--bg-gradient-4) 75%,
                var(--bg-gradient-5) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Scrollbar Styling */
        .kanban-column-content::-webkit-scrollbar, .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .kanban-column-content::-webkit-scrollbar-track, .table-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb:hover, .table-container::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

        /* Glassmorphism - Dashboard Tabs */
        .dashboard-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .dashboard-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .dashboard-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            border-bottom-color: white;
            font-weight: 600;
        }
        .hidden { display: none; }
        
        /* Calendar Styles */
        #calendar-grid { grid-template-rows: repeat(6, minmax(0, 1fr)); }
        .calendar-day { min-height: 100px; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-task {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - é˜²æ­¢æ–‡å­—æº¢å‡º */
        @media (max-width: 768px) {
            /* å°ˆæ¡ˆå¡ç‰‡æ¨™é¡Œè‡ªå‹•æ›è¡Œ */
            .project-card h3,
            .project-card p,
            .project-card span {
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            /* è¡¨æ ¼åœ¨æ‰‹æ©Ÿä¸Šå…è¨±æ›è¡Œ */
            td.whitespace-nowrap {
                white-space: normal !important;
            }

            /* è¡Œäº‹æ›†ä»»å‹™åœ¨æ‰‹æ©Ÿä¸Šç¸®å°å­—é«” */
            .calendar-task {
                font-size: 0.65rem;
            }

            /* æŒ‰éˆ•æ–‡å­—åœ¨æ‰‹æ©Ÿä¸Šç¸®å° */
            button {
                font-size: 0.875rem;
            }

            /* å°èˆªæ¨™ç±¤åœ¨æ‰‹æ©Ÿä¸Šç¸®å°é–“è· */
            .dashboard-tab {
                padding: 10px 12px;
                font-size: 0.875rem;
            }

            /* å¡ç‰‡å…§å®¹ç¢ºä¿ä¸æº¢å‡º */
            .bg-white,
            .modal-content {
                max-width: 100%;
                overflow-x: hidden;
            }
        }
        
        /* Details Summary Styling */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details .summary-icon { transition: transform 0.2s; }
        details[open] .summary-icon { transform: rotate(90deg); }
        
        /* Glassmorphism - Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
        }

        /* Glassmorphism - Project Cards */
        .project-card {
            background: rgba(255, 255, 255, 0.25) !important;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
            background: rgba(255, 255, 255, 0.35) !important;
        }
        .file-upload-area { 
            border: 2px dashed #d1d5db; 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            transition: all 0.2s ease; 
        }
        .file-upload-area:hover { border-color: #3b82f6; background-color: #f8fafc; }
        .file-upload-area.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* Comments Section */
        .comment-bubble {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        .comment-bubble.manager {
            background: #fee2e2;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Glassmorphism - Text Styling with High Contrast */
        h1, h2, h3 {
            color: var(--text-primary) !important;
            text-shadow: none;
            font-weight: 700;
        }

        .text-gray-800, .text-gray-700, .text-gray-600, .text-gray-500 {
            color: var(--text-secondary) !important;
            text-shadow: none;
        }

        .text-gray-400 {
            color: var(--text-tertiary) !important;
            text-shadow: none;
        }

        p, span, div, label {
            color: var(--text-secondary) !important;
        }

        /* ç¢ºä¿ Modal å…§çš„å…ƒç´ ä½¿ç”¨æ­£ç¢ºçš„æ–‡å­—é¡è‰² */
        .modal-content p,
        .modal-content span,
        .modal-content div,
        .modal-content label {
            color: inherit;
        }

        .modal-content h1,
        .modal-content h2,
        .modal-content h3,
        .modal-content h4 {
            color: var(--text-primary) !important;
        }

        /* ç¢ºä¿è¼¸å…¥æ¡†å’Œæ–‡å­—å€åŸŸä½¿ç”¨æ­£ç¢ºçš„é¡è‰² */
        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content input[type="number"],
        .modal-content textarea,
        .modal-content select {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--glass-border);
        }

        .modal-content input[type="text"]::placeholder,
        .modal-content textarea::placeholder {
            color: var(--text-tertiary);
        }

        /* Glassmorphism - Buttons */
        .action-btn, button[class*="bg-"] {
            background: var(--card-bg) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border) !important;
            color: var(--text-primary) !important;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .action-btn:hover, button[class*="bg-"]:hover {
            background: var(--glass-bg) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* Glassmorphism - Input Fields */
        input, select, textarea {
            background: var(--input-bg) !important;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border) !important;
            color: var(--text-primary) !important;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-tertiary) !important;
        }

        input:focus, select:focus, textarea:focus {
            background: var(--card-bg) !important;
            border-color: #3b82f6 !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        /* Glassmorphism - Navigation Bar */
        nav {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            margin: 20px;
        }

        /* Glassmorphism - Main Content Area */
        main {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            margin: 20px;
        }

        /* Glassmorphism - Stat Cards / Summary Cards */
        .bg-blue-100, .bg-orange-100, .bg-purple-100, .bg-red-100, .bg-green-100,
        .bg-teal-50, .bg-blue-50, .bg-purple-50, .bg-green-50, .bg-orange-50 {
            background: var(--card-bg) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Glassmorphism - Kanban Columns */
        .bg-gray-100 {
            background: var(--card-bg) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border) !important;
        }

        /* Glassmorphism - Column Headers keep their solid colors but with glass effect */
        .bg-purple-500, .bg-blue-500, .bg-orange-500, .bg-teal-500, .bg-red-500, .bg-green-600 {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Glassmorphism - Labels and Badges */
        .text-blue-800, .text-blue-600, .text-orange-800, .text-purple-800, .text-green-800, .text-red-800,
        .text-yellow-800, .text-teal-800 {
            color: var(--text-primary) !important;
            font-weight: 600;
        }

        /* Dashboard Tab Styling */
        .dashboard-tab {
            color: var(--text-secondary) !important;
        }

        .dashboard-tab.active {
            color: var(--text-primary) !important;
        }

        /* Theme Toggle Button */
        #theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        #theme-toggle:hover {
            background: var(--glass-bg);
        }

        /* Project Card Improvements */
        .project-card {
            background: var(--card-bg) !important;
        }

        .project-card:hover {
            background: var(--glass-bg) !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Navigation Tabs -->
        <nav class="bg-white rounded-t-lg shadow-sm">
            <div class="flex items-center justify-between p-2">
                <div id="tab-container" class="flex border-b-0 overflow-x-auto flex-1">
                    <button data-target="dashboard-ai" class="dashboard-tab active flex-shrink-0">AI å°ˆæ¡ˆé€²åº¦</button>
                    <button data-target="dashboard-routine" class="dashboard-tab flex-shrink-0">ä¾‹è¡Œå…¬äº‹</button>
                    <button data-target="dashboard-sharing" class="dashboard-tab flex-shrink-0">åˆ†äº«æœƒ</button>
                    <button data-target="dashboard-events" class="dashboard-tab flex-shrink-0">æ´»å‹•åƒèˆ‡</button>
                    <button data-target="dashboard-contacts" class="dashboard-tab flex-shrink-0">æ¥æ´½ä¼æ¥­</button>
                </div>
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" onclick="toggleTheme()" class="ml-4 px-4 py-2 rounded-lg transition-all">
                    <i id="theme-icon" class="fas fa-moon"></i>
                    <span id="theme-text" class="ml-2">æ·±è‰²</span>
                </button>
            </div>
        </nav>

        <!-- Dashboard Content Area -->
        <main class="bg-white p-6 rounded-b-lg shadow-sm min-h-[80vh]">
            <!-- 1. AI Project Dashboard -->
            <div id="dashboard-ai" class="dashboard-content">
                <header class="md:flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">AI å°ˆæ¡ˆé€²åº¦å„€è¡¨æ¿</h1>
                        <p class="text-gray-500 mt-1">æ¦‚è¦½æ‰€æœ‰é€²è¡Œä¸­èˆ‡æ§‹æ€ä¸­çš„ AI å°å…¥å°ˆæ¡ˆã€‚</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-4">
                        <button onclick="showAddProjectModal()" class="action-btn">
                            <i class="fas fa-plus mr-2"></i>æ–°å¢å°ˆæ¡ˆ
                        </button>
                        <button onclick="showFieldConfigModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-cog mr-2"></i>é¡¯ç¤ºæ¬„ä½
                        </button>
                        <button onclick="reloadProjects()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>é‡æ–°è¼‰å…¥
                        </button>
                        <button onclick="exportProjects()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>åŒ¯å‡ºè³‡æ–™
                        </button>
                        <div>
                            <label for="month-filter" class="text-sm font-medium text-gray-700 mr-2">ä¾æˆç«‹æœˆä»½ç¯©é¸:</label>
                            <select id="month-filter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                        </div>
                        <div id="sync-status" class="flex items-center">
                            <div class="spinner mr-2"></div>
                            <span class="text-sm text-gray-500">åŒæ­¥ä¸­...</span>
                        </div>
                    </div>
                </header>
                <div id="ai-summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
                <div id="ai-kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6"></div>
            </div>

            <!-- 2. Routine Tasks Dashboard -->
            <div id="dashboard-routine" class="dashboard-content hidden">
                 <header class="mb-6 flex justify-between items-center">
                     <div>
                         <h1 class="text-3xl font-bold text-gray-800">ä¾‹è¡Œå…¬äº‹å„€è¡¨æ¿</h1>
                         <p class="text-gray-500 mt-1">è¿½è¹¤æ¯æ—¥ã€æ¯é€±ã€æ¯æœˆçš„é‡è¤‡æ€§ä»»å‹™ã€‚</p>
                     </div>
                     <button onclick="showAddRoutineModal()" class="action-btn">
                         <i class="fas fa-plus mr-2"></i>æ–°å¢ä»»å‹™
                     </button>
                 </header>

                 <!-- æœå°‹èˆ‡ç¯©é¸å€ -->
                 <div class="mb-6 space-y-4">
                     <!-- æœå°‹æ¡† -->
                     <div class="relative">
                         <input type="text"
                                id="routine-search"
                                placeholder="ğŸ” æœå°‹ä»»å‹™åç¨±..."
                                oninput="handleRoutineSearch(this.value)"
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                         <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                     </div>

                     <!-- ç¯©é¸æŒ‰éˆ•çµ„ -->
                     <div class="flex flex-wrap gap-2" id="routine-filter-buttons">
                         <button onclick="filterRoutineTasks('all')"
                                 data-filter="all"
                                 class="routine-filter-btn active px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700">
                             å…¨éƒ¨
                         </button>
                         <button onclick="filterRoutineTasks('daily')"
                                 data-filter="daily"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             æ¯æ—¥ä»»å‹™
                         </button>
                         <button onclick="filterRoutineTasks('threeWeeks')"
                                 data-filter="threeWeeks"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             ä¸‰é€±ä¸€æ¬¡
                         </button>
                         <button onclick="filterRoutineTasks('monthly')"
                                 data-filter="monthly"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             æ¯æœˆä»»å‹™
                         </button>
                         <button onclick="filterRoutineTasks('bimonthly')"
                                 data-filter="bimonthly"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             é›™æœˆä»»å‹™
                         </button>
                         <button onclick="filterRoutineTasks('completed')"
                                 data-filter="completed"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             ä»Šæ—¥å·²å®Œæˆ
                         </button>
                         <button onclick="filterRoutineTasks('pending')"
                                 data-filter="pending"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             ä»Šæ—¥å¾…å®Œæˆ
                         </button>
                     </div>
                 </div>

                 <div id="routine-tasks-content" class="space-y-8"></div>
                 <div class="mt-12">
                     <div id="calendar-header" class="flex items-center justify-between mb-4"></div>
                     <div id="calendar-body"></div>
                 </div>
            </div>

            <!-- 3. Sharing Session Dashboard -->
            <div id="dashboard-sharing" class="dashboard-content hidden">
                 <header class="mb-6 flex justify-between items-center">
                     <div>
                         <h1 class="text-3xl font-bold text-gray-800">åˆ†äº«æœƒå„€è¡¨æ¿</h1>
                         <p class="text-gray-500 mt-1">è¦åŠƒèˆ‡å›é¡§å…§éƒ¨ AI æ–°çŸ¥åˆ†äº«æœƒã€‚</p>
                     </div>
                     <button onclick="showAddSharingModal()" class="action-btn">
                         <i class="fas fa-plus mr-2"></i>æ–°å¢åˆ†äº«æœƒ
                     </button>
                 </header>

                 <!-- æœå°‹å€ -->
                 <div class="mb-6">
                     <div class="relative">
                         <input type="text"
                                id="sharing-search"
                                placeholder="ğŸ” æœå°‹åˆ†äº«æœƒä¸»é¡Œã€è¬›è€…æˆ–è­°ç¨‹å…§å®¹..."
                                oninput="handleSharingSearch(this.value)"
                                class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                         <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                     </div>
                 </div>

                 <div id="sharing-session-content"></div>
            </div>

            <!-- 4. Event Participation Dashboard -->
            <div id="dashboard-events" class="dashboard-content hidden">
                 <header class="mb-8">
                     <div class="flex justify-between items-center mb-4">
                         <div>
                             <h1 class="text-3xl font-bold text-gray-800">æ´»å‹•åƒèˆ‡å„€è¡¨æ¿</h1>
                             <p class="text-gray-500 mt-1">è¨˜éŒ„å…§å¤–éƒ¨æ´»å‹•çš„å­¸ç¿’èˆ‡æ”¶ç©«ã€‚</p>
                         </div>
                         <button onclick="showAddEventModal()" class="action-btn">
                             <i class="fas fa-plus mr-2"></i>æ–°å¢æ´»å‹•
                         </button>
                     </div>
                     <div class="flex items-center space-x-4">
                         <div class="flex-1">
                             <input id="event-search" type="text" placeholder="æœå°‹æ´»å‹•åç¨±æˆ–æ¦‚è¿°..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    oninput="filterEvents()">
                         </div>
                         <select id="event-type-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterEvents()">
                             <option value="all">æ‰€æœ‰é¡å‹</option>
                             <option value="external">å¤–éƒ¨æ´»å‹•</option>
                             <option value="internal">å…§éƒ¨æ´»å‹•</option>
                         </select>
                     </div>
                 </header>
                 <div id="event-participation-content" class="space-y-10"></div>
            </div>

            <!-- 5. Business Contact Dashboard -->
            <div id="dashboard-contacts" class="dashboard-content hidden">
                 <header class="mb-8">
                     <div class="flex justify-between items-center mb-4">
                         <div>
                             <h1 class="text-3xl font-bold text-gray-800">æ¥æ´½ä¼æ¥­å„€è¡¨æ¿</h1>
                             <p class="text-gray-500 mt-1">ç®¡ç†èˆ‡å¤–éƒ¨ä¼æ¥­ã€å» å•†çš„åˆä½œèˆ‡æ´½è«‡ç´€éŒ„ã€‚</p>
                         </div>
                         <button onclick="showAddContactModal()" class="action-btn">
                             <i class="fas fa-plus mr-2"></i>æ–°å¢æ¥æ´½
                         </button>
                     </div>
                     <div class="flex-1">
                         <input id="contact-search" type="text" placeholder="æœå°‹ä¼æ¥­åç¨±ã€è¯çµ¡äººæˆ–æ´½è«‡ä¸»é¡Œ..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                oninput="filterContacts()">
                     </div>
                 </header>
                 <div id="business-contacts-content" class="table-container overflow-x-auto"></div>
            </div>
        </main>
    </div>

    <!-- Enhanced Project Detail Modal -->
    <div id="project-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-5xl mx-4">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="modal-project-name" class="text-2xl font-bold text-gray-800"></h2>
                        <p id="modal-project-department" class="text-gray-600 mt-1"></p>
                    </div>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Edit/View Toggle -->
                <div class="mb-4">
                    <button id="toggle-edit-mode" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-edit mr-2"></i>ç·¨è¼¯å°ˆæ¡ˆè³‡è¨Š
                    </button>
                </div>

                <!-- Project Basic Info (Editable) -->
                <div id="project-info-view" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">åŸºæœ¬è³‡è¨Š</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">é–‹å§‹æ—¥æœŸ:</span>
                                <span id="modal-start-date" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">é è¨ˆå®Œæˆ:</span>
                                <span id="modal-due-date" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">å„ªå…ˆç´š:</span>
                                <span id="modal-priority" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ç‹€æ…‹:</span>
                                <span id="modal-status" class="font-medium text-gray-800"></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">é€²åº¦è¿½è¹¤</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">å®Œæˆé€²åº¦</span>
                                <span id="modal-progress-text" class="text-sm font-medium text-gray-800"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="modal-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Form (Initially Hidden) -->
                <div id="project-info-edit" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                            <input id="edit-project-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è² è²¬éƒ¨é–€</label>
                            <input id="edit-department" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                            <input id="edit-start-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é è¨ˆå®Œæˆ</label>
                            <input id="edit-due-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆç´š</label>
                            <select id="edit-priority" class="w-full px-3 py-2 border rounded-lg">
                                <option value="é«˜">é«˜</option>
                                <option value="ä¸­">ä¸­</option>
                                <option value="ä½">ä½</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                            <select id="edit-status" class="w-full px-3 py-2 border rounded-lg">
                                <option value="æ§‹æ€ä¸­">æ§‹æ€ä¸­</option>
                                <option value="è¦åŠƒä¸­">è¦åŠƒä¸­</option>
                                <option value="é–‹ç™¼ä¸­">é–‹ç™¼ä¸­</option>
                                <option value="æ¸¬è©¦ä¸­">æ¸¬è©¦ä¸­</option>
                                <option value="å·²çµ‚æ­¢">å·²çµ‚æ­¢</option>
                                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é€²åº¦ (%)</label>
                            <input id="edit-progress" type="number" min="0" max="100" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <button onclick="saveProjectEdit()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full">
                                <i class="fas fa-save mr-2"></i>å„²å­˜è®Šæ›´
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Project Progress Notes -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">å°ˆæ¡ˆé€²åº¦èªªæ˜</h3>
                    <textarea id="project-notes" placeholder="åœ¨æ­¤è¼¸å…¥å°ˆæ¡ˆé€²åº¦èªªæ˜ã€é‡åˆ°çš„å•é¡Œã€è§£æ±ºæ–¹æ¡ˆç­‰è©³ç´°è³‡è¨Š..." 
                              class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="save-notes" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>å„²å­˜èªªæ˜
                        </button>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-comments mr-2"></i>è©•è«–èˆ‡è¨è«–
                    </h3>
                    
                    <!-- Add New Comment -->
                    <div class="mb-4">
                        <div class="mb-2">
                            <span id="comment-role-indicator" class="inline-block px-3 py-1 rounded-full text-sm font-semibold">
                                <i class="fas fa-user-circle mr-1"></i>ä»¥ <span id="comment-role-text">å“¡å·¥</span> èº«ä»½ç•™è¨€
                            </span>
                        </div>
                        <div class="flex items-start space-x-3">
                            <input type="hidden" id="comment-author" value="å“¡å·¥">
                            <textarea id="new-comment" placeholder="è¼¸å…¥æ‚¨çš„è©•è«–æˆ–å»ºè­°..."
                                      class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                      rows="2"></textarea>
                            <button id="add-comment" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Comments List -->
                    <div id="comments-list" class="max-h-64 overflow-y-auto">
                        <!-- Comments will be rendered here -->
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">ç›¸é—œæ–‡ä»¶</h3>
                    <div id="file-upload-area" class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-sm text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
                        <button id="select-files" class="mt-3 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>é¸æ“‡æª”æ¡ˆ
                        </button>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-blue-700">ä¸Šå‚³ä¸­...</span>
                                    <span id="upload-percent" class="text-sm font-medium text-blue-700">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="upload-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uploaded Files List -->
                    <div id="uploaded-files" class="mt-4">
                        <h4 class="font-medium text-gray-800 mb-2">å·²ä¸Šå‚³çš„æª”æ¡ˆ</h4>
                        <div id="files-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-between pt-4 border-t border-gray-200">
                    <button onclick="deleteProject()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>åˆªé™¤å°ˆæ¡ˆ
                    </button>
                    <div class="space-x-3">
                        <button id="export-project" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>åŒ¯å‡ºå°ˆæ¡ˆè³‡æ–™
                        </button>
                        <button id="close-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Project Modal -->
    <!-- Field Configuration Modal -->
    <div id="field-config-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-3xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-cog mr-2"></i>è¨­å®šå°ˆæ¡ˆå¡ç‰‡é¡¯ç¤ºæ¬„ä½</h3>

            <!-- å¿«é€Ÿé è¨­æ¨¡å¼ -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-700 mb-3">å¿«é€Ÿå¥—ç”¨é è¨­æ¨¡å¼ï¼š</h4>
                <div class="flex space-x-3">
                    <button onclick="applyFieldPreset('minimal')" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200">
                        ç°¡æ½”æ¨¡å¼
                    </button>
                    <button onclick="applyFieldPreset('standard')" class="px-4 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200">
                        æ¨™æº–æ¨¡å¼ï¼ˆç•¶å‰ï¼‰
                    </button>
                    <button onclick="applyFieldPreset('detailed')" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200">
                        è©³ç´°æ¨¡å¼
                    </button>
                </div>
            </div>

            <!-- è‡ªå®šç¾©æ¬„ä½é¸æ“‡ -->
            <div class="space-y-3">
                <h4 class="font-semibold text-gray-700 mb-3">è‡ªå®šç¾©é¡¯ç¤ºæ¬„ä½ï¼š</h4>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-name" checked disabled class="mr-3 h-4 w-4">
                        <div>
                            <span class="font-medium">å°ˆæ¡ˆåç¨±</span>
                            <span class="text-xs text-gray-500 block">ï¼ˆå¿…å¡«ï¼Œç„¡æ³•å–æ¶ˆï¼‰</span>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-department" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">è² è²¬éƒ¨é–€</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-startTime" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">é–‹å§‹æ™‚é–“</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-dueDate" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">æˆªæ­¢æ—¥æœŸ</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-priority" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">å„ªå…ˆç´š</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-progress" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">é€²åº¦</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-status" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">ç‹€æ…‹</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-comments" class="mr-3 h-4 w-4">
                        <span class="font-medium">è©•è«–æ•¸é‡</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeFieldConfigModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="saveFieldConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å¥—ç”¨è¨­å®š</button>
            </div>
        </div>
    </div>

    <div id="add-project-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢ AI å°ˆæ¡ˆ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                    <input id="new-project-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è² è²¬éƒ¨é–€</label>
                    <input id="new-project-department" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                    <input id="new-project-start" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é è¨ˆå®Œæˆ</label>
                    <input id="new-project-due" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆç´š</label>
                    <select id="new-project-priority" class="w-full px-3 py-2 border rounded-lg">
                        <option value="é«˜">é«˜</option>
                        <option value="ä¸­">ä¸­</option>
                        <option value="ä½">ä½</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                    <select id="new-project-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="æ§‹æ€ä¸­">æ§‹æ€ä¸­</option>
                        <option value="è¦åŠƒä¸­">è¦åŠƒä¸­</option>
                        <option value="é–‹ç™¼ä¸­">é–‹ç™¼ä¸­</option>
                        <option value="æ¸¬è©¦ä¸­">æ¸¬è©¦ä¸­</option>
                        <option value="å·²çµ‚æ­¢">å·²çµ‚æ­¢</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®Œæˆé€²åº¦</label>
                    <div class="flex items-center space-x-4">
                        <input id="new-project-progress" type="range" min="0" max="100" value="0"
                               class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                               oninput="document.getElementById('new-project-progress-value').textContent = this.value + '%'">
                        <span id="new-project-progress-value" class="text-lg font-semibold text-blue-600 w-16 text-right">0%</span>
                    </div>
                    <div class="mt-1 text-xs text-gray-500">æ‹–å‹•æ»‘æ¡¿è¨­å®šå°ˆæ¡ˆå®Œæˆé€²åº¦ï¼ˆ0-100%ï¼‰</div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddProjectModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="addNewProject()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢å°ˆæ¡ˆ</button>
            </div>
        </div>
    </div>

    <!-- Add Sharing Session Modal -->
    <div id="add-sharing-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢åˆ†äº«æœƒ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†äº«æœƒæ—¥æœŸ</label>
                    <input id="new-sharing-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»é¡Œ</label>
                    <input id="new-sharing-theme" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¬›è€…</label>
                    <input id="new-sharing-speaker" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è­°ç¨‹å®‰æ’ï¼ˆæ¯è¡Œä¸€é …ï¼‰</label>
                    <textarea id="new-sharing-schedule" rows="5" class="w-full px-3 py-2 border rounded-lg"
                              placeholder="16:00-16:05 é–‹å ´èˆ‡ä»‹ç´¹
16:05-16:30 ä¸»é¡Œåˆ†äº«
16:30-16:45 Q&A èˆ‡äº¤æµ"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œæ–‡ä»¶</h4>
                    <div id="sharing-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="sharing-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="sharing-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddSharingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="addNewSharing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢åˆ†äº«æœƒ</button>
            </div>
        </div>
    </div>

    <!-- Edit Sharing Session Modal -->
    <div id="edit-sharing-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ç·¨è¼¯åˆ†äº«æœƒ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†äº«æœƒæ—¥æœŸ</label>
                    <input id="edit-sharing-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»é¡Œ</label>
                    <input id="edit-sharing-theme" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¬›è€…</label>
                    <input id="edit-sharing-speaker" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                    <select id="edit-sharing-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="upcoming">å³å°‡èˆ‰è¡Œ</option>
                        <option value="past">éå¾€ç´€éŒ„</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è­°ç¨‹å®‰æ’ï¼ˆæ¯è¡Œä¸€é …ï¼‰</label>
                    <textarea id="edit-sharing-schedule" rows="5" class="w-full px-3 py-2 border rounded-lg"
                              placeholder="16:00-16:05 é–‹å ´èˆ‡ä»‹ç´¹
16:05-16:30 ä¸»é¡Œåˆ†äº«
16:30-16:45 Q&A èˆ‡äº¤æµ"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œæ–‡ä»¶</h4>
                    <div id="edit-sharing-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="edit-sharing-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="edit-sharing-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditSharingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="saveEditSharing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢æ´»å‹•åƒèˆ‡</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•åç¨±</label>
                    <input id="new-event-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•æ—¥æœŸ</label>
                    <input id="new-event-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•é¡å‹</label>
                    <select id="new-event-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="external">å¤–éƒ¨æ´»å‹•</option>
                        <option value="internal">å…§éƒ¨æ´»å‹•</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•æ¦‚è¿°</label>
                    <textarea id="new-event-summary" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»è¦å­¸ç¿’èˆ‡æ”¶ç©«ï¼ˆæ¯è¡Œä¸€é …ï¼‰</label>
                    <textarea id="new-event-learnings" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œæ–‡ä»¶</h4>
                    <div id="event-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="event-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="event-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddEventModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="addNewEvent()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢æ´»å‹•</button>
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="edit-event-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ç·¨è¼¯æ´»å‹•åƒèˆ‡</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•åç¨±</label>
                    <input id="edit-event-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•æ—¥æœŸ</label>
                    <input id="edit-event-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•é¡å‹</label>
                    <select id="edit-event-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="external">å¤–éƒ¨æ´»å‹•</option>
                        <option value="internal">å…§éƒ¨æ´»å‹•</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•æ¦‚è¿°</label>
                    <textarea id="edit-event-summary" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»è¦å­¸ç¿’èˆ‡æ”¶ç©«ï¼ˆæ¯è¡Œä¸€é …ï¼‰</label>
                    <textarea id="edit-event-learnings" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œæ–‡ä»¶</h4>
                    <div id="edit-event-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="edit-event-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="edit-event-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditEventModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="saveEditEvent()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢ä¼æ¥­æ¥æ´½</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¼æ¥­åç¨±</label>
                    <input id="new-contact-company" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡äºº</label>
                    <input id="new-contact-person" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¥æ´½æ—¥æœŸ</label>
                    <input id="new-contact-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´½è«‡ä¸»é¡Œ</label>
                    <textarea id="new-contact-topic" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œæ–‡ä»¶</h4>
                    <div id="contact-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="contact-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="contact-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddContactModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="addNewContact()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢æ¥æ´½</button>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div id="edit-contact-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ç·¨è¼¯ä¼æ¥­æ¥æ´½</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¼æ¥­åç¨±</label>
                    <input id="edit-contact-company" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡äºº</label>
                    <input id="edit-contact-person" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¥æ´½æ—¥æœŸ</label>
                    <input id="edit-contact-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ´½è«‡ä¸»é¡Œ</label>
                    <textarea id="edit-contact-topic" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œæ–‡ä»¶</h4>
                    <div id="edit-contact-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PDFã€Wordã€Excelã€åœ–ç‰‡ç­‰æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                        <input type="file" id="edit-contact-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="edit-contact-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditContactModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="saveEditContact()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <!-- Add Routine Task Modal -->
    <div id="add-routine-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢ä¾‹è¡Œä»»å‹™</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»å‹™é¡å‹</label>
                    <select id="new-routine-type" class="w-full px-3 py-2 border rounded-lg" onchange="updateRoutineFields()">
                        <option value="daily">æ¯æ—¥ä»»å‹™ (é€±ä¸€è‡³é€±äº”ï¼Œæ’é™¤åœ‹å®šå‡æ—¥)</option>
                        <option value="custom">è‡ªå®šç¾©é€±æœŸ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»å‹™åç¨±</label>
                    <input id="new-routine-task" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div id="routine-time-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">åŸ·è¡Œæ™‚é–“</label>
                    <input id="new-routine-time" type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="ä¾‹ï¼š8:00~8:15">
                </div>
                <div id="routine-day-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¯æœˆåŸ·è¡Œæ—¥ï¼ˆå¯é¸ï¼‰</label>
                    <input id="new-routine-day" type="number" min="1" max="31" class="w-full px-3 py-2 border rounded-lg" placeholder="å›ºå®šæ—¥æœŸè«‹å¡«å¯«ï¼Œå¦‚15">
                    <p class="text-xs text-gray-500 mt-1">âš ï¸ å¦‚æ¯æœˆæ—¥æœŸä¸å›ºå®šï¼ˆå¦‚é›»è…¦å·¡æª¢ï¼‰ï¼Œè«‹ç•™ç©ºæ­¤æ¬„ä½ï¼Œä¹‹å¾Œå¯ç‚ºæ¯å€‹æœˆå–®ç¨è¨­å®šæ—¥æœŸ</p>
                </div>
                <div id="routine-last-date-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šæ¬¡åŸ·è¡Œæ—¥æœŸ</label>
                    <input id="new-routine-last-date" type="date" class="w-full px-3 py-2 border rounded-lg" onchange="calculateNextDate()">
                </div>
                <div id="routine-next-date-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸‹æ¬¡åŸ·è¡Œæ—¥æœŸ</label>
                    <input id="new-routine-next-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                    <p id="next-date-hint" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <div id="routine-weekdays-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŸ·è¡Œæ—¥ï¼ˆå¯å¤šé¸ï¼‰</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="1" class="routine-weekday-checkbox">
                            <span>é€±ä¸€</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="2" class="routine-weekday-checkbox">
                            <span>é€±äºŒ</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="3" class="routine-weekday-checkbox">
                            <span>é€±ä¸‰</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="4" class="routine-weekday-checkbox">
                            <span>é€±å››</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="5" class="routine-weekday-checkbox">
                            <span>é€±äº”</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="6" class="routine-weekday-checkbox">
                            <span>é€±å…­</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="0" class="routine-weekday-checkbox">
                            <span>é€±æ—¥</span>
                        </label>
                    </div>
                </div>
                <div id="routine-quarterly-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å­£åº¦åŸ·è¡Œæœˆä»½èˆ‡æ—¥æœŸ</label>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="new-routine-quarter-month" class="w-full px-3 py-2 border rounded-lg">
                            <option value="1">æ¯å­£ç¬¬ä¸€å€‹æœˆ</option>
                            <option value="2">æ¯å­£ç¬¬äºŒå€‹æœˆ</option>
                            <option value="3">æ¯å­£ç¬¬ä¸‰å€‹æœˆ</option>
                        </select>
                        <input id="new-routine-quarter-day" type="number" min="1" max="31" placeholder="æ—¥æœŸ" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ä¾‹å¦‚ï¼šç¬¬ä¸€å€‹æœˆ + 15æ—¥ = 1/15ã€4/15ã€7/15ã€10/15</p>
                </div>
                <div id="routine-custom-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿè¨­å®šï¼ˆé è¨­é¸é …ï¼‰</label>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button type="button" onclick="applyPreset('weekly')" class="px-3 py-2 bg-blue-50 text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors">
                            <i class="fas fa-calendar-week mr-1"></i>æ¯é€±
                        </button>
                        <button type="button" onclick="applyPreset('monthly')" class="px-3 py-2 bg-purple-50 text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-100 transition-colors">
                            <i class="fas fa-calendar-alt mr-1"></i>æ¯æœˆ
                        </button>
                        <button type="button" onclick="applyPreset('quarterly')" class="px-3 py-2 bg-teal-50 text-teal-700 border border-teal-300 rounded-lg hover:bg-teal-100 transition-colors">
                            <i class="fas fa-calendar mr-1"></i>æ¯å­£
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå®šç¾©é€±æœŸ</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">æ¯</span>
                            <input id="new-routine-custom-interval" type="number" min="1" placeholder="æ•¸é‡" class="flex-1 px-3 py-2 border rounded-lg" oninput="calculateCustomNextDate()">
                        </div>
                        <select id="new-routine-custom-unit" class="w-full px-3 py-2 border rounded-lg" onchange="calculateCustomNextDate()">
                            <option value="days">å¤©</option>
                            <option value="weeks">é€±</option>
                            <option value="months">æœˆ</option>
                        </select>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input id="new-routine-custom-start" type="date" class="w-full px-3 py-2 border rounded-lg" onchange="calculateCustomNextDate()">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ğŸ’¡ æç¤ºï¼šé»æ“Šå¿«é€Ÿè¨­å®šæŒ‰éˆ•ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥æ•¸å€¼ã€‚ä¾‹å¦‚ï¼šæ¯ 2 é€±ã€æ¯ 3 æœˆ</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddRoutineModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="addNewRoutine()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢ä»»å‹™</button>
            </div>
        </div>
    </div>

    <!-- Routine Task Date Setting Modal -->
    <div id="routine-date-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">è¨­å®šä¾‹è¡Œä»»å‹™æ—¥æœŸ</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ä»»å‹™åç¨±</label>
                <input id="routine-task-name" type="text" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡æ—¥æœŸ</label>
                <input id="routine-task-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeRoutineModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="saveRoutineDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ===== ä¸»é¡Œåˆ‡æ›ç³»çµ± =====
        function initTheme() {
            // å¾ localStorage è®€å–ä¸»é¡Œåå¥½ï¼Œé è¨­ç‚ºæ·ºè‰²ä¸»é¡Œ
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                updateThemeButton(true);
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeButton(isDark);
            console.log('ä¸»é¡Œå·²åˆ‡æ›:', isDark ? 'æ·±è‰²' : 'æ·ºè‰²');
        }

        function updateThemeButton(isDark) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (isDark) {
                icon.className = 'fas fa-sun';
                text.textContent = 'æ·ºè‰²';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = 'æ·±è‰²';
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ä¸»é¡Œ
        initTheme();

        // ===== æ¬Šé™ç³»çµ± (URL åƒæ•¸æ³•) =====
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'manager'; // é è¨­ç‚ºå°ˆæ¡ˆç®¡ç†å¸«
        const isReadOnly = userRole === 'supervisor'; // ä¸»ç®¡ç‚ºå”¯è®€æ¨¡å¼

        console.log('ä½¿ç”¨è€…è§’è‰²:', userRole, '| å”¯è®€æ¨¡å¼:', isReadOnly);

        // Firebase åˆå§‹åŒ– - ä½¿ç”¨å…§å»ºé…ç½®
        let database, storage;
        let isFirebaseInitialized = false;

        function initFirebase() {
            try {
                // æª¢æŸ¥ Firebase æ˜¯å¦å¯ç”¨
                if (typeof firebase === 'undefined') {
                    console.error('âŒ Firebase åº«æœªè¼‰å…¥');
                    updateSyncStatus('é›¢ç·šæ¨¡å¼', false);
                    // ä½¿ç”¨æœ¬åœ°è³‡æ–™æ¸²æŸ“æ‰€æœ‰å„€è¡¨æ¿
                    setTimeout(() => {
                        renderAllDashboards();
                    }, 100);
                    return false;
                }

                // å…§å»º Firebase é…ç½®
                const firebaseConfig = {
                    apiKey: "AIzaSyBlOglfZtVNC3wkH8FzxPRWpZjbioOisKA",
                    authDomain: "project-update-ab874.firebaseapp.com",
                    databaseURL: "https://project-update-ab874-default-rtdb.firebaseio.com",
                    projectId: "project-update-ab874",
                    storageBucket: "project-update-ab874.firebasestorage.app",
                    messagingSenderId: "auto",
                    appId: "auto"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                storage = firebase.storage();
                isFirebaseInitialized = true;

                updateSyncStatus('é›²ç«¯å·²é€£ç·š', true);
                console.log('âœ… Firebase å·²è‡ªå‹•é€£ç·š');

                // è¼‰å…¥æ‰€æœ‰è³‡æ–™
                loadAllDataFromFirebase();

                return true;
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                updateSyncStatus('é›¢ç·šæ¨¡å¼', false);
                isFirebaseInitialized = false;

                // å³ä½¿ Firebase å¤±æ•—ï¼Œä¹Ÿè¦æ¸²æŸ“å„€è¡¨æ¿è®“ç”¨æˆ¶å¯ä»¥ä½¿ç”¨
                setTimeout(() => {
                    renderAllDashboards();
                }, 100);

                return false;
            }
        }
        
        
        function updateSyncStatus(text, success = true) {
            const statusEl = document.getElementById('sync-status');
            if (!statusEl) return;

            if (success) {
                statusEl.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i><span class="text-sm text-green-600">${text}</span>`;
            } else {
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i><span class="text-sm text-yellow-600">${text}</span>`;
            }
        }

        // ===== æ¬Šé™ç³»çµ± - å¥—ç”¨æ¬Šé™é™åˆ¶ =====
        function applyPermissions() {
            if (!isReadOnly) {
                console.log('å°ˆæ¡ˆç®¡ç†å¸«æ¨¡å¼ - æ‰€æœ‰åŠŸèƒ½å¯ç”¨');
                return; // ç®¡ç†å¸«ä¸é™åˆ¶
            }

            console.log('å¥—ç”¨ä¸»ç®¡æª¢è¦–æ¨¡å¼æ¬Šé™');

            // 1. éš±è—æ‰€æœ‰ã€Œæ–°å¢ã€æŒ‰éˆ•
            const addButtons = [
                'button[onclick="showAddProjectModal()"]',
                'button[onclick="showAddRoutineModal()"]',
                'button[onclick="showAddSharingModal()"]',
                'button[onclick="showAddEventModal()"]',
                'button[onclick="showAddContactModal()"]'
            ];

            addButtons.forEach(selector => {
                const btn = document.querySelector(selector);
                if (btn) {
                    btn.style.display = 'none';
                    console.log('éš±è—æ–°å¢æŒ‰éˆ•:', selector);
                }
            });

            // 2. éš±è—ã€Œç·¨è¼¯å°ˆæ¡ˆè³‡è¨Šã€æŒ‰éˆ•
            const editToggle = document.getElementById('toggle-edit-mode');
            if (editToggle) {
                editToggle.style.display = 'none';
            }

            // 3. éš±è—æ‰€æœ‰ã€Œåˆªé™¤ã€æŒ‰éˆ•
            setTimeout(() => {
                document.querySelectorAll('button[onclick*="delete"]').forEach(btn => {
                    if (!btn.classList.contains('comment-delete')) { // ä¿ç•™è©•è«–åˆªé™¤æŒ‰éˆ•
                        btn.style.display = 'none';
                    }
                });
            }, 500);

            // 4. ç¦ç”¨é€²åº¦èªªæ˜ç·¨è¼¯
            const notesField = document.getElementById('project-notes');
            if (notesField) {
                notesField.disabled = true;
                notesField.style.backgroundColor = '#f3f4f6';
                notesField.style.cursor = 'not-allowed';
            }

            // 5. éš±è—ã€Œå„²å­˜èªªæ˜ã€æŒ‰éˆ•
            const saveNotesBtn = document.getElementById('save-notes');
            if (saveNotesBtn) {
                saveNotesBtn.style.display = 'none';
            }

            // 6. éš±è—ã€Œç·¨è¼¯ã€æŒ‰éˆ•ï¼ˆåˆ†äº«æœƒã€æ´»å‹•ã€æ¥æ´½ä¼æ¥­ï¼‰
            setTimeout(() => {
                document.querySelectorAll('button[onclick*="edit"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }, 500);

            // 7. åœ¨é é¢é ‚éƒ¨é¡¯ç¤ºè§’è‰²æ¨™è­˜
            const container = document.querySelector('.max-w-7xl');
            if (container && !document.getElementById('role-indicator')) {
                const roleIndicator = document.createElement('div');
                roleIndicator.id = 'role-indicator';
                roleIndicator.className = 'bg-blue-100 border border-blue-300 text-blue-800 px-4 py-2 rounded-lg mb-4 text-center font-semibold';
                roleIndicator.innerHTML = '<i class="fas fa-eye mr-2"></i>æª¢è¦–æ¨¡å¼ï¼šä¸»ç®¡ - æ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è³‡è¨Šä¸¦åœ¨å°ˆæ¡ˆä¸­ç•™è¨€';
                container.insertBefore(roleIndicator, container.firstChild);
            }
        }

        // å…¨åŸŸè®Šæ•¸
        let calendarDate = new Date();
        let currentProjectId = null;
        let currentRoutineTask = null;
        let currentSharingId = null;
        let currentEventId = null;
        let currentContactId = null;
        let editMode = false;
        let isDataLoading = false;  // å…¨åŸŸè¼‰å…¥ç‹€æ…‹æ¨™è¨˜
        let isProjectsLoading = false;  // å°ˆæ¡ˆè³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
        let projectIdCounter = 100000;  // ID ç”Ÿæˆå™¨ï¼Œå¾ 100000 é–‹å§‹é¿å…èˆ‡å›ºå®š ID è¡çª

        // è³‡æ–™é™£åˆ—ï¼ˆå¾ Firebase è¼‰å…¥ï¼Œåˆå§‹ç‚ºç©ºï¼‰
        let projects = [];
        let routineTasks = {
            daily: [],
            custom: [],  // è‡ªå®šç¾©é€±æœŸä»»å‹™ï¼ˆåŒ…å«é è¨­çš„æ¯é€±ã€æ¯æœˆã€æ¯å­£ç­‰ï¼‰
            // èˆŠçš„ä»»å‹™é¡å‹ä¿ç•™ä»¥ä¾¿å‘å¾Œå…¼å®¹ï¼ˆå¾ Firebase è¼‰å…¥èˆŠè³‡æ–™ï¼‰
            threeWeeks: [],
            monthly: [],
            bimonthly: [],
            weekly: [],
            quarterly: []
        };
        let sharingSessions = [];
        let eventsAttended = [];
        let businessContacts = [];

        // ===== å°ç£åœ‹å®šå‡æ—¥è³‡æ–™åº« (2025-2026) =====
        const taiwanHolidays = {
            '2025': [
                { date: '2025-01-01', name: 'ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥' },
                { date: '2025-01-27', name: 'è¾²æ›†é™¤å¤•å‰ä¸€æ—¥' },
                { date: '2025-01-28', name: 'è¾²æ›†é™¤å¤•' },
                { date: '2025-01-29', name: 'æ˜¥ç¯€' },
                { date: '2025-01-30', name: 'æ˜¥ç¯€' },
                { date: '2025-01-31', name: 'æ˜¥ç¯€' },
                { date: '2025-02-01', name: 'æ˜¥ç¯€' },
                { date: '2025-02-28', name: 'å’Œå¹³ç´€å¿µæ—¥' },
                { date: '2025-04-03', name: 'å…’ç«¥ç¯€' },
                { date: '2025-04-04', name: 'æ¸…æ˜ç¯€' },
                { date: '2025-05-31', name: 'ç«¯åˆç¯€' },
                { date: '2025-10-06', name: 'ä¸­ç§‹ç¯€' },
                { date: '2025-10-10', name: 'åœ‹æ…¶æ—¥' }
            ],
            '2026': [
                { date: '2026-01-01', name: 'ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥' },
                { date: '2026-02-16', name: 'è¾²æ›†é™¤å¤•å‰ä¸€æ—¥' },
                { date: '2026-02-17', name: 'è¾²æ›†é™¤å¤•' },
                { date: '2026-02-18', name: 'æ˜¥ç¯€' },
                { date: '2026-02-19', name: 'æ˜¥ç¯€' },
                { date: '2026-02-20', name: 'æ˜¥ç¯€' },
                { date: '2026-02-21', name: 'æ˜¥ç¯€' },
                { date: '2026-02-28', name: 'å’Œå¹³ç´€å¿µæ—¥' },
                { date: '2026-04-03', name: 'å…’ç«¥ç¯€' },
                { date: '2026-04-04', name: 'æ¸…æ˜ç¯€' },
                { date: '2026-06-19', name: 'ç«¯åˆç¯€' },
                { date: '2026-09-25', name: 'ä¸­ç§‹ç¯€' },
                { date: '2026-10-10', name: 'åœ‹æ…¶æ—¥' }
            ]
        };

        // æª¢æŸ¥æ˜¯å¦ç‚ºå°ç£åœ‹å®šå‡æ—¥
        function isTaiwanHoliday(date) {
            const year = date.getFullYear().toString();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            if (taiwanHolidays[year]) {
                const holiday = taiwanHolidays[year].find(h => h.date === dateStr);
                return holiday ? holiday.name : null;
            }
            return null;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«æˆ–åœ‹å®šå‡æ—¥
        function isWeekendOrHoliday(date) {
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const holiday = isTaiwanHoliday(date);

            return {
                isOff: isWeekend || holiday !== null,
                reason: holiday || (isWeekend ? 'é€±æœ«' : null)
            };
        }

        // å…¨åŸŸéŒ¯èª¤è™•ç†ï¼ˆåƒ…è¨˜éŒ„ï¼Œä¸å½±éŸ¿ UIï¼‰
        window.addEventListener('error', (e) => {
            console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
            // ç§»é™¤è‡ªå‹•é¡¯ç¤ºéŒ¯èª¤ï¼Œé¿å…å¹²æ“¾ Firebase ç‹€æ…‹é¡¯ç¤º
        });

        // æª¢æŸ¥è³‡æºåŠ è¼‰
        window.addEventListener('load', () => {
            console.log('é é¢å·²å®Œå…¨åŠ è¼‰');
            if (!window.firebase) {
                console.warn('Firebase SDK æœªåŠ è¼‰ï¼Œéƒ¨åˆ†åŠŸèƒ½å°‡ä¸å¯ç”¨');
                if (document.getElementById('sync-status')) {
                    updateSyncStatus('é›¢ç·šæ¨¡å¼ (Firebase æœªåŠ è¼‰)', false);
                }
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadFieldConfig();  // è¼‰å…¥æ¬„ä½é…ç½®
                initFirebase();  // Firebase è¼‰å…¥å®Œæˆå¾Œæœƒè‡ªå‹•èª¿ç”¨å„ render å‡½æ•¸
                setupEventListeners();
                // âš ï¸ ä¸åœ¨é€™è£¡èª¿ç”¨ renderAllDashboards()ï¼Œå› ç‚º Firebase è³‡æ–™å°šæœªè¼‰å…¥
                // å„å„€è¡¨æ¿æœƒåœ¨ Firebase è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æ¸²æŸ“

                // å»¶é²åŸ·è¡Œæ¬Šé™å¥—ç”¨ä»¥ç¢ºä¿ DOM å®Œå…¨è¼‰å…¥
                setTimeout(() => {
                    applyPermissions();
                }, 100);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                updateSyncStatus('åˆå§‹åŒ–å¤±æ•—', false);
            }
        });

        function setupEventListeners() {
            // Tab åˆ‡æ›
            const tabs = document.querySelectorAll('.dashboard-tab');
            const contents = document.querySelectorAll('.dashboard-content');
            tabs.forEach(tab => tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.remove('hidden');
            }));

            // Modal äº‹ä»¶
            setupModalEvents();
        }

        function renderAllDashboards() {
            renderAiDashboard();
            renderRoutineDashboard();
            renderSharingDashboard();
            renderEventsDashboard();
            renderContactsDashboard();
        }

        // === è¼”åŠ©å‡½å¼ ===
        function generateUniqueId() {
            // ä½¿ç”¨éå¢è¨ˆæ•¸å™¨ + éš¨æ©Ÿæ•¸ç¢ºä¿å”¯ä¸€æ€§
            return projectIdCounter++;
        }

        function findProjectById(projectId) {
            // å®‰å…¨æŸ¥æ‰¾å°ˆæ¡ˆï¼ŒåŒ…å«éŒ¯èª¤è™•ç†
            if (!projectId) {
                console.warn('å°ˆæ¡ˆ ID ç‚ºç©º');
                return null;
            }
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.warn('æ‰¾ä¸åˆ°å°ˆæ¡ˆ ID:', projectId, '| ç•¶å‰å°ˆæ¡ˆæ•¸:', projects.length);
            }
            return project;
        }

        // === Firebase åŒæ­¥å‡½æ•¸ ===
        function loadAllDataFromFirebase() {
            if (!isFirebaseInitialized) return;

            isDataLoading = true;  // è¨­å®šå…¨åŸŸè¼‰å…¥ä¸­ç‹€æ…‹
            isProjectsLoading = true;  // è¨­å®šå°ˆæ¡ˆè¼‰å…¥ä¸­ç‹€æ…‹
            console.log('ğŸ“¡ é–‹å§‹å¾ Firebase è¼‰å…¥è³‡æ–™...');

            // è¨­ç½®è¶…æ™‚è™•ç† - 10ç§’å¾Œå¦‚æœé‚„æ²’è¼‰å…¥å®Œæˆï¼Œå°±ä½¿ç”¨æœ¬åœ°è³‡æ–™
            const loadTimeout = setTimeout(() => {
                if (isDataLoading) {
                    console.warn('âš ï¸ Firebase è¼‰å…¥è¶…æ™‚ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                    isDataLoading = false;
                    isProjectsLoading = false;
                    updateSyncStatus('é›¢ç·šæ¨¡å¼', false);

                    // æ¸²æŸ“æ‰€æœ‰å„€è¡¨æ¿ï¼ˆä½¿ç”¨ç©ºè³‡æ–™æˆ–æœ¬åœ°è³‡æ–™ï¼‰
                    renderAiDashboard();
                    renderRoutineDashboard();
                    renderSharingDashboard();
                    renderEventsDashboard();
                    renderContactsDashboard();
                }
            }, 10000);

            // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
            database.ref('projects').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    projects = Object.values(data).sort((a, b) => a.id - b.id);
                    console.log('âœ… è¼‰å…¥å°ˆæ¡ˆè³‡æ–™:', projects.length, 'å€‹å°ˆæ¡ˆ');
                } else {
                    // Firebase è³‡æ–™åº«ç‚ºç©ºï¼Œä¿æŒç©ºé™£åˆ—
                    console.log('ğŸ“ Firebase è³‡æ–™åº«ç‚ºç©ºï¼Œå¯ä»¥é–‹å§‹æ–°å¢å°ˆæ¡ˆ');
                }
                renderAiDashboard();
                isProjectsLoading = false;  // å°ˆæ¡ˆè¼‰å…¥å®Œæˆï¼Œç«‹å³å…è¨±äº’å‹•
                console.log('âœ… å°ˆæ¡ˆè³‡æ–™è¼‰å…¥å®Œæˆï¼Œå¯ä»¥é–‹å§‹äº’å‹•');
            }).catch(err => {
                console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', err);
                isProjectsLoading = false;  // å³ä½¿å¤±æ•—ä¹Ÿè¦æ¸…é™¤å°ˆæ¡ˆè¼‰å…¥ç‹€æ…‹
            });

            // è¼‰å…¥ä¾‹è¡Œä»»å‹™
            database.ref('routineTasks').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    routineTasks = data;
                    console.log('âœ… è¼‰å…¥ä¾‹è¡Œä»»å‹™');
                } else {
                    console.log('ğŸ“ ä¾‹è¡Œä»»å‹™è³‡æ–™åº«ç‚ºç©ºï¼Œå¯ä»¥é–‹å§‹æ–°å¢ä»»å‹™');
                }
                renderRoutineDashboard();
            }).catch(err => console.error('è¼‰å…¥ä¾‹è¡Œä»»å‹™å¤±æ•—:', err));

            // è¼‰å…¥åˆ†äº«æœƒ
            database.ref('sharingSessions').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    sharingSessions = Object.values(data);
                    console.log('âœ… è¼‰å…¥åˆ†äº«æœƒ:', sharingSessions.length, 'å ´');
                } else {
                    console.log('ğŸ“ åˆ†äº«æœƒè³‡æ–™åº«ç‚ºç©ºï¼Œå¯ä»¥é–‹å§‹æ–°å¢åˆ†äº«æœƒ');
                }
                renderSharingDashboard();
            }).catch(err => console.error('è¼‰å…¥åˆ†äº«æœƒå¤±æ•—:', err));

            // è¼‰å…¥æ´»å‹•
            database.ref('events').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    eventsAttended = Object.values(data);
                    console.log('âœ… è¼‰å…¥æ´»å‹•:', eventsAttended.length, 'å€‹æ´»å‹•');
                } else {
                    console.log('ğŸ“ æ´»å‹•è³‡æ–™åº«ç‚ºç©ºï¼Œå¯ä»¥é–‹å§‹æ–°å¢æ´»å‹•');
                }
                renderEventsDashboard();
            }).catch(err => console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', err));

            // è¼‰å…¥ä¼æ¥­æ¥æ´½
            database.ref('contacts').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    businessContacts = Object.values(data);
                    console.log('âœ… è¼‰å…¥ä¼æ¥­æ¥æ´½:', businessContacts.length, 'ç­†');
                } else {
                    console.log('ğŸ“ ä¼æ¥­æ¥æ´½è³‡æ–™åº«ç‚ºç©ºï¼Œå¯ä»¥é–‹å§‹æ–°å¢è¯çµ¡äºº');
                }
                renderContactsDashboard();

                // æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆ
                clearTimeout(loadTimeout);  // æ¸…é™¤è¶…æ™‚å®šæ™‚å™¨
                isDataLoading = false;
                console.log('âœ… æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆ');
            }).catch(err => {
                console.error('è¼‰å…¥ä¼æ¥­æ¥æ´½å¤±æ•—:', err);
                clearTimeout(loadTimeout);  // æ¸…é™¤è¶…æ™‚å®šæ™‚å™¨
                isDataLoading = false;  // å³ä½¿å¤±æ•—ä¹Ÿè¦æ¸…é™¤è¼‰å…¥ç‹€æ…‹
            });
        }

        function syncToFirebase(path, data) {
            if (!isFirebaseInitialized) {
                console.error('âŒ Firebase æœªåˆå§‹åŒ–ï¼Œç„¡æ³•åŒæ­¥è³‡æ–™');
                alert('Firebase æœªåˆå§‹åŒ–ï¼Œè³‡æ–™ç„¡æ³•å„²å­˜ï¼');
                return Promise.reject('Firebase not initialized');
            }

            console.log('ğŸ”„ æ­£åœ¨åŒæ­¥è³‡æ–™åˆ° Firebase:', path);

            return database.ref(path).set(data)
                .then(() => {
                    console.log('âœ… è³‡æ–™åŒæ­¥æˆåŠŸ:', path);
                    updateSyncStatus('å·²åŒæ­¥', true);
                })
                .catch((error) => {
                    console.error('âŒ Firebase åŒæ­¥å¤±æ•—:', error);
                    console.error('è·¯å¾‘:', path);
                    console.error('éŒ¯èª¤ä»£ç¢¼:', error.code);
                    console.error('éŒ¯èª¤è¨Šæ¯:', error.message);

                    // é¡¯ç¤ºéŒ¯èª¤çµ¦ç”¨æˆ¶
                    if (error.code === 'PERMISSION_DENIED') {
                        alert('âš ï¸ Firebase æ¬Šé™ä¸è¶³ï¼\n\nè«‹æª¢æŸ¥ Firebase Realtime Database è¦å‰‡è¨­å®šã€‚\n\nè«‹å‰å¾€ Firebase Console â†’ Realtime Database â†’ è¦å‰‡ï¼Œç¢ºèªå…è¨±è®€å¯«ã€‚');
                    } else {
                        alert('è³‡æ–™å„²å­˜å¤±æ•—ï¼š' + error.message);
                    }

                    updateSyncStatus('åŒæ­¥å¤±æ•—', false);
                    throw error;
                });
        }

        // === 1. AI å°ˆæ¡ˆå„€è¡¨æ¿ ===
        function renderAiDashboard() {
            const board = document.getElementById('ai-kanban-board');
            const summaryContainer = document.getElementById('ai-summary-stats');
            const monthFilter = document.getElementById('month-filter');

            if (!board || !summaryContainer || !monthFilter) {
                console.error('AI Dashboard å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ projects å·²åˆå§‹åŒ–
            if (!projects || !Array.isArray(projects)) {
                console.warn('å°ˆæ¡ˆè³‡æ–™å°šæœªè¼‰å…¥');
                board.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">è³‡æ–™è¼‰å…¥ä¸­...</div>';
                summaryContainer.innerHTML = '';
                return;
            }

            // å¦‚æœè³‡æ–™ç‚ºç©ºï¼Œé¡¯ç¤ºå‹å–„æç¤º
            if (projects.length === 0) {
                console.log('ğŸ“ å°ˆæ¡ˆè³‡æ–™åº«ç‚ºç©º');
                board.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8 bg-blue-50 rounded-lg p-12"><i class="fas fa-folder-open text-6xl text-blue-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">å°šç„¡å°ˆæ¡ˆè³‡æ–™</p><p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢å°ˆæ¡ˆã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹å°ˆæ¡ˆ</p></div>';
                summaryContainer.innerHTML = '<div class="col-span-full text-center text-gray-400 text-sm">æ–°å¢å°ˆæ¡ˆå¾Œå°‡é¡¯ç¤ºçµ±è¨ˆè³‡æ–™</div>';
                monthFilter.innerHTML = '<option value="all">æ‰€æœ‰æœˆä»½</option>';
                return;
            }

            // å¡«å……æœˆä»½ç¯©é¸å™¨ï¼ˆå®‰å…¨è™•ç† startTimeï¼‰
            const months = [...new Set(
                projects
                    .filter(p => p.startTime && typeof p.startTime === 'string' && p.startTime.length >= 7)
                    .map(p => p.startTime.substring(0, 7))
            )].sort().reverse();

            monthFilter.innerHTML = '<option value="all">æ‰€æœ‰æœˆä»½</option>';
            months.forEach(m => {
                if (m !== 'unknow' && m !== 'unknown') {
                    monthFilter.innerHTML += `<option value="${m}">${m}</option>`;
                }
            });

            monthFilter.onchange = () => displayProjects();
            displayProjects();

            function displayProjects() {
                const selectedMonth = monthFilter.value;
                const filteredProjects = selectedMonth === 'all' ? projects : projects.filter(p => p.startTime.startsWith(selectedMonth));
                
                board.innerHTML = '';
                summaryContainer.innerHTML = '';

                const statuses = ["æ§‹æ€ä¸­", "è¦åŠƒä¸­", "é–‹ç™¼ä¸­", "æ¸¬è©¦ä¸­", "å·²çµ‚æ­¢", "å·²å®Œæˆ"];
                const priorityColors = { 'é«˜': 'bg-red-100 text-red-800', 'ä¸­': 'bg-yellow-100 text-yellow-800', 'ä½': 'bg-green-100 text-green-800' };
                const columnHeaderColors = {
                    "æ§‹æ€ä¸­": "bg-purple-400",
                    "è¦åŠƒä¸­": "bg-blue-400",
                    "é–‹ç™¼ä¸­": "bg-orange-400",
                    "æ¸¬è©¦ä¸­": "bg-teal-400",
                    "å·²çµ‚æ­¢": "bg-red-400",
                    "å·²å®Œæˆ": "bg-green-500"
                };

                statuses.forEach(status => {
                    const column = document.createElement('div');
                    column.className = 'bg-gray-100 rounded-lg flex flex-col h-full';
                    const projectsInStatus = filteredProjects.filter(p => p.status === status);
                    
                    column.innerHTML = `
                        <div class="p-4 rounded-t-lg ${columnHeaderColors[status]} text-white flex justify-between items-center">
                            <h2 class="font-bold text-lg">${status}</h2>
                            <span class="bg-white/30 text-white text-sm font-semibold rounded-full px-2 py-0.5">${projectsInStatus.length}</span>
                        </div>
                        <div class="kanban-column-content p-4 space-y-4 overflow-y-auto flex-grow" style="min-height: 400px;"></div>
                    `;
                    
                    projectsInStatus.forEach(project => {
                        const card = document.createElement('div');
                        const borderColor = { 'é«˜': 'border-red-500', 'ä¸­': 'border-yellow-500', 'ä½': 'border-green-500' }[project.priority] || 'border-gray-300';
                        card.className = `bg-white p-4 rounded-lg shadow-md border-l-4 ${borderColor} project-card`;

                        // æ ¹æ“šé…ç½®å‹•æ…‹æ§‹å»ºå¡ç‰‡å…§å®¹
                        let cardContent = `<h3 class="font-bold text-gray-800">${project.name}</h3>`;

                        // éƒ¨é–€
                        if (fieldConfig.department) {
                            cardContent += `<p class="text-sm text-gray-500 mt-1">${project.department}</p>`;
                        }

                        // æ™‚é–“
                        if (fieldConfig.startTime || fieldConfig.dueDate) {
                            cardContent += `<div class="text-xs text-gray-400 mt-2">`;
                            if (fieldConfig.startTime) cardContent += `<span>å§‹: ${project.startTime}</span>`;
                            if (fieldConfig.startTime && fieldConfig.dueDate) cardContent += ` | `;
                            if (fieldConfig.dueDate) cardContent += `<span>çµ‚: ${project.dueDate}</span>`;
                            cardContent += `</div>`;
                        }

                        // è©•è«–å’Œå„ªå…ˆç´š
                        if (fieldConfig.comments || fieldConfig.priority) {
                            cardContent += `<div class="flex justify-between items-center mt-2">`;

                            if (fieldConfig.comments) {
                                const commentCount = project.comments ? project.comments.length : 0;
                                if (commentCount > 0) {
                                    cardContent += `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full"><i class="fas fa-comment mr-1"></i>${commentCount}</span>`;
                                } else {
                                    cardContent += `<span></span>`; // ä½”ä½
                                }
                            }

                            if (fieldConfig.priority) {
                                cardContent += `<span class="text-xs font-semibold px-2 py-1 rounded-full ${priorityColors[project.priority]}">${project.priority}</span>`;
                            }

                            cardContent += `</div>`;
                        }

                        // é€²åº¦
                        if (fieldConfig.progress) {
                            cardContent += `
                                <div class="mt-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">é€²åº¦</span>
                                        <span class="text-sm font-medium text-gray-700">${project.progress}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${project.progress}%"></div>
                                    </div>
                                </div>
                            `;
                        }

                        card.innerHTML = cardContent;
                        card.addEventListener('click', () => openProjectModal(project));
                        column.querySelector('.kanban-column-content').appendChild(card);
                    });
                    
                    board.appendChild(column);
                });

                // çµ±è¨ˆè³‡æ–™ï¼ˆæ·»åŠ è©³ç´°é™¤éŒ¯æ—¥èªŒï¼‰
                console.log('ğŸ“Š å°ˆæ¡ˆçµ±è¨ˆé™¤éŒ¯ï¼š');
                console.log('æ‰€æœ‰å°ˆæ¡ˆ:', filteredProjects.map(p => ({ id: p.id, name: p.name, status: p.status })));

                const total = filteredProjects.length;
                const completed = filteredProjects.filter(p => p.status === 'å·²å®Œæˆ').length;
                const inProgress = filteredProjects.filter(p => ['é–‹ç™¼ä¸­', 'æ¸¬è©¦ä¸­'].includes(p.status)).length;
                const planning = filteredProjects.filter(p => ['æ§‹æ€ä¸­', 'è¦åŠƒä¸­'].includes(p.status)).length;
                const shutdown = filteredProjects.filter(p => ['å·²çµ‚æ­¢'].includes(p.status)).length;

                // æª¢æŸ¥æ˜¯å¦æœ‰æœªåˆ†é¡çš„å°ˆæ¡ˆ
                const categorized = completed + inProgress + planning + shutdown;
                const uncategorized = filteredProjects.filter(p =>
                    !['å·²å®Œæˆ', 'é–‹ç™¼ä¸­', 'æ¸¬è©¦ä¸­', 'æ§‹æ€ä¸­', 'è¦åŠƒä¸­', 'å·²çµ‚æ­¢'].includes(p.status)
                );

                if (uncategorized.length > 0) {
                    console.warn('âš ï¸ ç™¼ç¾æœªåˆ†é¡çš„å°ˆæ¡ˆ:', uncategorized.map(p => ({ id: p.id, name: p.name, status: p.status })));
                }

                console.log(`ç¸½è¨ˆ: ${total}, å·²å®Œæˆ: ${completed}, é€²è¡Œä¸­: ${inProgress}, è¦åŠƒä¸­: ${planning}, å·²çµ‚æ­¢: ${shutdown}`);
                console.log(`åˆ†é¡ç¸½å’Œ: ${categorized}, å·®ç•°: ${total - categorized}`);
                [
                    { label: 'ç¸½å°ˆæ¡ˆæ•¸', value: total, color: 'bg-blue-100 text-blue-800' },
                    { label: 'é€²è¡Œä¸­', value: inProgress, color: 'bg-orange-100 text-orange-800' },
                    { label: 'è¦åŠƒ/æ§‹æ€ä¸­', value: planning, color: 'bg-purple-100 text-purple-800' },
                    { label: 'å·²çµ‚æ­¢', value: shutdown, color: 'bg-red-100 text-red-800' },
                    { label: 'å·²å®Œæˆ', value: completed, color: 'bg-green-100 text-green-800' }
                ].forEach(stat => {
                    const statCard = document.createElement('div');
                    statCard.className = `p-4 rounded-lg shadow ${stat.color}`;
                    statCard.innerHTML = `
                        <div class="text-2xl font-bold">${stat.value}</div>
                        <div class="text-sm font-medium">${stat.label}</div>
                    `;
                    summaryContainer.appendChild(statCard);
                });
            }
        }

        // å°ˆæ¡ˆç›¸é—œå‡½æ•¸
        function showAddProjectModal() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProjectModal() {
            document.getElementById('add-project-modal').classList.remove('show');
        }

        function addNewProject() {
            const newProject = {
                id: generateUniqueId(),  // ä½¿ç”¨å¯é çš„ ID ç”Ÿæˆå™¨
                name: document.getElementById('new-project-name').value,
                department: document.getElementById('new-project-department').value,
                startTime: document.getElementById('new-project-start').value || 'unknown',
                dueDate: document.getElementById('new-project-due').value || 'unknown',
                priority: document.getElementById('new-project-priority').value,
                status: document.getElementById('new-project-status').value,
                progress: parseInt(document.getElementById('new-project-progress').value) || 0,
                notes: "",
                files: [],
                comments: []
            };

            if (!newProject.name || !newProject.department) {
                alert('è«‹å¡«å¯«å°ˆæ¡ˆåç¨±å’Œè² è²¬éƒ¨é–€');
                return;
            }

            console.log('ğŸ“ æº–å‚™æ–°å¢å°ˆæ¡ˆ:', newProject);

            // å…ˆæ·»åŠ åˆ°æœ¬åœ°é™£åˆ—
            projects.push(newProject);

            // åŒæ­¥åˆ° Firebase ä¸¦ç­‰å¾…çµæœ
            syncToFirebase('projects/' + newProject.id, newProject)
                .then(() => {
                    console.log('âœ… å°ˆæ¡ˆæ–°å¢æˆåŠŸ:', newProject.name);
                    alert('âœ… å°ˆæ¡ˆã€Œ' + newProject.name + 'ã€æ–°å¢æˆåŠŸï¼');
                    closeAddProjectModal();
                    renderAiDashboard();

                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('new-project-name').value = '';
                    document.getElementById('new-project-department').value = '';
                    document.getElementById('new-project-start').value = '';
                    document.getElementById('new-project-due').value = '';
                    document.getElementById('new-project-progress').value = '0';
                    document.getElementById('new-project-progress-value').textContent = '0%';
                })
                .catch((error) => {
                    // åŒæ­¥å¤±æ•—ï¼Œå¾æœ¬åœ°é™£åˆ—ç§»é™¤
                    const index = projects.findIndex(p => p.id === newProject.id);
                    if (index > -1) {
                        projects.splice(index, 1);
                    }
                    console.error('âŒ å°ˆæ¡ˆæ–°å¢å¤±æ•—ï¼Œå·²å›æ»¾æœ¬åœ°è³‡æ–™');
                    renderAiDashboard();
                });
        }

        function reloadProjects() {
            if (!isFirebaseInitialized) {
                alert('Firebase å°šæœªåˆå§‹åŒ–ï¼Œç„¡æ³•é‡æ–°è¼‰å…¥');
                console.error('âŒ Firebase æœªåˆå§‹åŒ–');
                return;
            }

            console.log('ğŸ”„ æ‰‹å‹•é‡æ–°è¼‰å…¥å°ˆæ¡ˆ...');
            isProjectsLoading = true;

            database.ref('projects').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    projects = Object.values(data).sort((a, b) => a.id - b.id);
                    console.log('âœ… é‡æ–°è¼‰å…¥æˆåŠŸ:', projects.length, 'å€‹å°ˆæ¡ˆ');
                    alert(`æˆåŠŸè¼‰å…¥ ${projects.length} å€‹å°ˆæ¡ˆ`);
                } else {
                    console.warn('âš ï¸ Firebase è³‡æ–™åº«ç‚ºç©º');
                    alert('è³‡æ–™åº«ä¸­æ²’æœ‰å°ˆæ¡ˆè³‡æ–™');
                }
                renderAiDashboard();
                isProjectsLoading = false;
            }).catch(err => {
                console.error('âŒ é‡æ–°è¼‰å…¥å¤±æ•—:', err);
                alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
                isProjectsLoading = false;
            });
        }

        // æ¬„ä½é…ç½®ç®¡ç†
        let fieldConfig = {
            name: true,       // å¿…å¡«ï¼Œç„¡æ³•å–æ¶ˆ
            department: true,
            startTime: true,
            dueDate: true,
            priority: true,
            progress: true,
            status: true,
            comments: false
        };

        function loadFieldConfig() {
            const saved = localStorage.getItem('projectFieldConfig');
            if (saved) {
                try {
                    fieldConfig = JSON.parse(saved);
                    console.log('âœ… è¼‰å…¥æ¬„ä½é…ç½®:', fieldConfig);
                } catch (e) {
                    console.error('è¼‰å…¥æ¬„ä½é…ç½®å¤±æ•—:', e);
                }
            }
        }

        function saveFieldConfig() {
            fieldConfig = {
                name: true, // å¿…å¡«
                department: document.getElementById('field-department').checked,
                startTime: document.getElementById('field-startTime').checked,
                dueDate: document.getElementById('field-dueDate').checked,
                priority: document.getElementById('field-priority').checked,
                progress: document.getElementById('field-progress').checked,
                status: document.getElementById('field-status').checked,
                comments: document.getElementById('field-comments').checked
            };

            localStorage.setItem('projectFieldConfig', JSON.stringify(fieldConfig));
            console.log('âœ… å„²å­˜æ¬„ä½é…ç½®:', fieldConfig);
            closeFieldConfigModal();
            renderAiDashboard();
            alert('æ¬„ä½é…ç½®å·²å¥—ç”¨');
        }

        function showFieldConfigModal() {
            // æ ¹æ“šç•¶å‰é…ç½®è¨­å®šå‹¾é¸æ¡†
            document.getElementById('field-department').checked = fieldConfig.department;
            document.getElementById('field-startTime').checked = fieldConfig.startTime;
            document.getElementById('field-dueDate').checked = fieldConfig.dueDate;
            document.getElementById('field-priority').checked = fieldConfig.priority;
            document.getElementById('field-progress').checked = fieldConfig.progress;
            document.getElementById('field-status').checked = fieldConfig.status;
            document.getElementById('field-comments').checked = fieldConfig.comments;

            document.getElementById('field-config-modal').classList.add('show');
        }

        function closeFieldConfigModal() {
            document.getElementById('field-config-modal').classList.remove('show');
        }

        function applyFieldPreset(preset) {
            const presets = {
                minimal: {
                    name: true,
                    department: false,
                    startTime: false,
                    dueDate: false,
                    priority: true,
                    progress: true,
                    status: true,
                    comments: false
                },
                standard: {
                    name: true,
                    department: true,
                    startTime: true,
                    dueDate: true,
                    priority: true,
                    progress: true,
                    status: true,
                    comments: false
                },
                detailed: {
                    name: true,
                    department: true,
                    startTime: true,
                    dueDate: true,
                    priority: true,
                    progress: true,
                    status: true,
                    comments: true
                }
            };

            const config = presets[preset];
            if (config) {
                document.getElementById('field-department').checked = config.department;
                document.getElementById('field-startTime').checked = config.startTime;
                document.getElementById('field-dueDate').checked = config.dueDate;
                document.getElementById('field-priority').checked = config.priority;
                document.getElementById('field-progress').checked = config.progress;
                document.getElementById('field-status').checked = config.status;
                document.getElementById('field-comments').checked = config.comments;

                console.log('âœ… å¥—ç”¨é è¨­æ¨¡å¼:', preset);
            }
        }

        function exportProjects() {
            const exportData = {
                exportDate: new Date().toISOString(),
                totalProjects: projects.length,
                projects: projects
            };

            // æä¾›é¸æ“‡ï¼šJSON æˆ– CSV
            const format = confirm('é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼š\n\nç¢ºå®š = JSON\nå–æ¶ˆ = CSV') ? 'json' : 'csv';

            if (format === 'json') {
                // JSON åŒ¯å‡º
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `projects_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('âœ… åŒ¯å‡º JSON å®Œæˆ');
            } else {
                // CSV åŒ¯å‡º
                const headers = ['ID', 'å°ˆæ¡ˆåç¨±', 'è² è²¬éƒ¨é–€', 'é–‹å§‹æ™‚é–“', 'æˆªæ­¢æ—¥æœŸ', 'å„ªå…ˆç´š', 'é€²åº¦%', 'ç‹€æ…‹', 'èªªæ˜'];
                const csvRows = [headers.join(',')];

                projects.forEach(p => {
                    const row = [
                        p.id,
                        `"${p.name}"`,
                        `"${p.department}"`,
                        p.startTime,
                        p.dueDate,
                        p.priority,
                        p.progress,
                        p.status,
                        `"${(p.notes || '').replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvStr = '\uFEFF' + csvRows.join('\n'); // \uFEFF æ˜¯ BOMï¼Œè®“ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
                const blob = new Blob([csvStr], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `projects_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('âœ… åŒ¯å‡º CSV å®Œæˆ');
            }
        }

        function openProjectModal(project) {
            // é©—è­‰å°ˆæ¡ˆå­˜åœ¨æ€§
            if (!project || !project.id) {
                alert('å°ˆæ¡ˆè³‡æ–™ç„¡æ•ˆï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                console.error('openProjectModal: å°ˆæ¡ˆç‰©ä»¶ç„¡æ•ˆ', project);
                return;
            }

            // æª¢æŸ¥å°ˆæ¡ˆæ˜¯å¦æ­£åœ¨è¼‰å…¥ï¼ˆä½¿ç”¨å°ˆæ¡ˆå°ˆç”¨çš„è¼‰å…¥æ¨™è¨˜ï¼‰
            if (isProjectsLoading) {
                alert('å°ˆæ¡ˆè³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™å†è©¦');
                console.warn('å°ˆæ¡ˆè³‡æ–™è¼‰å…¥ä¸­ï¼Œç„¡æ³•é–‹å•Ÿå°ˆæ¡ˆ');
                return;
            }

            // å†æ¬¡ç¢ºèªå°ˆæ¡ˆä»å­˜åœ¨æ–¼é™£åˆ—ä¸­ï¼ˆé˜²æ­¢ Firebase åŒæ­¥å°è‡´çš„ç«¶æ…‹æ¢ä»¶ï¼‰
            const verifiedProject = findProjectById(project.id);
            if (!verifiedProject) {
                alert('æ‰¾ä¸åˆ°æ­¤å°ˆæ¡ˆï¼Œå¯èƒ½å·²è¢«åˆªé™¤æˆ–è³‡æ–™å°šæœªåŒæ­¥å®Œæˆ\nè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦');
                console.error('openProjectModal: æ‰¾ä¸åˆ°å°ˆæ¡ˆ ID', project.id, '| ç•¶å‰å°ˆæ¡ˆåˆ—è¡¨:', projects.map(p => p.id));
                return;
            }

            currentProjectId = project.id;
            editMode = false;

            // é¡¯ç¤ºæª¢è¦–æ¨¡å¼ï¼Œéš±è—ç·¨è¼¯æ¨¡å¼
            document.getElementById('project-info-view').classList.remove('hidden');
            document.getElementById('project-info-edit').classList.add('hidden');
            document.getElementById('toggle-edit-mode').textContent = 'ç·¨è¼¯å°ˆæ¡ˆè³‡è¨Š';

            // ä½¿ç”¨å·²é©—è­‰çš„å°ˆæ¡ˆè³‡æ–™
            // å¡«å……è³‡æ–™
            document.getElementById('modal-project-name').textContent = verifiedProject.name;
            document.getElementById('modal-project-department').textContent = verifiedProject.department;
            document.getElementById('modal-start-date').textContent = verifiedProject.startTime;
            document.getElementById('modal-due-date').textContent = verifiedProject.dueDate;
            document.getElementById('modal-priority').textContent = verifiedProject.priority;
            document.getElementById('modal-status').textContent = verifiedProject.status;
            document.getElementById('modal-progress-text').textContent = `${verifiedProject.progress}%`;
            document.getElementById('modal-progress-bar').style.width = `${verifiedProject.progress}%`;

            // å‚™è¨»
            document.getElementById('project-notes').value = verifiedProject.notes || '';

            // æ ¹æ“š URL è§’è‰²åƒæ•¸è¨­å®šè©•è«–è€…èº«ä»½
            const commentAuthor = userRole === 'supervisor' ? 'ä¸»ç®¡' : 'å“¡å·¥';
            document.getElementById('comment-author').value = commentAuthor;
            document.getElementById('comment-role-text').textContent = commentAuthor;

            // è¨­å®šèº«ä»½æ¨™ç±¤æ¨£å¼
            const roleIndicator = document.getElementById('comment-role-indicator');
            if (commentAuthor === 'ä¸»ç®¡') {
                roleIndicator.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
            } else {
                roleIndicator.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800';
            }

            // è©•è«–
            renderComments(verifiedProject.comments || []);

            // æª”æ¡ˆ
            renderFilesList(verifiedProject.files || []);

            document.getElementById('project-modal').classList.add('show');
        }

        function toggleEditMode() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            editMode = !editMode;

            if (editMode) {
                // é€²å…¥ç·¨è¼¯æ¨¡å¼
                document.getElementById('project-info-view').classList.add('hidden');
                document.getElementById('project-info-edit').classList.remove('hidden');
                document.getElementById('toggle-edit-mode').textContent = 'å–æ¶ˆç·¨è¼¯';

                // å¡«å……ç·¨è¼¯è¡¨å–®
                document.getElementById('edit-project-name').value = project.name;
                document.getElementById('edit-department').value = project.department;
                document.getElementById('edit-start-date').value = project.startTime !== 'unknown' ? project.startTime : '';
                document.getElementById('edit-due-date').value = project.dueDate !== 'unknown' ? project.dueDate : '';
                document.getElementById('edit-priority').value = project.priority;
                document.getElementById('edit-status').value = project.status;
                document.getElementById('edit-progress').value = project.progress;
            } else {
                // é€€å‡ºç·¨è¼¯æ¨¡å¼
                document.getElementById('project-info-view').classList.remove('hidden');
                document.getElementById('project-info-edit').classList.add('hidden');
                document.getElementById('toggle-edit-mode').textContent = 'ç·¨è¼¯å°ˆæ¡ˆè³‡è¨Š';
            }
        }

        function saveProjectEdit() {
            const project = findProjectById(currentProjectId);
            if (!project) {
                console.error('saveProjectEdit: æ‰¾ä¸åˆ°å°ˆæ¡ˆ ID:', currentProjectId);
                alert('æ‰¾ä¸åˆ°å°ˆæ¡ˆï¼Œå¯èƒ½å·²è¢«åˆªé™¤\nè«‹é—œé–‰è¦–çª—ä¸¦é‡æ–°æ•´ç†é é¢');
                return;
            }

            // æª¢æŸ¥æ‰€æœ‰ç·¨è¼¯æ¬„ä½æ˜¯å¦å­˜åœ¨
            const nameField = document.getElementById('edit-project-name');
            const deptField = document.getElementById('edit-department');
            const startField = document.getElementById('edit-start-date');
            const dueField = document.getElementById('edit-due-date');
            const priorityField = document.getElementById('edit-priority');
            const statusField = document.getElementById('edit-status');
            const progressField = document.getElementById('edit-progress');

            if (!nameField || !deptField || !priorityField || !statusField || !progressField) {
                console.error('ç·¨è¼¯æ¬„ä½ä¸å­˜åœ¨');
                alert('ç·¨è¼¯æ¬„ä½è¼‰å…¥éŒ¯èª¤ï¼Œè«‹é‡æ–°é–‹å•Ÿå°ˆæ¡ˆ');
                return;
            }

            // æ›´æ–°å°ˆæ¡ˆè³‡æ–™
            project.name = nameField.value;
            project.department = deptField.value;
            project.startTime = startField?.value || 'unknown';
            project.dueDate = dueField?.value || 'unknown';
            project.priority = priorityField.value;
            project.status = statusField.value;
            project.progress = parseInt(progressField.value) || 0;

            // åŒæ­¥åˆ°Firebase
            syncToFirebase('projects/' + project.id, project);

            // åˆ‡æ›å›æª¢è¦–æ¨¡å¼
            editMode = false;

            // æ›´æ–°é¡¯ç¤º
            openProjectModal(project);
            renderAiDashboard();

            console.log('å°ˆæ¡ˆå·²æ›´æ–°:', project);
            alert('å°ˆæ¡ˆè³‡è¨Šå·²å„²å­˜');
        }

        function deleteProject() {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•åˆªé™¤å°ˆæ¡ˆ');
                return;
            }
            if (!currentProjectId) return;

            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            const index = projects.findIndex(p => p.id === currentProjectId);
            if (index > -1) {
                projects.splice(index, 1);
                if (isFirebaseInitialized) {
                    database.ref('projects/' + currentProjectId).remove();
                }
            }

            closeProjectModal();
            renderAiDashboard();
        }

        function saveNotes() {
            const project = findProjectById(currentProjectId);
            if (!project) {
                console.error('saveNotes: æ‰¾ä¸åˆ°å°ˆæ¡ˆ ID:', currentProjectId);
                alert('æ‰¾ä¸åˆ°å°ˆæ¡ˆï¼Œå¯èƒ½å·²è¢«åˆªé™¤æˆ–è³‡æ–™å°šæœªåŒæ­¥\nè«‹é—œé–‰è¦–çª—ä¸¦é‡æ–°æ•´ç†é é¢');
                return;
            }

            const notesField = document.getElementById('project-notes');
            if (!notesField) {
                console.error('saveNotes: æ‰¾ä¸åˆ°èªªæ˜æ¬„ä½');
                alert('èªªæ˜æ¬„ä½è¼‰å…¥éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }

            // æ›´æ–°å°ˆæ¡ˆèªªæ˜
            project.notes = notesField.value;

            // åŒæ­¥åˆ°Firebase (åŒæ­¥æ•´å€‹å°ˆæ¡ˆä»¥ç¢ºä¿ä¸€è‡´æ€§)
            syncToFirebase('projects/' + project.id, project);

            console.log('èªªæ˜å·²å„²å­˜:', project.notes);
            alert('å°ˆæ¡ˆèªªæ˜å·²å„²å­˜');
        }

        function addComment() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const text = document.getElementById('new-comment').value.trim();
            if (!text) {
                alert('è«‹è¼¸å…¥è©•è«–å…§å®¹');
                return;
            }

            if (!project.comments) project.comments = [];

            const comment = {
                id: generateUniqueId(),
                author: document.getElementById('comment-author').value,
                text: text,
                timestamp: new Date().toISOString()
            };

            project.comments.push(comment);
            syncToFirebase('projects/' + project.id + '/comments', project.comments);

            document.getElementById('new-comment').value = '';
            renderComments(project.comments);
        }

        function renderComments(comments) {
            const list = document.getElementById('comments-list');

            if (!comments || comments.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 text-center">å°šç„¡è©•è«–</p>';
                return;
            }

            list.innerHTML = comments.map(comment => {
                const date = new Date(comment.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isManager = comment.author === 'ä¸»ç®¡';

                return `
                    <div class="comment-bubble ${isManager ? 'manager' : ''}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm ${isManager ? 'text-red-800' : 'text-gray-800'}">
                                <i class="fas fa-user-circle mr-1"></i>${comment.author}
                            </span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <p class="text-gray-700">${comment.text}</p>
                    </div>
                `;
            }).join('');
        }

        function renderFilesList(files) {
            const list = document.getElementById('files-list');
            
            if (!files || files.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400">å°šæœªä¸Šå‚³æª”æ¡ˆ</p>';
                return;
            }

            list.innerHTML = files.map((file, idx) => `
                <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-3 py-2">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-gray-400"></i>
                        <span class="text-sm text-gray-700 break-all">${file.name}</span>
                        ${file.size ? `<span class="text-xs text-gray-400">(${formatSize(file.size)})</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        ${file.url ? `<a href="${file.url}" target="_blank" class="text-blue-600 text-sm hover:underline">ä¸‹è¼‰</a>` : ''}
                        <button onclick="deleteFileAt(${idx})" class="text-red-600 text-sm">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteFileAt(index) {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project || !project.files) return;

            const file = project.files[index];
            
            if (isFirebaseInitialized && file.url) {
                storage.refFromURL(file.url).delete().catch(err => console.error('åˆªé™¤æª”æ¡ˆå¤±æ•—:', err));
            }

            project.files.splice(index, 1);
            syncToFirebase('projects/' + project.id + '/files', project.files);
            renderFilesList(project.files);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes/1024).toFixed(1)} KB`;
            return `${(bytes/1024/1024).toFixed(1)} MB`;
        }

        function exportCurrentProject() {
            const project = findProjectById(currentProjectId);
            if (!project) {
                console.error('exportCurrentProject: æ‰¾ä¸åˆ°å°ˆæ¡ˆ ID:', currentProjectId);
                alert('æ‰¾ä¸åˆ°å°ˆæ¡ˆï¼Œç„¡æ³•åŒ¯å‡º\nè«‹é—œé–‰è¦–çª—ä¸¦é‡æ–°æ•´ç†é é¢');
                return;
            }

            try {
                // æº–å‚™åŒ¯å‡ºè³‡æ–™
                const exportData = {
                    ...project,
                    exportTime: new Date().toISOString(),
                    exportBy: 'ç³»çµ±ç®¡ç†å“¡'
                };

                // å‰µå»ºJSONå…§å®¹
                const jsonContent = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // å‰µå»ºä¸‹è¼‰é€£çµ
                const a = document.createElement('a');
                a.href = url;
                a.download = `${project.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}-å°ˆæ¡ˆè©³æƒ…-${new Date().toISOString().slice(0, 10)}.json`;

                // åŸ·è¡Œä¸‹è¼‰
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // æ¸…ç†URL
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log('å°ˆæ¡ˆå·²åŒ¯å‡º:', project.name);
                alert('å°ˆæ¡ˆåŒ¯å‡ºæˆåŠŸï¼');

            } catch (error) {
                console.error('åŒ¯å‡ºå¤±æ•—:', error);
                alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function closeProjectModal() {
            document.getElementById('project-modal').classList.remove('show');
            currentProjectId = null;
        }

        // === 2. ä¾‹è¡Œå…¬äº‹å„€è¡¨æ¿ ===

        // æœå°‹èˆ‡ç¯©é¸ç‹€æ…‹
        let routineSearchTerm = '';
        let routineFilterType = 'all';
        let searchDebounceTimer = null;

        // é˜²æŠ–æœå°‹è™•ç†
        function handleRoutineSearch(searchTerm) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                routineSearchTerm = searchTerm.toLowerCase().trim();
                renderRoutineDashboard();
                console.log('æœå°‹ä»»å‹™:', routineSearchTerm);
            }, 300); // 300ms é˜²æŠ–å»¶é²
        }

        // ç¯©é¸è™•ç†
        function filterRoutineTasks(filterType) {
            routineFilterType = filterType;

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.routine-filter-btn').forEach(btn => {
                if (btn.dataset.filter === filterType) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white', 'active');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'active');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            renderRoutineDashboard();
            console.log('ç¯©é¸é¡å‹:', filterType);
        }

        // æª¢æŸ¥ä»»å‹™æ˜¯å¦ç¬¦åˆæœå°‹å’Œç¯©é¸æ¢ä»¶
        function shouldShowTask(task, taskType) {
            const today = new Date();

            // æœå°‹éæ¿¾
            if (routineSearchTerm && !task.task.toLowerCase().includes(routineSearchTerm)) {
                return false;
            }

            // é¡å‹ç¯©é¸
            if (routineFilterType !== 'all') {
                // å®Œæˆç‹€æ…‹ç¯©é¸
                if (routineFilterType === 'completed') {
                    const status = getTaskCompletionStatus(task, today);
                    if (!status.completed) return false;
                } else if (routineFilterType === 'pending') {
                    const status = getTaskCompletionStatus(task, today);
                    if (status.completed) return false;
                }
                // ä»»å‹™é¡å‹ç¯©é¸
                else if (routineFilterType !== taskType) {
                    return false;
                }
            }

            return true;
        }

        // å®Œæˆè¿½è¹¤è¼”åŠ©å‡½å¼
        function getDateKey(date = new Date()) {
            // å°‡æ—¥æœŸè½‰æ›ç‚º YYYY-MM-DD æ ¼å¼ä½œç‚ºéµå€¼
            return date.toISOString().split('T')[0];
        }

        function getTaskCompletionStatus(task, date = new Date()) {
            // æŸ¥è©¢ç‰¹å®šæ—¥æœŸçš„å®Œæˆç‹€æ…‹
            if (!task.completionHistory) task.completionHistory = {};
            const dateKey = getDateKey(date);
            return task.completionHistory[dateKey] || { completed: false };
        }

        function toggleTaskCompletion(taskType, taskIndex, date = new Date()) {
            // åˆ‡æ›ä»»å‹™å®Œæˆç‹€æ…‹
            const task = routineTasks[taskType][taskIndex];
            if (!task) {
                console.error('æ‰¾ä¸åˆ°ä»»å‹™:', taskType, taskIndex);
                return;
            }

            if (!task.completionHistory) task.completionHistory = {};
            const dateKey = getDateKey(date);

            // åˆ‡æ›ç‹€æ…‹
            const currentStatus = task.completionHistory[dateKey] || { completed: false };
            task.completionHistory[dateKey] = {
                completed: !currentStatus.completed,
                timestamp: new Date().toISOString()
            };

            // åŒæ­¥åˆ° Firebase
            syncToFirebase('routineTasks', routineTasks);

            // é‡æ–°æ¸²æŸ“å„€è¡¨æ¿
            renderRoutineDashboard();

            console.log(`ä»»å‹™ "${task.task}" æ–¼ ${dateKey} æ¨™è¨˜ç‚º ${task.completionHistory[dateKey].completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}`);
        }

        function calculateTodayCompletionRate() {
            // è¨ˆç®—ä»Šæ—¥å®Œæˆç‡
            const today = new Date();
            const offCheck = isWeekendOrHoliday(today);

            // é€±æœ«æˆ–åœ‹å®šå‡æ—¥æ²’æœ‰ä»»å‹™
            if (offCheck.isOff) {
                return { completed: 0, total: 0, rate: 0 };
            }

            let totalTasks = 0;
            let completedTasks = 0;

            // è¨ˆç®—æ¯æ—¥ä»»å‹™
            if (routineTasks.daily && Array.isArray(routineTasks.daily)) {
                routineTasks.daily.forEach(task => {
                    totalTasks++;
                    const status = getTaskCompletionStatus(task, today);
                    if (status.completed) completedTasks++;
                });
            }

            // æª¢æŸ¥æ˜¯å¦åœ¨æƒåœ°é€±å…§
            if (routineTasks.threeWeeks && Array.isArray(routineTasks.threeWeeks)) {
                routineTasks.threeWeeks.forEach(task => {
                    if (task.nextWeekStart) {
                        // ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚å€è§£ææ—¥æœŸ
                        const [y, m, d] = task.nextWeekStart.split('-').map(Number);
                        const weekStart = new Date(y, m - 1, d);
                        const weekEnd = new Date(y, m - 1, d + 4);

                        if (today >= weekStart && today <= weekEnd) {
                            totalTasks++;
                            const status = getTaskCompletionStatus(task, today);
                            if (status.completed) completedTasks++;
                        }
                    }
                });
            }

            const rate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            return { completed: completedTasks, total: totalTasks, rate };
        }

        function renderRoutineDashboard() {
            const container = document.getElementById('routine-tasks-content');
            if (!container) {
                console.error('ä¾‹è¡Œå…¬äº‹å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ routineTasks å·²åˆå§‹åŒ–
            if (!routineTasks) {
                console.warn('ä¾‹è¡Œä»»å‹™è³‡æ–™å°šæœªè¼‰å…¥');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">è³‡æ–™è¼‰å…¥ä¸­...</div>';
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä»»å‹™
            const hasAnyTask = (routineTasks.daily && routineTasks.daily.length > 0) ||
                              (routineTasks.custom && routineTasks.custom.length > 0) ||
                              (routineTasks.threeWeeks && routineTasks.threeWeeks.length > 0) ||
                              (routineTasks.monthly && routineTasks.monthly.length > 0) ||
                              (routineTasks.bimonthly && routineTasks.bimonthly.length > 0);

            if (!hasAnyTask) {
                console.log('ğŸ“ ä¾‹è¡Œä»»å‹™è³‡æ–™åº«ç‚ºç©º');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-purple-50 rounded-lg p-12"><i class="fas fa-calendar-check text-6xl text-purple-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">å°šç„¡ä¾‹è¡Œä»»å‹™è³‡æ–™</p><p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢ä»»å‹™ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹ä¾‹è¡Œä»»å‹™</p></div>';
                return;
            }

            container.innerHTML = '';

            const today = new Date();
            const offCheck = isWeekendOrHoliday(today);
            let todayTasksHtml = '';

            // è¨ˆç®—ä»Šæ—¥å®Œæˆç‡
            const completionStats = calculateTodayCompletionRate();

            if (!offCheck.isOff) {
                // æ¯æ—¥ä»»å‹™ï¼ˆåŠ å…¥å‹¾é¸æ¡†ï¼‰
                if (routineTasks.daily && Array.isArray(routineTasks.daily)) {
                    routineTasks.daily.forEach((t, index) => {
                        const status = getTaskCompletionStatus(t, today);
                        const checkedClass = status.completed ? 'line-through opacity-60' : '';
                        const checkIcon = status.completed ? 'fa-check-square' : 'fa-square';

                        todayTasksHtml += `
                            <div class="flex justify-between items-center py-2 border-b border-blue-100 last:border-b-0 hover:bg-blue-50 transition-colors">
                                <div class="flex items-center space-x-3 flex-1">
                                    <button onclick="toggleTaskCompletion('daily', ${index})"
                                            class="text-blue-600 hover:text-blue-800 text-xl">
                                        <i class="far ${checkIcon}"></i>
                                    </button>
                                    <span class="text-blue-800 font-medium ${checkedClass}">${t.task}</span>
                                </div>
                                <span class="text-blue-600 text-sm">${t.time}</span>
                            </div>
                        `;
                    });
                }

                // æª¢æŸ¥æ˜¯å¦åœ¨æƒåœ°é€±å…§ï¼ˆåŠ å…¥å‹¾é¸æ¡†ï¼‰
                if (routineTasks.threeWeeks && Array.isArray(routineTasks.threeWeeks)) {
                    routineTasks.threeWeeks.forEach((t, index) => {
                        if (t.nextWeekStart) {
                            // ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚å€è§£ææ—¥æœŸ
                            const [y, m, d] = t.nextWeekStart.split('-').map(Number);
                            const weekStart = new Date(y, m - 1, d);
                            const weekEnd = new Date(y, m - 1, d + 4); // é€±äº”

                            if (today >= weekStart && today <= weekEnd) {
                                const status = getTaskCompletionStatus(t, today);
                                const checkedClass = status.completed ? 'line-through opacity-60' : '';
                                const checkIcon = status.completed ? 'fa-check-square' : 'fa-square';

                                todayTasksHtml += `
                                    <div class="flex justify-between items-center py-2 border-b border-blue-100 last:border-b-0 hover:bg-green-50 transition-colors">
                                        <div class="flex items-center space-x-3 flex-1">
                                            <button onclick="toggleTaskCompletion('threeWeeks', ${index})"
                                                    class="text-green-600 hover:text-green-800 text-xl">
                                                <i class="far ${checkIcon}"></i>
                                            </button>
                                            <span class="text-green-800 font-medium ${checkedClass}">${t.task}</span>
                                        </div>
                                        <span class="text-green-600 text-sm">${t.time}</span>
                                    </div>
                                `;
                            }
                        }
                    });
                }
            } else {
                // é¡¯ç¤ºå‡æ—¥è¨Šæ¯
                const holidayMessage = offCheck.reason === 'é€±æœ«'
                    ? 'ä»Šæ—¥ç‚ºé€±æœ«ï¼Œç„¡ä¾‹è¡Œå…¬äº‹ã€‚'
                    : `ä»Šæ—¥ç‚ºåœ‹å®šå‡æ—¥ (${offCheck.reason})ï¼Œç„¡ä¾‹è¡Œå…¬äº‹ã€‚`;
                todayTasksHtml = `<p class="text-blue-600"><i class="fas fa-calendar-times mr-2"></i>${holidayMessage}</p>`;
            }

            const taskSections = [
                { title: 'æ¯æ—¥ä»»å‹™ (é€±ä¸€è‡³é€±äº”ï¼Œæ’é™¤åœ‹å®šå‡æ—¥)', tasks: routineTasks.daily, icon: 'fa-calendar-day', color: 'blue', type: 'daily' },
                { title: 'è‡ªå®šç¾©é€±æœŸä»»å‹™', tasks: routineTasks.custom || [], icon: 'fa-calendar-check', color: 'teal', type: 'custom' },
                // èˆŠçš„ä»»å‹™é¡å‹ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                { title: 'ä¸‰é€±ä¸€æ¬¡', tasks: routineTasks.threeWeeks || [], icon: 'fa-calendar-week', color: 'green', type: 'threeWeeks' },
                { title: 'æ¯æœˆä»»å‹™', tasks: routineTasks.monthly || [], icon: 'fa-calendar-alt', color: 'purple', type: 'monthly' },
                { title: 'é›™æœˆä»»å‹™', tasks: routineTasks.bimonthly || [], icon: 'fa-calendar', color: 'orange', type: 'bimonthly' }
            ];

            const taskSectionsHtml = taskSections.map(section => {
                // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ tasks æ•¸çµ„å­˜åœ¨
                if (!section.tasks || !Array.isArray(section.tasks)) {
                    return '';
                }

                // æ‡‰ç”¨æœå°‹å’Œç¯©é¸
                const filteredTasks = section.tasks.filter(t => shouldShowTask(t, section.type));

                // å¦‚æœè©²å€å¡Šæ²’æœ‰ç¬¦åˆçš„ä»»å‹™ï¼Œä¸é¡¯ç¤ºæ•´å€‹å€å¡Š
                if (filteredTasks.length === 0 && (routineSearchTerm || routineFilterType !== 'all')) {
                    return '';
                }

                const tasksHtml = filteredTasks.map((t, index) => {
                    // éœ€è¦æ‰¾åˆ°åŸå§‹ç´¢å¼•ä»¥æ­£ç¢ºæ“ä½œ
                    const originalIndex = section.tasks.indexOf(t);
                    let display = '';
                    if (t.time) display = `<span class="text-${section.color}-600 text-sm">${t.time}</span>`;
                    if (t.day) display = `<span class="text-${section.color}-600 text-sm">æ¯æœˆ${t.day}æ—¥</span>`;

                    // é¡¯ç¤ºä¸‹æ¬¡åŸ·è¡Œæ—¥æœŸ
                    let nextDateDisplay = '';
                    if (section.type === 'custom' && t.customPeriod) {
                        // è‡ªå®šç¾©é€±æœŸä»»å‹™
                        const unitNames = { days: 'å¤©', weeks: 'é€±', months: 'æœˆ' };
                        const periodText = `æ¯ ${t.customPeriod.interval} ${unitNames[t.customPeriod.unit] || t.customPeriod.unit}`;
                        nextDateDisplay = `
                            <div class="flex flex-col space-y-1">
                                <span class="text-xs text-${section.color}-600 bg-${section.color}-100 px-2 py-0.5 rounded-full inline-block w-fit">${periodText}</span>
                                ${t.nextDate ? `<span class="text-sm text-${section.color}-700 font-semibold">ä¸‹æ¬¡: ${t.nextDate}</span>` : ''}
                            </div>
                        `;
                    } else if (section.type === 'threeWeeks') {
                        if (t.nextWeekStart) {
                            // ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚å€è§£æå’Œæ ¼å¼åŒ–æ—¥æœŸ
                            const [y, m, d] = t.nextWeekStart.split('-').map(Number);
                            const weekStart = new Date(y, m - 1, d);
                            const weekEnd = new Date(y, m - 1, d + 4); // é€±äº”
                            const startStr = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            const endStr = `${weekEnd.getFullYear()}-${String(weekEnd.getMonth() + 1).padStart(2, '0')}-${String(weekEnd.getDate()).padStart(2, '0')}`;
                            nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">ä¸‹æ¬¡æƒåœ°é€±: ${startStr} ~ ${endStr}</span>`;
                        } else if (t.lastWeekStart) {
                            // è‡ªå‹•è¨ˆç®—ä¸‹æ¬¡æƒåœ°é€±ï¼ˆä¸Šæ¬¡é€±ä¸€ + 21å¤©ï¼‰- ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚å€
                            const [y, m, d] = t.lastWeekStart.split('-').map(Number);
                            const nextStart = new Date(y, m - 1, d + 21);
                            const weekEnd = new Date(y, m - 1, d + 25); // 3é€±å¾Œçš„é€±äº”
                            const startStr = `${nextStart.getFullYear()}-${String(nextStart.getMonth() + 1).padStart(2, '0')}-${String(nextStart.getDate()).padStart(2, '0')}`;
                            const endStr = `${weekEnd.getFullYear()}-${String(weekEnd.getMonth() + 1).padStart(2, '0')}-${String(weekEnd.getDate()).padStart(2, '0')}`;
                            nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">ä¸‹æ¬¡æƒåœ°é€±: ${startStr} ~ ${endStr}</span>`;
                        } else {
                            nextDateDisplay = `<span class="text-sm text-gray-500">æœªè¨­å®š</span>`;
                        }
                    } else if (section.type === 'monthly' && t.nextDate) {
                        nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">ä¸‹æ¬¡: ${t.nextDate}</span>`;
                    } else if (section.type === 'bimonthly' && t.nextDate) {
                        nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">ä¸‹æ¬¡: ${t.nextDate}</span>`;
                    }

                    let dateButton = '';
                    if ((section.type === 'monthly' && !t.day) || section.type === 'bimonthly') {
                        const currentMonth = new Date().toISOString().substring(0, 7);
                        const dateDisplay = t.dates && t.dates[currentMonth]
                            ? `<span class="text-sm text-${section.color}-700">æœ¬æœˆ: ${t.dates[currentMonth]}</span>`
                            : `<span class="text-sm text-orange-600">âš ï¸ æœ¬æœˆæœªè¨­å®š</span>`;

                        dateButton = `
                            <div class="flex items-center space-x-2">
                                ${dateDisplay}
                                <button onclick="openRoutineDateModal('${section.type}', ${originalIndex})"
                                        title="é»æ“Šè¨­å®šæœ¬æœˆåŸ·è¡Œæ—¥æœŸ"
                                        class="text-${section.color}-600 hover:text-${section.color}-800 text-sm px-2 py-1 border border-${section.color}-300 rounded hover:bg-${section.color}-50">
                                    <i class="fas fa-calendar-plus mr-1"></i>è¨­å®šæ—¥æœŸ
                                </button>
                            </div>
                        `;
                    }

                    // ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•ï¼ˆåƒ…å°ˆæ¡ˆç®¡ç†å¸«å¯è¦‹ï¼‰
                    const editDeleteButtons = !isReadOnly ? `
                        <button onclick="editRoutineTask('${section.type}', ${originalIndex})" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteRoutineTask('${section.type}', ${originalIndex})" class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : '';

                    return `
                        <div class="flex justify-between items-center py-2 border-b border-${section.color}-100 last:border-b-0">
                            <div class="flex-1">
                                <span class="text-${section.color}-800">${t.task}</span>
                                ${nextDateDisplay ? `<div class="mt-1">${nextDateDisplay}</div>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                ${display}
                                ${dateButton}
                                ${editDeleteButtons}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-${section.color}-50 p-4 rounded-lg border border-${section.color}-200">
                        <h3 class="flex items-center text-lg font-bold text-${section.color}-800 mb-3">
                            <i class="fas ${section.icon} mr-2"></i>${section.title}
                        </h3>
                        <div class="space-y-2">${tasksHtml}</div>
                    </div>
                `;
            }).join('');

            // å®Œæˆé€²åº¦æ¢ HTML
            const progressBarHtml = dayOfWeek >= 1 && dayOfWeek <= 5 ? `
                <div class="mt-3 pt-3 border-t border-blue-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-blue-700">ä»Šæ—¥å®Œæˆé€²åº¦</span>
                        <span class="text-sm font-bold text-blue-800">${completionStats.completed}/${completionStats.total} (${completionStats.rate}%)</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${completionStats.rate}%"></div>
                    </div>
                    ${completionStats.rate === 100 ? '<p class="text-sm text-green-600 font-semibold mt-2">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»å‹™å…¨éƒ¨å®Œæˆï¼</p>' : ''}
                    ${completionStats.rate === 0 && completionStats.total > 0 ? '<p class="text-sm text-orange-600 mt-2">âš ï¸ å°šæœªé–‹å§‹ä»Šæ—¥ä»»å‹™</p>' : ''}
                </div>
            ` : '';

            container.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm">
                    <h2 class="text-xl font-bold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-tasks mr-2"></i>ä»Šæ—¥å¾…è¾¦
                    </h2>
                    <div class="space-y-2">${todayTasksHtml}</div>
                    ${progressBarHtml}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">${taskSectionsHtml}</div>
            `;

            renderCalendar();
        }

        function renderCalendar() {
            const header = document.getElementById('calendar-header');
            const body = document.getElementById('calendar-body');
            
            header.innerHTML = `
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-bold text-gray-800 w-32 text-center">${calendarDate.getFullYear()} / ${String(calendarDate.getMonth() + 1).padStart(2, '0')}</h2>
                    <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="text-sm text-gray-500">é¡¯ç¤ºæ‰€æœ‰ä¾‹è¡Œä»»å‹™</div>
            `;

            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            let calendarHtml = `
                <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
                    ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => 
                        `<div class="text-center font-semibold py-2 bg-gray-100">${d}</div>`
                    ).join('')}
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
            `;

            for (let i = 0; i < startDayOfWeek; i++) {
                calendarHtml += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const offCheck = isWeekendOrHoliday(currentDate);
                let tasksHtml = '';

                // æ¨™ç¤ºåœ‹å®šå‡æ—¥
                if (offCheck.reason && offCheck.reason !== 'é€±æœ«') {
                    tasksHtml += `<div class="calendar-task bg-red-100 text-red-600 font-semibold border border-red-300">
                        <i class="fas fa-flag text-xs mr-1"></i>${offCheck.reason}
                    </div>`;
                }

                // æ¯æ—¥ä»»å‹™ï¼ˆæ’é™¤é€±æœ«å’Œåœ‹å®šå‡æ—¥ï¼‰
                if (!offCheck.isOff) {
                    routineTasks.daily.forEach(t => {
                        const shortTask = t.task.length > 15 ? t.task.substring(0, 12) + '...' : t.task;
                        tasksHtml += `<div class="calendar-task bg-blue-100 text-blue-800">${shortTask}</div>`;
                    });
                }

                // ä¸‰é€±ä¸€æ¬¡ä»»å‹™ï¼ˆæƒåœ°é€±ï¼šé€±ä¸€åˆ°é€±äº”ï¼Œæ’é™¤åœ‹å®šå‡æ—¥ï¼‰
                if (!offCheck.isOff) {
                    routineTasks.threeWeeks.forEach(task => {
                        if (task.nextWeekStart) {
                            // ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚å€è§£ææ—¥æœŸï¼Œé¿å… UTC æ™‚å€å·®ç•°
                            const [y, m, d] = task.nextWeekStart.split('-').map(Number);
                            const weekStart = new Date(y, m - 1, d); // month æ˜¯ 0-indexed
                            const weekEnd = new Date(y, m - 1, d + 4); // é€±äº”

                            // é™¤éŒ¯è¨Šæ¯ï¼ˆåªåœ¨æª¢æŸ¥æ—¥æ›†ç¬¬ä¸€å¤©æ™‚è¼¸å‡ºï¼‰
                            if (day === 1) {
                                console.log('æ—¥æ›†ä¸‰é€±ä»»å‹™æª¢æŸ¥:', {
                                    task: task.task,
                                    nextWeekStart: task.nextWeekStart,
                                    weekStart: weekStart.toLocaleDateString('zh-TW'),
                                    weekEnd: weekEnd.toLocaleDateString('zh-TW'),
                                    currentMonth: `${year}-${String(month + 1).padStart(2, '0')}`,
                                    æ¯”è¼ƒæ¸¬è©¦: currentDate >= weekStart && currentDate <= weekEnd
                                });
                            }

                            if (currentDate >= weekStart && currentDate <= weekEnd) {
                                const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                                tasksHtml += `<div class="calendar-task bg-green-100 text-green-800">${shortTask}</div>`;
                            }
                        } else if (task.lastWeekStart) {
                            // è‡ªå‹•è¨ˆç®—ä¸‹æ¬¡æƒåœ°é€± - ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚å€
                            const [y, m, d] = task.lastWeekStart.split('-').map(Number);
                            const nextWeekStart = new Date(y, m - 1, d + 21); // 3é€±å¾Œ
                            const weekEnd = new Date(y, m - 1, d + 25); // 3é€±å¾Œçš„é€±äº”

                            if (currentDate >= nextWeekStart && currentDate <= weekEnd) {
                                const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                                tasksHtml += `<div class="calendar-task bg-green-100 text-green-800">${shortTask}</div>`;
                            }
                        }
                    });
                }

                // è‡ªå®šç¾©é€±æœŸä»»å‹™
                if (routineTasks.custom) {
                    routineTasks.custom.forEach(task => {
                        if (task.customPeriod && task.customPeriod.startDate) {
                            const startDate = new Date(task.customPeriod.startDate + 'T00:00:00');
                            const interval = task.customPeriod.interval;
                            const unit = task.customPeriod.unit;

                            // è¨ˆç®—å¾é–‹å§‹æ—¥æœŸåˆ°ç•¶å‰æ—¥æœŸçš„å¤©æ•¸å·®
                            const daysDiff = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));

                            let shouldDisplay = false;

                            if (unit === 'days') {
                                // æ¯ N å¤©
                                shouldDisplay = daysDiff >= 0 && daysDiff % interval === 0;
                            } else if (unit === 'weeks') {
                                // æ¯ N é€±ï¼ˆ7 * N å¤©ï¼‰
                                const weekInterval = interval * 7;
                                shouldDisplay = daysDiff >= 0 && daysDiff % weekInterval === 0;
                            } else if (unit === 'months') {
                                // æ¯ N æœˆï¼ˆæª¢æŸ¥æœˆä»½å·®å’Œæ—¥æœŸï¼‰
                                const monthsDiff = (currentDate.getFullYear() - startDate.getFullYear()) * 12 +
                                                  (currentDate.getMonth() - startDate.getMonth());
                                shouldDisplay = monthsDiff >= 0 &&
                                               monthsDiff % interval === 0 &&
                                               currentDate.getDate() === startDate.getDate();
                            }

                            if (shouldDisplay) {
                                const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                                tasksHtml += `<div class="calendar-task bg-teal-100 text-teal-800">${shortTask}</div>`;
                            }
                        }
                    });
                }

                // æ¯æœˆä»»å‹™
                if (routineTasks.monthly && Array.isArray(routineTasks.monthly)) {
                    routineTasks.monthly.forEach(task => {
                        // å›ºå®šæ—¥æœŸï¼ˆæ¯æœˆXæ—¥ï¼‰
                        if (task.day && task.day === day) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${shortTask}</div>`;
                        }
                        // ä¸‹æ¬¡åŸ·è¡Œæ—¥æœŸ
                        else if (task.nextDate === dateStr) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${shortTask}</div>`;
                        }
                        // æ¯æœˆè‡ªå®šç¾©æ—¥æœŸ
                        else if (task.dates && task.dates[currentMonthStr] === dateStr) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${shortTask}</div>`;
                        }
                    });
                }

                // é›™æœˆä»»å‹™ï¼ˆä¸‹æ¬¡åŸ·è¡Œæ—¥æœŸï¼‰
                if (routineTasks.bimonthly && Array.isArray(routineTasks.bimonthly)) {
                    routineTasks.bimonthly.forEach(task => {
                        if (task.nextDate === dateStr) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-orange-100 text-orange-800">${shortTask}</div>`;
                        } else if (task.dates && task.dates[currentMonthStr] === dateStr) {
                            // èˆŠçš„ dates æ ¼å¼ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                            tasksHtml += `<div class="calendar-task bg-orange-100 text-orange-800">${task.task}</div>`;
                        }
                    });
                }

                const isToday = new Date().toDateString() === currentDate.toDateString() ? 'bg-blue-100' : 'bg-white';
                calendarHtml += `
                    <div class="calendar-day p-2 ${isToday}">
                        <div class="font-semibold text-right">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }

            calendarHtml += `</div>`;
            body.innerHTML = calendarHtml;
        }

        function changeMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            renderCalendar();
        }

        function showAddRoutineModal() {
            document.getElementById('add-routine-modal').classList.add('show');
        }

        function closeAddRoutineModal() {
            document.getElementById('add-routine-modal').classList.remove('show');
        }

        // å¥—ç”¨å¿«é€Ÿé è¨­
        function applyPreset(preset) {
            const intervalInput = document.getElementById('new-routine-custom-interval');
            const unitSelect = document.getElementById('new-routine-custom-unit');

            if (preset === 'weekly') {
                intervalInput.value = '1';
                unitSelect.value = 'weeks';
            } else if (preset === 'monthly') {
                intervalInput.value = '1';
                unitSelect.value = 'months';
            } else if (preset === 'quarterly') {
                intervalInput.value = '3';
                unitSelect.value = 'months';
            }

            // è§¸ç™¼ä¸‹æ¬¡æ—¥æœŸè¨ˆç®—
            calculateCustomNextDate();

            console.log('å¥—ç”¨é è¨­:', preset);
        }

        function updateRoutineFields() {
            const type = document.getElementById('new-routine-type').value;
            const timeField = document.getElementById('routine-time-field');
            const customField = document.getElementById('routine-custom-field');
            const nextDateField = document.getElementById('routine-next-date-field');
            const nextDateInput = document.getElementById('new-routine-next-date');
            const nextDateHint = document.getElementById('next-date-hint');
            const nextDateLabel = nextDateField.querySelector('label');

            // é‡ç½®æ‰€æœ‰æ¬„ä½
            timeField.classList.add('hidden');
            customField.classList.add('hidden');
            nextDateField.classList.add('hidden');

            if (type === 'daily') {
                // æ¯æ—¥ä»»å‹™ï¼šé¡¯ç¤ºæ™‚é–“
                timeField.classList.remove('hidden');
            } else if (type === 'custom') {
                // è‡ªå®šç¾©é€±æœŸï¼šé¡¯ç¤ºé€±æœŸè¨­å®šå’Œé–‹å§‹æ—¥æœŸ
                customField.classList.remove('hidden');
                nextDateField.classList.remove('hidden');
                nextDateLabel.textContent = 'ä¸‹æ¬¡åŸ·è¡Œæ—¥æœŸï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰';
                nextDateInput.readOnly = true;
                nextDateInput.classList.add('bg-gray-100');
                nextDateHint.textContent = 'æ ¹æ“šé–‹å§‹æ—¥æœŸå’Œé€±æœŸè‡ªå‹•è¨ˆç®—';
            }
        }

        function calculateNextDate() {
            const lastDate = document.getElementById('new-routine-last-date').value;
            if (!lastDate) {
                document.getElementById('new-routine-next-date').value = '';
                return;
            }

            // è¨ˆç®—ä¸‹æ¬¡æ—¥æœŸï¼ˆä¸Šæ¬¡æ—¥æœŸ + 21å¤©ï¼‰
            const date = new Date(lastDate);
            date.setDate(date.getDate() + 21);

            const nextDate = date.toISOString().split('T')[0];
            document.getElementById('new-routine-next-date').value = nextDate;
        }

        function calculateCustomNextDate() {
            const startDate = document.getElementById('new-routine-custom-start').value;
            const interval = parseInt(document.getElementById('new-routine-custom-interval').value);
            const unit = document.getElementById('new-routine-custom-unit').value;

            if (!startDate || !interval) {
                document.getElementById('new-routine-next-date').value = '';
                return;
            }

            const date = new Date(startDate);

            if (unit === 'days') {
                date.setDate(date.getDate() + interval);
            } else if (unit === 'weeks') {
                date.setDate(date.getDate() + (interval * 7));
            } else if (unit === 'months') {
                date.setMonth(date.getMonth() + interval);
            }

            const nextDate = date.toISOString().split('T')[0];
            document.getElementById('new-routine-next-date').value = nextDate;
        }

        function addNewRoutine() {
            const type = document.getElementById('new-routine-type').value;
            const taskName = document.getElementById('new-routine-task').value;

            if (!taskName) {
                alert('è«‹è¼¸å…¥ä»»å‹™åç¨±');
                return;
            }

            const taskData = { task: taskName, completionHistory: {} };

            if (type === 'daily') {
                taskData.time = document.getElementById('new-routine-time').value;
            } else if (type === 'weekly') {
                // æ¯é€±ä»»å‹™ï¼šå„²å­˜æ™‚é–“å’Œé¸ä¸­çš„æ˜ŸæœŸå¹¾
                taskData.time = document.getElementById('new-routine-time').value;
                const weekdayCheckboxes = document.querySelectorAll('.routine-weekday-checkbox:checked');
                taskData.weekdays = Array.from(weekdayCheckboxes).map(cb => parseInt(cb.value));

                if (taskData.weekdays.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åŸ·è¡Œæ—¥');
                    return;
                }

                console.log('æ¯é€±ä»»å‹™è¨­å®š:', { task: taskName, weekdays: taskData.weekdays });
            } else if (type === 'threeWeeks') {
                taskData.time = document.getElementById('new-routine-time').value;
                const lastWeekStart = document.getElementById('new-routine-last-date').value;
                const nextWeekStart = document.getElementById('new-routine-next-date').value;

                taskData.lastWeekStart = lastWeekStart;
                taskData.nextWeekStart = nextWeekStart;

                // åŠ å…¥é™¤éŒ¯è¨Šæ¯
                console.log('ä¸‰é€±ä»»å‹™è¨­å®š:', {
                    task: taskName,
                    lastWeekStart,
                    nextWeekStart
                });
            } else if (type === 'monthly') {
                const day = document.getElementById('new-routine-day').value;
                if (day) {
                    taskData.day = parseInt(day);
                } else {
                    taskData.dates = {};
                }
                const nextDate = document.getElementById('new-routine-next-date').value;
                if (nextDate) taskData.nextDate = nextDate;
            } else if (type === 'quarterly') {
                // æ¯å­£ä»»å‹™ï¼šå„²å­˜å­£åº¦æœˆä»½å’Œæ—¥æœŸ
                const quarterMonth = parseInt(document.getElementById('new-routine-quarter-month').value);
                const quarterDay = parseInt(document.getElementById('new-routine-quarter-day').value);
                const nextDate = document.getElementById('new-routine-next-date').value;

                if (!quarterDay || !nextDate) {
                    alert('è«‹å¡«å¯«æ—¥æœŸå’Œä¸‹æ¬¡åŸ·è¡Œæ—¥æœŸ');
                    return;
                }

                taskData.quarterMonth = quarterMonth;  // 1, 2, or 3
                taskData.quarterDay = quarterDay;
                taskData.nextDate = nextDate;

                console.log('æ¯å­£ä»»å‹™è¨­å®š:', { task: taskName, quarterMonth, quarterDay, nextDate });
            } else if (type === 'bimonthly') {
                taskData.dates = {};
                const nextDate = document.getElementById('new-routine-next-date').value;
                if (nextDate) taskData.nextDate = nextDate;
            } else if (type === 'custom') {
                // è‡ªå®šç¾©é€±æœŸä»»å‹™
                const interval = parseInt(document.getElementById('new-routine-custom-interval').value);
                const unit = document.getElementById('new-routine-custom-unit').value;
                const startDate = document.getElementById('new-routine-custom-start').value;
                const nextDate = document.getElementById('new-routine-next-date').value;

                if (!interval || !startDate) {
                    alert('è«‹å¡«å¯«é€±æœŸæ•¸é‡å’Œé–‹å§‹æ—¥æœŸ');
                    return;
                }

                taskData.customPeriod = {
                    interval: interval,
                    unit: unit,
                    startDate: startDate
                };
                taskData.nextDate = nextDate;

                console.log('è‡ªå®šç¾©é€±æœŸä»»å‹™è¨­å®š:', { task: taskName, customPeriod: taskData.customPeriod, nextDate });
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼
            if (currentRoutineTask && currentRoutineTask.isEditing) {
                // ç·¨è¼¯æ¨¡å¼ï¼šæ›´æ–°ç¾æœ‰ä»»å‹™
                const { type: oldType, index } = currentRoutineTask;

                // ä¿ç•™åŸæœ‰çš„ completionHistory
                const oldTask = routineTasks[oldType][index];
                if (oldTask && oldTask.completionHistory) {
                    taskData.completionHistory = oldTask.completionHistory;
                }

                // æª¢æŸ¥é¡å‹æ˜¯å¦æ”¹è®Š
                if (type === oldType) {
                    // é¡å‹æœªè®Šï¼šç›´æ¥æ›´æ–°åŸä½ç½®
                    routineTasks[oldType][index] = taskData;
                    console.log('âœ… ä»»å‹™å·²æ›´æ–°ï¼ˆé¡å‹æœªè®Šï¼‰:', type);
                } else {
                    // é¡å‹å·²è®Šï¼šå¾èˆŠé™£åˆ—åˆªé™¤ï¼Œæ·»åŠ åˆ°æ–°é™£åˆ—
                    routineTasks[oldType].splice(index, 1);
                    if (!routineTasks[type]) routineTasks[type] = [];
                    routineTasks[type].unshift(taskData);
                    console.log('âœ… ä»»å‹™å·²æ›´æ–°ï¼ˆé¡å‹æ”¹è®Šï¼‰:', oldType, 'â†’', type);
                }
                alert('ä»»å‹™å·²æ›´æ–°');
            } else {
                // æ–°å¢æ¨¡å¼ï¼šæ·»åŠ æ–°ä»»å‹™åˆ°åˆ—è¡¨æœ€ä¸Šæ–¹
                if (!routineTasks[type]) routineTasks[type] = [];
                routineTasks[type].unshift(taskData);  // ä½¿ç”¨ unshift å°‡æ–°ä»»å‹™æ’å…¥åˆ°é–‹é ­
                console.log('âœ… æ–°å¢ä»»å‹™:', type, '-', taskName);
                alert('ä»»å‹™å·²æ–°å¢');
            }

            syncToFirebase('routineTasks', routineTasks);
            closeAddRoutineModal();
            renderRoutineDashboard();

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('new-routine-task').value = '';
            document.getElementById('new-routine-time').value = '';
            document.getElementById('new-routine-day').value = '';
            document.getElementById('new-routine-last-date').value = '';
            document.getElementById('new-routine-next-date').value = '';
            currentRoutineTask = null;
        }

        function openRoutineDateModal(type, index) {
            const task = routineTasks[type][index];
            currentRoutineTask = { type, index };

            document.getElementById('routine-task-name').value = task.task;
            document.getElementById('routine-task-date').value = '';
            document.getElementById('routine-date-modal').classList.add('show');
        }

        function closeRoutineModal() {
            document.getElementById('routine-date-modal').classList.remove('show');
            currentRoutineTask = null;
        }

        function saveRoutineDate() {
            if (!currentRoutineTask) return;

            const date = document.getElementById('routine-task-date').value;
            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸ');
                return;
            }

            const task = routineTasks[currentRoutineTask.type][currentRoutineTask.index];
            const month = date.substring(0, 7);

            if (!task.dates) task.dates = {};
            task.dates[month] = date;

            syncToFirebase('routineTasks', routineTasks);
            closeRoutineModal();
            renderRoutineDashboard();
        }

        function editRoutineTask(type, index) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•ç·¨è¼¯ä¾‹è¡Œä»»å‹™');
                return;
            }

            const task = routineTasks[type][index];
            if (!task) {
                alert('æ‰¾ä¸åˆ°è©²ä»»å‹™');
                return;
            }

            // å¡«å……ç·¨è¼¯è¡¨å–®
            document.getElementById('new-routine-type').value = type;
            document.getElementById('new-routine-task').value = task.task;

            if (task.time) {
                document.getElementById('new-routine-time').value = task.time;
            }
            if (task.day) {
                document.getElementById('new-routine-day').value = task.day;
            }
            if (task.lastDate) {
                // å‘å¾Œå…¼å®¹èˆŠçš„ lastDate æ¬„ä½
                document.getElementById('new-routine-last-date').value = task.lastDate;
            }
            if (task.lastWeekStart) {
                document.getElementById('new-routine-last-date').value = task.lastWeekStart;
            }
            if (task.nextDate) {
                // å‘å¾Œå…¼å®¹èˆŠçš„ nextDate æ¬„ä½
                document.getElementById('new-routine-next-date').value = task.nextDate;
            }
            if (task.nextWeekStart) {
                document.getElementById('new-routine-next-date').value = task.nextWeekStart;
            }
            // è‡ªå®šç¾©é€±æœŸä»»å‹™
            if (task.customPeriod) {
                document.getElementById('new-routine-custom-interval').value = task.customPeriod.interval;
                document.getElementById('new-routine-custom-unit').value = task.customPeriod.unit;
                document.getElementById('new-routine-custom-start').value = task.customPeriod.startDate;
            }

            updateRoutineFields();

            // ä¿å­˜ç•¶å‰ç·¨è¼¯çš„ä»»å‹™è³‡è¨Š
            currentRoutineTask = { type, index, isEditing: true };

            document.getElementById('add-routine-modal').classList.add('show');
        }

        function deleteRoutineTask(type, index) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•åˆªé™¤ä¾‹è¡Œä»»å‹™');
                return;
            }

            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä¾‹è¡Œä»»å‹™å—ï¼Ÿ')) return;

            routineTasks[type].splice(index, 1);
            syncToFirebase('routineTasks', routineTasks);
            renderRoutineDashboard();
            alert('ä»»å‹™å·²åˆªé™¤');
        }

        // === 3. åˆ†äº«æœƒå„€è¡¨æ¿ ===
        let sharingSearchTerm = '';

        function handleSharingSearch(value) {
            sharingSearchTerm = value.toLowerCase();
            renderSharingDashboard();
            console.log('æœå°‹åˆ†äº«æœƒ:', sharingSearchTerm);
        }

        function matchesSearch(session, searchTerm) {
            if (!searchTerm) return true;

            // æœå°‹ä¸»é¡Œ
            if (session.theme && session.theme.toLowerCase().includes(searchTerm)) return true;

            // æœå°‹è¬›è€…
            if (session.speaker && session.speaker.toLowerCase().includes(searchTerm)) return true;

            // æœå°‹è­°ç¨‹å…§å®¹
            if (session.schedule && Array.isArray(session.schedule)) {
                if (session.schedule.some(item => item.toLowerCase().includes(searchTerm))) {
                    return true;
                }
            }

            return false;
        }

        function renderSharingDashboard() {
            const container = document.getElementById('sharing-session-content');
            if (!container) {
                console.error('åˆ†äº«æœƒå®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ sharingSessions å·²åˆå§‹åŒ–
            if (!sharingSessions || !Array.isArray(sharingSessions)) {
                console.warn('åˆ†äº«æœƒè³‡æ–™å°šæœªè¼‰å…¥');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">è³‡æ–™è¼‰å…¥ä¸­...</div>';
                return;
            }

            // å¦‚æœè³‡æ–™ç‚ºç©ºï¼Œé¡¯ç¤ºå‹å–„æç¤º
            if (sharingSessions.length === 0) {
                console.log('ğŸ“ åˆ†äº«æœƒè³‡æ–™åº«ç‚ºç©º');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-teal-50 rounded-lg p-12"><i class="fas fa-comments text-6xl text-teal-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">å°šç„¡åˆ†äº«æœƒè³‡æ–™</p><p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢åˆ†äº«æœƒã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å ´åˆ†äº«æœƒ</p></div>';
                return;
            }

            // æ ¹æ“šæ—¥æœŸè‡ªå‹•åˆ†é¡ä¸¦å¥—ç”¨æœå°‹éæ¿¾
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcoming = sharingSessions
                .filter(s => {
                    const sessionDate = new Date(s.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    return sessionDate >= today;
                })
                .filter(s => matchesSearch(s, sharingSearchTerm));

            const past = sharingSessions
                .filter(s => {
                    const sessionDate = new Date(s.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    return sessionDate < today;
                })
                .filter(s => matchesSearch(s, sharingSearchTerm));

            let upcomingHtml = upcoming.length > 0 ? upcoming.map(s => {
                const scheduleHtml = (s.schedule && Array.isArray(s.schedule))
                    ? s.schedule.map(item => `<li class="text-gray-600">${item}</li>`).join('')
                    : '<li class="text-gray-400">è­°ç¨‹è³‡æ–™æœªè¨­å®š</li>';
                const editDeleteButtons = !isReadOnly ? `
                    <div class="space-x-2">
                        <button onclick="editSharing(${s.id})" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSharing(${s.id})" class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';
                return `
                    <div class="bg-green-50 border border-green-200 p-6 rounded-lg mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-green-800">${s.theme}</h3>
                                <p class="text-green-600 mt-1">æ—¥æœŸï¼š${s.date} | è¬›è€…ï¼š${s.speaker}</p>
                            </div>
                            ${editDeleteButtons}
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">è­°ç¨‹å®‰æ’ï¼š</h4>
                            <ul class="list-disc list-inside space-y-1">${scheduleHtml}</ul>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500">ç›®å‰æ²’æœ‰å·²æ’ç¨‹çš„åˆ†äº«æœƒã€‚</p>';

            const pastHtml = past.map(s => {
                const content = (s.schedule && Array.isArray(s.schedule)) ? s.schedule.map(item => {
                    if (item.startsWith('http')) {
                        return `<li><a href="${item}" target="_blank" class="text-blue-600 hover:underline break-all">
                            <i class="fas fa-link mr-2"></i>é€£çµ</a></li>`;
                    }
                    if (/\.(pdf|pptx|zip|jpg)/i.test(item)) {
                        return `<li><i class="fas fa-file mr-2 text-gray-400"></i>${item}</li>`;
                    }
                    return `<li>${item}</li>`;
                }).join('') : '<li class="text-gray-400">è­°ç¨‹è³‡æ–™æœªè¨­å®š</li>';

                // ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•ï¼ˆåªæœ‰éåªè®€æ¨¡å¼æ‰é¡¯ç¤ºï¼‰
                const editDeleteButtons = !isReadOnly ? `
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editSharing(${s.id}); event.stopPropagation();" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSharing(${s.id}); event.stopPropagation();" class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs hover:bg-red-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';

                return `
                    <details class="p-4 border-b last:border-b-0">
                        <summary class="flex justify-between items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">${s.date}</p>
                                <p class="font-semibold text-gray-700">${s.theme}</p>
                            </div>
                            <div class="flex items-center">
                                ${editDeleteButtons}
                                <i class="fas fa-chevron-right summary-icon text-gray-400 ml-2"></i>
                            </div>
                        </summary>
                        <div class="mt-4 pl-4 border-l-2 border-gray-200">
                            <ul class="list-disc list-inside space-y-1 text-gray-600 mb-4">${content}</ul>

                            <!-- è©•è«–å€å¡Š -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-700 mb-3"><i class="fas fa-comments mr-2"></i>ä¸»ç®¡è©•è«–</h4>
                                <div id="sharing-comments-${s.id}" class="space-y-2 mb-3">
                                    ${renderSharingComments(s.comments || [])}
                                </div>
                                ${isReadOnly ? `
                                    <div class="mt-3">
                                        <input type="text" id="sharing-comment-${s.id}" placeholder="è¼¸å…¥æ‚¨çš„è©•è«–..." class="w-full p-2 border rounded text-sm">
                                        <button onclick="addSharingComment(${s.id})" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                                            <i class="fas fa-paper-plane mr-1"></i>é€å‡ºè©•è«–
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </details>
                `;
            }).join('');

            // æœå°‹çµæœæç¤º
            const totalResults = upcoming.length + past.length;
            const searchResultsHtml = sharingSearchTerm
                ? `<div class="mb-4 text-sm text-gray-600 bg-teal-50 p-3 rounded-lg">
                     æ‰¾åˆ° ${totalResults} ç­†ç¬¦åˆã€Œ${sharingSearchTerm}ã€çš„çµæœ
                   </div>`
                : '';

            container.innerHTML = `
                ${searchResultsHtml}
                <h2 class="text-xl font-bold text-gray-800 mb-4">å³å°‡èˆ‰è¡Œçš„åˆ†äº«æœƒ</h2>
                ${upcomingHtml}
                <h2 class="text-xl font-bold text-gray-800 mt-10 mb-4">éå¾€åˆ†äº«æœƒç´€éŒ„</h2>
                <div class="border rounded-lg bg-gray-50">${pastHtml}</div>
            `;
        }

        function showAddSharingModal() {
            document.getElementById('add-sharing-modal').classList.add('show');
        }

        function closeAddSharingModal() {
            document.getElementById('add-sharing-modal').classList.remove('show');
        }

        function addNewSharing() {
            const schedule = document.getElementById('new-sharing-schedule').value.split('\n').filter(s => s.trim());
            
            const newSharing = {
                id: generateUniqueId(),
                date: document.getElementById('new-sharing-date').value,
                theme: document.getElementById('new-sharing-theme').value,
                speaker: document.getElementById('new-sharing-speaker').value,
                status: 'upcoming',
                schedule: schedule,
                comments: []
            };

            if (!newSharing.date || !newSharing.theme || !newSharing.speaker) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            sharingSessions.push(newSharing);
            // åŒæ­¥æ•´å€‹ sharingSessions é™£åˆ—ä»¥é¿å…è¦†è“‹å•é¡Œ
            syncToFirebase('sharingSessions', sharingSessions);
            
            closeAddSharingModal();
            renderSharingDashboard();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('new-sharing-date').value = '';
            document.getElementById('new-sharing-theme').value = '';
            document.getElementById('new-sharing-speaker').value = '';
            document.getElementById('new-sharing-schedule').value = '';
        }

        function deleteSharing(id) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•åˆªé™¤åˆ†äº«æœƒ');
                return;
            }
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†äº«æœƒå—ï¼Ÿ')) return;
            
            const index = sharingSessions.findIndex(s => s.id === id);
            if (index > -1) {
                sharingSessions.splice(index, 1);
                // åŒæ­¥æ•´å€‹ sharingSessions é™£åˆ—ä»¥é¿å…è¦†è“‹å•é¡Œ
                syncToFirebase('sharingSessions', sharingSessions);
            }
            renderSharingDashboard();
        }

        function editSharing(id) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•ç·¨è¼¯åˆ†äº«æœƒ');
                return;
            }

            const sharing = sharingSessions.find(s => s.id === id);
            if (!sharing) {
                alert('æ‰¾ä¸åˆ°è©²åˆ†äº«æœƒ');
                return;
            }

            currentSharingId = id;

            // å¡«å……è¡¨å–®
            document.getElementById('edit-sharing-date').value = sharing.date;
            document.getElementById('edit-sharing-theme').value = sharing.theme;
            document.getElementById('edit-sharing-speaker').value = sharing.speaker;
            document.getElementById('edit-sharing-status').value = sharing.status;
            document.getElementById('edit-sharing-schedule').value = sharing.schedule.join('\n');

            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('edit-sharing-modal').classList.add('show');
        }

        function closeEditSharingModal() {
            document.getElementById('edit-sharing-modal').classList.remove('show');
            currentSharingId = null;
        }

        function saveEditSharing() {
            if (!currentSharingId) return;

            const sharing = sharingSessions.find(s => s.id === currentSharingId);
            if (!sharing) {
                alert('æ‰¾ä¸åˆ°è©²åˆ†äº«æœƒ');
                return;
            }

            const schedule = document.getElementById('edit-sharing-schedule').value.split('\n').filter(s => s.trim());

            sharing.date = document.getElementById('edit-sharing-date').value;
            sharing.theme = document.getElementById('edit-sharing-theme').value;
            sharing.speaker = document.getElementById('edit-sharing-speaker').value;
            sharing.status = document.getElementById('edit-sharing-status').value;
            sharing.schedule = schedule;

            if (!sharing.date || !sharing.theme || !sharing.speaker) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            syncToFirebase('sharingSessions', sharingSessions);
            closeEditSharingModal();
            renderSharingDashboard();
            alert('åˆ†äº«æœƒå·²æ›´æ–°');
        }

        // åˆ†äº«æœƒè©•è«–åŠŸèƒ½
        function renderSharingComments(comments) {
            if (!comments || comments.length === 0) {
                return '<p class="text-sm text-gray-400 text-center py-2">å°šç„¡è©•è«–</p>';
            }

            return comments.map(comment => {
                const date = new Date(comment.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isManager = comment.author === 'ä¸»ç®¡';

                return `
                    <div class="p-3 rounded-lg ${isManager ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200'}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm ${isManager ? 'text-red-800' : 'text-gray-800'}">
                                <i class="fas fa-user-circle mr-1"></i>${comment.author}
                            </span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <p class="text-sm ${isManager ? 'text-red-700' : 'text-gray-700'}">${comment.text}</p>
                    </div>
                `;
            }).join('');
        }

        function addSharingComment(sessionId) {
            const input = document.getElementById(`sharing-comment-${sessionId}`);
            const text = input.value.trim();

            if (!text) {
                alert('è«‹è¼¸å…¥è©•è«–å…§å®¹');
                return;
            }

            const session = sharingSessions.find(s => s.id === sessionId);
            if (!session) {
                alert('æ‰¾ä¸åˆ°è©²åˆ†äº«æœƒ');
                return;
            }

            if (!session.comments) session.comments = [];

            const comment = {
                id: generateUniqueId(),
                author: 'ä¸»ç®¡',  // åªæœ‰ä¸»ç®¡èƒ½è©•è«–
                text: text,
                timestamp: new Date().toISOString()
            };

            session.comments.push(comment);
            syncToFirebase('sharingSessions', sharingSessions);

            input.value = '';
            renderSharingDashboard();
        }

        // === 4. æ´»å‹•åƒèˆ‡å„€è¡¨æ¿ ===
        function renderEventsDashboard(filteredEvents = null) {
            const container = document.getElementById('event-participation-content');
            if (!container) {
                console.error('æ´»å‹•å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ eventsAttended å·²åˆå§‹åŒ–
            if (!eventsAttended || !Array.isArray(eventsAttended)) {
                console.warn('æ´»å‹•è³‡æ–™å°šæœªè¼‰å…¥');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">è³‡æ–™è¼‰å…¥ä¸­...</div>';
                return;
            }

            // å¦‚æœè³‡æ–™ç‚ºç©ºï¼Œé¡¯ç¤ºå‹å–„æç¤º
            if (eventsAttended.length === 0) {
                console.log('ğŸ“ æ´»å‹•è³‡æ–™åº«ç‚ºç©º');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-orange-50 rounded-lg p-12"><i class="fas fa-calendar-alt text-6xl text-orange-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">å°šç„¡æ´»å‹•è³‡æ–™</p><p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€å€‹æ´»å‹•</p></div>';
                return;
            }

            const events = filteredEvents || eventsAttended;

            const internalEvents = events.filter(e => e.type === 'internal');
            const externalEvents = events.filter(e => e.type === 'external');

            const renderEventSection = (title, events) => {
                if (events.length === 0) return '';

                const eventsHtml = events.map(event => {
                    const learningsHtml = (event.learnings && Array.isArray(event.learnings))
                        ? event.learnings.map(learning => `<li class="text-gray-600">${learning}</li>`).join('')
                        : '<li class="text-gray-400">å­¸ç¿’å¿ƒå¾—æœªè¨­å®š</li>';
                    const filesHtml = event.files && Array.isArray(event.files) ? event.files.map(file => {
                        if (file.link === '#' || !file.link) {
                            return `<span class="inline-block bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm mr-2 mb-2">
                                <i class="fas fa-file mr-1"></i>${file.name}
                            </span>`;
                        } else {
                            return `<a href="${file.link}" target="_blank" class="inline-block bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1 rounded-full text-sm mr-2 mb-2 transition-colors">
                                <i class="fas fa-download mr-1"></i>${file.name}
                            </a>`;
                        }
                    }).join('') : '';

                    return `
                        <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${event.eventName}</h3>
                                    <p class="text-gray-500 mt-1">${event.date}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="bg-${event.type === 'external' ? 'blue' : 'green'}-100 text-${event.type === 'external' ? 'blue' : 'green'}-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${event.type === 'external' ? 'å¤–éƒ¨æ´»å‹•' : 'å…§éƒ¨æ´»å‹•'}
                                    </span>
                                    ${!isReadOnly ? `
                                        <button onclick="editEvent(${event.id})" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteEvent(${event.id})" class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">æ´»å‹•æ¦‚è¿°ï¼š</h4>
                                <p class="text-gray-600">${event.summary}</p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">ä¸»è¦å­¸ç¿’èˆ‡æ”¶ç©«ï¼š</h4>
                                <ul class="list-disc list-inside space-y-1">${learningsHtml}</ul>
                            </div>
                            ${event.files && event.files.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">ç›¸é—œè³‡æ–™ï¼š</h4>
                                <div class="flex flex-wrap">${filesHtml}</div>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');

                return `
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-gray-200">${title}</h2>
                        <div class="space-y-6">${eventsHtml}</div>
                    </section>
                `;
            };

            container.innerHTML = renderEventSection('å¤–éƒ¨æ´»å‹•', externalEvents) + renderEventSection('å…§éƒ¨æ´»å‹•', internalEvents);
        }

        function showAddEventModal() {
            document.getElementById('add-event-modal').classList.add('show');
        }

        function closeAddEventModal() {
            document.getElementById('add-event-modal').classList.remove('show');
        }

        function addNewEvent() {
            const learnings = document.getElementById('new-event-learnings').value.split('\n').filter(l => l.trim());
            
            const newEvent = {
                id: generateUniqueId(),
                eventName: document.getElementById('new-event-name').value,
                date: document.getElementById('new-event-date').value,
                type: document.getElementById('new-event-type').value,
                summary: document.getElementById('new-event-summary').value,
                learnings: learnings,
                files: []
            };

            if (!newEvent.eventName || !newEvent.date || !newEvent.summary) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            eventsAttended.push(newEvent);
            // åŒæ­¥æ•´å€‹ events é™£åˆ—ä»¥é¿å…è¦†è“‹å•é¡Œ
            syncToFirebase('events', eventsAttended);
            
            closeAddEventModal();
            renderEventsDashboard();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('new-event-name').value = '';
            document.getElementById('new-event-date').value = '';
            document.getElementById('new-event-summary').value = '';
            document.getElementById('new-event-learnings').value = '';
        }

        function deleteEvent(id) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•åˆªé™¤æ´»å‹•ç´€éŒ„');
                return;
            }
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•ç´€éŒ„å—ï¼Ÿ')) return;

            const index = eventsAttended.findIndex(e => e.id === id);
            if (index > -1) {
                eventsAttended.splice(index, 1);
                // åŒæ­¥æ•´å€‹ events é™£åˆ—ä»¥é¿å…è¦†è“‹å•é¡Œ
                syncToFirebase('events', eventsAttended);
            }
            renderEventsDashboard();
        }

        function editEvent(id) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•ç·¨è¼¯æ´»å‹•');
                return;
            }

            const event = eventsAttended.find(e => e.id === id);
            if (!event) {
                alert('æ‰¾ä¸åˆ°è©²æ´»å‹•');
                return;
            }

            currentEventId = id;

            // å¡«å……è¡¨å–®
            document.getElementById('edit-event-name').value = event.eventName;
            document.getElementById('edit-event-date').value = event.date;
            document.getElementById('edit-event-type').value = event.type;
            document.getElementById('edit-event-summary').value = event.summary;
            document.getElementById('edit-event-learnings').value = event.learnings.join('\n');

            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('edit-event-modal').classList.add('show');
        }

        function closeEditEventModal() {
            document.getElementById('edit-event-modal').classList.remove('show');
            currentEventId = null;
        }

        function saveEditEvent() {
            if (!currentEventId) return;

            const event = eventsAttended.find(e => e.id === currentEventId);
            if (!event) {
                alert('æ‰¾ä¸åˆ°è©²æ´»å‹•');
                return;
            }

            const learnings = document.getElementById('edit-event-learnings').value.split('\n').filter(l => l.trim());

            event.eventName = document.getElementById('edit-event-name').value;
            event.date = document.getElementById('edit-event-date').value;
            event.type = document.getElementById('edit-event-type').value;
            event.summary = document.getElementById('edit-event-summary').value;
            event.learnings = learnings;

            if (!event.eventName || !event.date || !event.summary) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            syncToFirebase('events', eventsAttended);
            closeEditEventModal();
            renderEventsDashboard();
            alert('æ´»å‹•å·²æ›´æ–°');
        }

        function filterEvents() {
            const searchTerm = document.getElementById('event-search').value.toLowerCase();
            const typeFilter = document.getElementById('event-type-filter').value;

            let filtered = eventsAttended;

            // é¡å‹ç¯©é¸
            if (typeFilter !== 'all') {
                filtered = filtered.filter(e => e.type === typeFilter);
            }

            // æœå°‹ç¯©é¸
            if (searchTerm) {
                filtered = filtered.filter(e =>
                    e.eventName.toLowerCase().includes(searchTerm) ||
                    e.summary.toLowerCase().includes(searchTerm) ||
                    e.learnings.some(l => l.toLowerCase().includes(searchTerm))
                );
            }

            renderEventsDashboard(filtered);
        }

        // === 5. æ¥æ´½ä¼æ¥­å„€è¡¨æ¿ ===
        function renderContactsDashboard(filteredContacts = null) {
            const container = document.getElementById('business-contacts-content');
            if (!container) {
                console.error('ä¼æ¥­æ¥æ´½å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ businessContacts å·²åˆå§‹åŒ–
            if (!businessContacts || !Array.isArray(businessContacts)) {
                console.warn('ä¼æ¥­æ¥æ´½è³‡æ–™å°šæœªè¼‰å…¥');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">è³‡æ–™è¼‰å…¥ä¸­...</div>';
                return;
            }

            // å¦‚æœè³‡æ–™ç‚ºç©ºï¼Œé¡¯ç¤ºå‹å–„æç¤º
            if (businessContacts.length === 0) {
                console.log('ğŸ“ ä¼æ¥­æ¥æ´½è³‡æ–™åº«ç‚ºç©º');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-green-50 rounded-lg p-12"><i class="fas fa-building text-6xl text-green-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">å°šç„¡ä¼æ¥­æ¥æ´½è³‡æ–™</p><p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢ä¼æ¥­æ¥æ´½ã€æŒ‰éˆ•é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†æ¥æ´½è¨˜éŒ„</p></div>';
                return;
            }

            const contacts = filteredContacts || businessContacts;

            const tableRows = contacts.map(contact => {
                const filesHtml = contact.files && contact.files.length > 0 ? contact.files.map(file => {
                    if (file.link === '#' || !file.link) {
                        return `<span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs mr-1 mb-1">
                            <i class="fas fa-file mr-1"></i>${file.name}
                        </span>`;
                    } else {
                        return `<a href="${file.link}" target="_blank" class="inline-block bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded text-xs mr-1 mb-1 transition-colors">
                            <i class="fas fa-download mr-1"></i>${file.name}
                        </a>`;
                    }
                }).join('') : '<span class="text-sm text-gray-400">ç„¡</span>';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${contact.companyName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${contact.contactPerson}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${contact.date}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 max-w-xs">${contact.topic}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap">${filesHtml}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                ${!isReadOnly ? `
                                    <button onclick="editContact(${contact.id})" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteContact(${contact.id})" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : '<span class="text-sm text-gray-400">-</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¼æ¥­åç¨±</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¯çµ¡äºº</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¥æ´½æ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ´½è«‡ä¸»é¡Œ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›¸é—œè³‡æ–™</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAddContactModal() {
            document.getElementById('add-contact-modal').classList.add('show');
        }

        function closeAddContactModal() {
            document.getElementById('add-contact-modal').classList.remove('show');
        }

        function addNewContact() {
            const newContact = {
                id: generateUniqueId(),
                companyName: document.getElementById('new-contact-company').value,
                contactPerson: document.getElementById('new-contact-person').value,
                date: document.getElementById('new-contact-date').value,
                topic: document.getElementById('new-contact-topic').value,
                files: []
            };

            if (!newContact.companyName || !newContact.contactPerson || !newContact.date || !newContact.topic) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            businessContacts.push(newContact);
            // åŒæ­¥æ•´å€‹ contacts é™£åˆ—ä»¥é¿å…è¦†è“‹å•é¡Œ
            syncToFirebase('contacts', businessContacts);
            
            closeAddContactModal();
            renderContactsDashboard();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('new-contact-company').value = '';
            document.getElementById('new-contact-person').value = '';
            document.getElementById('new-contact-date').value = '';
            document.getElementById('new-contact-topic').value = '';
        }

        function deleteContact(id) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•åˆªé™¤æ¥æ´½ç´€éŒ„');
                return;
            }
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¥æ´½ç´€éŒ„å—ï¼Ÿ')) return;

            const index = businessContacts.findIndex(c => c.id === id);
            if (index > -1) {
                businessContacts.splice(index, 1);
                // åŒæ­¥æ•´å€‹ contacts é™£åˆ—ä»¥é¿å…è¦†è“‹å•é¡Œ
                syncToFirebase('contacts', businessContacts);
            }
            renderContactsDashboard();
        }

        function editContact(id) {
            if (isReadOnly) {
                alert('ä¸»ç®¡è§’è‰²ç„¡æ³•ç·¨è¼¯æ¥æ´½ç´€éŒ„');
                return;
            }

            const contact = businessContacts.find(c => c.id === id);
            if (!contact) {
                alert('æ‰¾ä¸åˆ°è©²æ¥æ´½ç´€éŒ„');
                return;
            }

            currentContactId = id;

            // å¡«å……è¡¨å–®
            document.getElementById('edit-contact-company').value = contact.companyName;
            document.getElementById('edit-contact-person').value = contact.contactPerson;
            document.getElementById('edit-contact-date').value = contact.date;
            document.getElementById('edit-contact-topic').value = contact.topic;

            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('edit-contact-modal').classList.add('show');
        }

        function closeEditContactModal() {
            document.getElementById('edit-contact-modal').classList.remove('show');
            currentContactId = null;
        }

        function saveEditContact() {
            if (!currentContactId) return;

            const contact = businessContacts.find(c => c.id === currentContactId);
            if (!contact) {
                alert('æ‰¾ä¸åˆ°è©²æ¥æ´½ç´€éŒ„');
                return;
            }

            contact.companyName = document.getElementById('edit-contact-company').value;
            contact.contactPerson = document.getElementById('edit-contact-person').value;
            contact.date = document.getElementById('edit-contact-date').value;
            contact.topic = document.getElementById('edit-contact-topic').value;

            if (!contact.companyName || !contact.contactPerson || !contact.date || !contact.topic) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            syncToFirebase('contacts', businessContacts);
            closeEditContactModal();
            renderContactsDashboard();
            alert('æ¥æ´½ç´€éŒ„å·²æ›´æ–°');
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contact-search').value.toLowerCase();

            if (!searchTerm) {
                renderContactsDashboard();
                return;
            }

            const filtered = businessContacts.filter(c =>
                c.companyName.toLowerCase().includes(searchTerm) ||
                c.contactPerson.toLowerCase().includes(searchTerm) ||
                c.topic.toLowerCase().includes(searchTerm)
            );

            renderContactsDashboard(filtered);
        }

        // === æª”æ¡ˆä¸Šå‚³åŠŸèƒ½ ===
        function setupFileUpload() {
            const area = document.getElementById('file-upload-area');
            const input = document.getElementById('file-input');
            const selectBtn = document.getElementById('select-files');

            if (!area || !input || !selectBtn) return;

            selectBtn.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => handleFiles(e.target.files));

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer && e.dataTransfer.files) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }

        async function handleFiles(fileList) {
            if (!currentProjectId) return;
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            if (!project.files) project.files = [];

            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-bar');
            const progressPercent = document.getElementById('upload-percent');

            for (let file of fileList) {
                // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆæœ€å¤§ 10MBï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æª”æ¡ˆ ${file.name} è¶…é 10MB é™åˆ¶`);
                    continue;
                }

                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';

                if (isFirebaseInitialized) {
                    // ä¸Šå‚³åˆ° Firebase Storage
                    const storageRef = storage.ref(`projects/${currentProjectId}/${Date.now()}_${file.name}`);
                    const uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressPercent.textContent = Math.round(progress) + '%';
                        },
                        (error) => {
                            console.error('ä¸Šå‚³å¤±æ•—:', error);
                            alert('æª”æ¡ˆä¸Šå‚³å¤±æ•—');
                            progressDiv.classList.add('hidden');
                        },
                        async () => {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            const fileInfo = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                url: downloadURL,
                                uploadTime: new Date().toISOString()
                            };

                            project.files.push(fileInfo);
                            syncToFirebase('projects/' + currentProjectId + '/files', project.files);
                            renderFilesList(project.files);
                            progressDiv.classList.add('hidden');
                        }
                    );
                } else {
                    // é›¢ç·šæ¨¡å¼ï¼šä½¿ç”¨ blob URL
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: URL.createObjectURL(file),
                        uploadTime: new Date().toISOString()
                    };
                    project.files.push(fileInfo);
                    renderFilesList(project.files);
                    progressDiv.classList.add('hidden');
                }
            }
        }

        // === åˆ†äº«æœƒ/æ´»å‹•/ä¼æ¥­æ¥æ´½ æª”æ¡ˆä¸Šå‚³åŠŸèƒ½ ===
        let currentSharingFiles = [];
        let currentEventFiles = [];
        let currentContactFiles = [];

        function setupAllFileUploads() {
            setupFileUpload(); // åŸæœ‰çš„å°ˆæ¡ˆæª”æ¡ˆä¸Šå‚³
            setupSharingFileUpload();
            setupEventFileUpload();
            setupContactFileUpload();
        }

        function setupSharingFileUpload() {
            // æ–°å¢åˆ†äº«æœƒæª”æ¡ˆä¸Šå‚³
            const newArea = document.getElementById('sharing-file-upload-area');
            const newInput = document.getElementById('sharing-file-input');
            if (newArea && newInput) {
                newArea.addEventListener('click', () => newInput.click());
                newInput.addEventListener('change', (e) => handleSharingFiles(e.target.files, 'new'));
                setupDragDrop(newArea, (files) => handleSharingFiles(files, 'new'));
            }

            // ç·¨è¼¯åˆ†äº«æœƒæª”æ¡ˆä¸Šå‚³
            const editArea = document.getElementById('edit-sharing-file-upload-area');
            const editInput = document.getElementById('edit-sharing-file-input');
            if (editArea && editInput) {
                editArea.addEventListener('click', () => editInput.click());
                editInput.addEventListener('change', (e) => handleSharingFiles(e.target.files, 'edit'));
                setupDragDrop(editArea, (files) => handleSharingFiles(files, 'edit'));
            }
        }

        function setupEventFileUpload() {
            // æ–°å¢æ´»å‹•æª”æ¡ˆä¸Šå‚³
            const newArea = document.getElementById('event-file-upload-area');
            const newInput = document.getElementById('event-file-input');
            if (newArea && newInput) {
                newArea.addEventListener('click', () => newInput.click());
                newInput.addEventListener('change', (e) => handleEventFiles(e.target.files, 'new'));
                setupDragDrop(newArea, (files) => handleEventFiles(files, 'new'));
            }

            // ç·¨è¼¯æ´»å‹•æª”æ¡ˆä¸Šå‚³
            const editArea = document.getElementById('edit-event-file-upload-area');
            const editInput = document.getElementById('edit-event-file-input');
            if (editArea && editInput) {
                editArea.addEventListener('click', () => editInput.click());
                editInput.addEventListener('change', (e) => handleEventFiles(e.target.files, 'edit'));
                setupDragDrop(editArea, (files) => handleEventFiles(files, 'edit'));
            }
        }

        function setupContactFileUpload() {
            // æ–°å¢æ¥æ´½æª”æ¡ˆä¸Šå‚³
            const newArea = document.getElementById('contact-file-upload-area');
            const newInput = document.getElementById('contact-file-input');
            if (newArea && newInput) {
                newArea.addEventListener('click', () => newInput.click());
                newInput.addEventListener('change', (e) => handleContactFiles(e.target.files, 'new'));
                setupDragDrop(newArea, (files) => handleContactFiles(files, 'new'));
            }

            // ç·¨è¼¯æ¥æ´½æª”æ¡ˆä¸Šå‚³
            const editArea = document.getElementById('edit-contact-file-upload-area');
            const editInput = document.getElementById('edit-contact-file-input');
            if (editArea && editInput) {
                editArea.addEventListener('click', () => editInput.click());
                editInput.addEventListener('change', (e) => handleContactFiles(e.target.files, 'edit'));
                setupDragDrop(editArea, (files) => handleContactFiles(files, 'edit'));
            }
        }

        function setupDragDrop(area, handler) {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer && e.dataTransfer.files) {
                    handler(e.dataTransfer.files);
                }
            });
        }

        async function handleSharingFiles(fileList, mode) {
            for (let file of fileList) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æª”æ¡ˆ ${file.name} è¶…é 10MB é™åˆ¶`);
                    continue;
                }
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file),
                    file: file
                };
                currentSharingFiles.push(fileInfo);
            }
            renderFilesList(`${mode}-sharing-files-list`, currentSharingFiles);
        }

        async function handleEventFiles(fileList, mode) {
            for (let file of fileList) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æª”æ¡ˆ ${file.name} è¶…é 10MB é™åˆ¶`);
                    continue;
                }
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file),
                    file: file
                };
                currentEventFiles.push(fileInfo);
            }
            renderFilesList(`${mode}-event-files-list`, currentEventFiles);
        }

        async function handleContactFiles(fileList, mode) {
            for (let file of fileList) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æª”æ¡ˆ ${file.name} è¶…é 10MB é™åˆ¶`);
                    continue;
                }
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file),
                    file: file
                };
                currentContactFiles.push(fileInfo);
            }
            renderFilesList(`${mode}-contact-files-list`, currentContactFiles);
        }

        function renderFilesList(listId, files) {
            const list = document.getElementById(listId);
            if (!list) return;

            list.innerHTML = files.map((f, i) => `
                <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded text-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-gray-400"></i>
                        <span class="text-gray-700">${f.name}</span>
                        <span class="text-gray-400 text-xs">(${(f.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removeFile('${listId}', ${i})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(listId, index) {
            if (listId.includes('sharing')) {
                currentSharingFiles.splice(index, 1);
                renderFilesList(listId, currentSharingFiles);
            } else if (listId.includes('event')) {
                currentEventFiles.splice(index, 1);
                renderFilesList(listId, currentEventFiles);
            } else if (listId.includes('contact')) {
                currentContactFiles.splice(index, 1);
                renderFilesList(listId, currentContactFiles);
            }
        }

        // === Modal äº‹ä»¶è¨­ç½® ===
        function setupModalEvents() {
            // å°ˆæ¡ˆ Modal
            document.getElementById('close-modal')?.addEventListener('click', closeProjectModal);
            document.getElementById('close-modal-btn')?.addEventListener('click', closeProjectModal);
            document.getElementById('toggle-edit-mode')?.addEventListener('click', toggleEditMode);
            document.getElementById('save-notes')?.addEventListener('click', saveNotes);
            document.getElementById('add-comment')?.addEventListener('click', addComment);
            document.getElementById('export-project')?.addEventListener('click', exportCurrentProject);

            // è©•è«– Enter ç™¼é€
            document.getElementById('new-comment')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addComment();
                }
            });

            // ESC é—œé–‰æ‰€æœ‰ Modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });

            // é»æ“Šé®ç½©é—œé–‰ Modal
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // æª”æ¡ˆä¸Šå‚³
            setupAllFileUploads();
        }
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="多功能專案管理與溝通儀表板">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>多功能整合儀表板 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 備用字體和樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .kanban-column-content::-webkit-scrollbar, .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .kanban-column-content::-webkit-scrollbar-track, .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb:hover, .table-container::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dashboard-tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-weight: 500; color: #6b7280; }
        .dashboard-tab:hover { color: #1f2937; background-color: #f3f4f6; }
        .dashboard-tab.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .hidden { display: none; }
        
        /* Calendar Styles */
        #calendar-grid { grid-template-rows: repeat(6, minmax(0, 1fr)); }
        .calendar-day { min-height: 100px; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-task { font-size: 0.75rem; padding: 2px 4px; border-radius: 4px; margin-top: 2px; }
        
        /* Details Summary Styling */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details .summary-icon { transition: transform 0.2s; }
        details[open] .summary-icon { transform: rotate(90deg); }
        
        /* Modal Styles */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 1000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-overlay.show { display: flex; }
        .modal-content { 
            background: white; 
            border-radius: 12px; 
            max-width: 90vw; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
        }
        .project-card { cursor: pointer; transition: all 0.2s ease; }
        .project-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .file-upload-area { 
            border: 2px dashed #d1d5db; 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            transition: all 0.2s ease; 
        }
        .file-upload-area:hover { border-color: #3b82f6; background-color: #f8fafc; }
        .file-upload-area.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* Comments Section */
        .comment-bubble {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        .comment-bubble.manager {
            background: #fee2e2;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Action Button */
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Firebase 配置提示 -->
    <div id="firebase-setup" class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6 max-w-7xl mx-auto">
        <h3 class="font-bold text-yellow-800 mb-2">⚠️ Firebase 設置提醒</h3>
        <p class="text-yellow-700 mb-3">請先設置 Firebase 配置以啟用雲端同步功能：</p>
        <div class="bg-white p-3 rounded border border-yellow-300">
            <code class="text-sm">
                1. 前往 Firebase Console 建立專案<br>
                2. 啟用 Realtime Database 和 Storage<br>
                3. 將您的配置資訊填入下方<br>
            </code>
        </div>
        <button onclick="showFirebaseConfig()" class="mt-3 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
            設定 Firebase
        </button>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Navigation Tabs -->
        <nav class="bg-white rounded-t-lg shadow-sm">
            <div id="tab-container" class="flex border-b border-gray-200 overflow-x-auto">
                <button data-target="dashboard-ai" class="dashboard-tab active flex-shrink-0">AI 專案進度</button>
                <button data-target="dashboard-routine" class="dashboard-tab flex-shrink-0">例行公事</button>
                <button data-target="dashboard-sharing" class="dashboard-tab flex-shrink-0">分享會</button>
                <button data-target="dashboard-events" class="dashboard-tab flex-shrink-0">活動參與</button>
                <button data-target="dashboard-contacts" class="dashboard-tab flex-shrink-0">接洽企業</button>
            </div>
        </nav>

        <!-- Dashboard Content Area -->
        <main class="bg-white p-6 rounded-b-lg shadow-sm min-h-[80vh]">
            <!-- 1. AI Project Dashboard -->
            <div id="dashboard-ai" class="dashboard-content">
                <header class="md:flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">AI 專案進度儀表板</h1>
                        <p class="text-gray-500 mt-1">概覽所有進行中與構思中的 AI 導入專案。</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-4">
                        <button onclick="showAddProjectModal()" class="action-btn">
                            <i class="fas fa-plus mr-2"></i>新增專案
                        </button>
                        <div>
                            <label for="month-filter" class="text-sm font-medium text-gray-700 mr-2">依成立月份篩選:</label>
                            <select id="month-filter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                        </div>
                        <div id="sync-status" class="flex items-center">
                            <div class="spinner mr-2"></div>
                            <span class="text-sm text-gray-500">同步中...</span>
                        </div>
                    </div>
                </header>
                <div id="ai-summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
                <div id="ai-kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6"></div>
            </div>

            <!-- 2. Routine Tasks Dashboard -->
            <div id="dashboard-routine" class="dashboard-content hidden">
                 <header class="mb-8 flex justify-between items-center">
                     <div>
                         <h1 class="text-3xl font-bold text-gray-800">例行公事儀表板</h1>
                         <p class="text-gray-500 mt-1">追蹤每日、每週、每月的重複性任務。</p>
                     </div>
                     <button onclick="showAddRoutineModal()" class="action-btn">
                         <i class="fas fa-plus mr-2"></i>新增任務
                     </button>
                 </header>
                 <div id="routine-tasks-content" class="space-y-8"></div>
                 <div class="mt-12">
                     <div id="calendar-header" class="flex items-center justify-between mb-4"></div>
                     <div id="calendar-body"></div>
                 </div>
            </div>

            <!-- 3. Sharing Session Dashboard -->
            <div id="dashboard-sharing" class="dashboard-content hidden">
                 <header class="mb-8 flex justify-between items-center">
                     <div>
                         <h1 class="text-3xl font-bold text-gray-800">分享會儀表板</h1>
                         <p class="text-gray-500 mt-1">規劃與回顧內部 AI 新知分享會。</p>
                     </div>
                     <button onclick="showAddSharingModal()" class="action-btn">
                         <i class="fas fa-plus mr-2"></i>新增分享會
                     </button>
                 </header>
                 <div id="sharing-session-content"></div>
            </div>

            <!-- 4. Event Participation Dashboard -->
            <div id="dashboard-events" class="dashboard-content hidden">
                 <header class="mb-8">
                     <div class="flex justify-between items-center mb-4">
                         <div>
                             <h1 class="text-3xl font-bold text-gray-800">活動參與儀表板</h1>
                             <p class="text-gray-500 mt-1">記錄內外部活動的學習與收穫。</p>
                         </div>
                         <button onclick="showAddEventModal()" class="action-btn">
                             <i class="fas fa-plus mr-2"></i>新增活動
                         </button>
                     </div>
                     <div class="flex items-center space-x-4">
                         <div class="flex-1">
                             <input id="event-search" type="text" placeholder="搜尋活動名稱或概述..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    oninput="filterEvents()">
                         </div>
                         <select id="event-type-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterEvents()">
                             <option value="all">所有類型</option>
                             <option value="external">外部活動</option>
                             <option value="internal">內部活動</option>
                         </select>
                     </div>
                 </header>
                 <div id="event-participation-content" class="space-y-10"></div>
            </div>

            <!-- 5. Business Contact Dashboard -->
            <div id="dashboard-contacts" class="dashboard-content hidden">
                 <header class="mb-8">
                     <div class="flex justify-between items-center mb-4">
                         <div>
                             <h1 class="text-3xl font-bold text-gray-800">接洽企業儀表板</h1>
                             <p class="text-gray-500 mt-1">管理與外部企業、廠商的合作與洽談紀錄。</p>
                         </div>
                         <button onclick="showAddContactModal()" class="action-btn">
                             <i class="fas fa-plus mr-2"></i>新增接洽
                         </button>
                     </div>
                     <div class="flex-1">
                         <input id="contact-search" type="text" placeholder="搜尋企業名稱、聯絡人或洽談主題..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                oninput="filterContacts()">
                     </div>
                 </header>
                 <div id="business-contacts-content" class="table-container overflow-x-auto"></div>
            </div>
        </main>
    </div>

    <!-- Enhanced Project Detail Modal -->
    <div id="project-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-5xl mx-4">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="modal-project-name" class="text-2xl font-bold text-gray-800"></h2>
                        <p id="modal-project-department" class="text-gray-600 mt-1"></p>
                    </div>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Edit/View Toggle -->
                <div class="mb-4">
                    <button id="toggle-edit-mode" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-edit mr-2"></i>編輯專案資訊
                    </button>
                </div>

                <!-- Project Basic Info (Editable) -->
                <div id="project-info-view" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">基本資訊</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">開始日期:</span>
                                <span id="modal-start-date" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">預計完成:</span>
                                <span id="modal-due-date" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">優先級:</span>
                                <span id="modal-priority" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">狀態:</span>
                                <span id="modal-status" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">進度追蹤</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">完成進度</span>
                                <span id="modal-progress-text" class="text-sm font-medium"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="modal-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Form (Initially Hidden) -->
                <div id="project-info-edit" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                            <input id="edit-project-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">負責部門</label>
                            <input id="edit-department" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                            <input id="edit-start-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">預計完成</label>
                            <input id="edit-due-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">優先級</label>
                            <select id="edit-priority" class="w-full px-3 py-2 border rounded-lg">
                                <option value="高">高</option>
                                <option value="中">中</option>
                                <option value="低">低</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                            <select id="edit-status" class="w-full px-3 py-2 border rounded-lg">
                                <option value="構思中">構思中</option>
                                <option value="規劃中">規劃中</option>
                                <option value="開發中">開發中</option>
                                <option value="測試中">測試中</option>
                                <option value="已終止">已終止</option>
                                <option value="已完成">已完成</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">進度 (%)</label>
                            <input id="edit-progress" type="number" min="0" max="100" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <button onclick="saveProjectEdit()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full">
                                <i class="fas fa-save mr-2"></i>儲存變更
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Project Progress Notes -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">專案進度說明</h3>
                    <textarea id="project-notes" placeholder="在此輸入專案進度說明、遇到的問題、解決方案等詳細資訊..." 
                              class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="save-notes" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>儲存說明
                        </button>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-comments mr-2"></i>評論與討論
                    </h3>
                    
                    <!-- Add New Comment -->
                    <div class="mb-4">
                        <div class="flex items-start space-x-3">
                            <select id="comment-author" class="rounded-md border-gray-300 shadow-sm text-sm">
                                <option value="員工">員工</option>
                                <option value="主管">主管</option>
                            </select>
                            <textarea id="new-comment" placeholder="輸入您的評論或建議..." 
                                      class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                      rows="2"></textarea>
                            <button id="add-comment" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Comments List -->
                    <div id="comments-list" class="max-h-64 overflow-y-auto">
                        <!-- Comments will be rendered here -->
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">相關文件</h3>
                    <div id="file-upload-area" class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-sm text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
                        <button id="select-files" class="mt-3 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>選擇檔案
                        </button>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-blue-700">上傳中...</span>
                                    <span id="upload-percent" class="text-sm font-medium text-blue-700">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="upload-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uploaded Files List -->
                    <div id="uploaded-files" class="mt-4">
                        <h4 class="font-medium text-gray-800 mb-2">已上傳的檔案</h4>
                        <div id="files-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-between pt-4 border-t border-gray-200">
                    <button onclick="deleteProject()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>刪除專案
                    </button>
                    <div class="space-x-3">
                        <button id="export-project" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>匯出專案資料
                        </button>
                        <button id="close-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Project Modal -->
    <div id="add-project-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增 AI 專案</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                    <input id="new-project-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">負責部門</label>
                    <input id="new-project-department" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                    <input id="new-project-start" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">預計完成</label>
                    <input id="new-project-due" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">優先級</label>
                    <select id="new-project-priority" class="w-full px-3 py-2 border rounded-lg">
                        <option value="高">高</option>
                        <option value="中">中</option>
                        <option value="低">低</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                    <select id="new-project-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="構思中">構思中</option>
                        <option value="規劃中">規劃中</option>
                        <option value="開發中">開發中</option>
                        <option value="測試中">測試中</option>
                        <option value="已終止">已終止</option>
                        <option value="已完成">已完成</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddProjectModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewProject()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增專案</button>
            </div>
        </div>
    </div>

    <!-- Add Sharing Session Modal -->
    <div id="add-sharing-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增分享會</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分享會日期</label>
                    <input id="new-sharing-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主題</label>
                    <input id="new-sharing-theme" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">講者</label>
                    <input id="new-sharing-speaker" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">議程安排（每行一項）</label>
                    <textarea id="new-sharing-schedule" rows="5" class="w-full px-3 py-2 border rounded-lg" 
                              placeholder="16:00-16:05 開場與介紹
16:05-16:30 主題分享
16:30-16:45 Q&A 與交流"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddSharingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewSharing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增分享會</button>
            </div>
        </div>
    </div>

    <!-- Edit Sharing Session Modal -->
    <div id="edit-sharing-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯分享會</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分享會日期</label>
                    <input id="edit-sharing-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主題</label>
                    <input id="edit-sharing-theme" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">講者</label>
                    <input id="edit-sharing-speaker" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                    <select id="edit-sharing-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="upcoming">即將舉行</option>
                        <option value="past">過往紀錄</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">議程安排（每行一項）</label>
                    <textarea id="edit-sharing-schedule" rows="5" class="w-full px-3 py-2 border rounded-lg"
                              placeholder="16:00-16:05 開場與介紹
16:05-16:30 主題分享
16:30-16:45 Q&A 與交流"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditSharingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveEditSharing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增活動參與</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動名稱</label>
                    <input id="new-event-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動日期</label>
                    <input id="new-event-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動類型</label>
                    <select id="new-event-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="external">外部活動</option>
                        <option value="internal">內部活動</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動概述</label>
                    <textarea id="new-event-summary" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主要學習與收穫（每行一項）</label>
                    <textarea id="new-event-learnings" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddEventModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewEvent()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增活動</button>
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="edit-event-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯活動參與</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動名稱</label>
                    <input id="edit-event-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動日期</label>
                    <input id="edit-event-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動類型</label>
                    <select id="edit-event-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="external">外部活動</option>
                        <option value="internal">內部活動</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動概述</label>
                    <textarea id="edit-event-summary" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主要學習與收穫（每行一項）</label>
                    <textarea id="edit-event-learnings" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditEventModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveEditEvent()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增企業接洽</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">企業名稱</label>
                    <input id="new-contact-company" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label>
                    <input id="new-contact-person" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">接洽日期</label>
                    <input id="new-contact-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">洽談主題</label>
                    <textarea id="new-contact-topic" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddContactModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewContact()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增接洽</button>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div id="edit-contact-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯企業接洽</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">企業名稱</label>
                    <input id="edit-contact-company" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label>
                    <input id="edit-contact-person" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">接洽日期</label>
                    <input id="edit-contact-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">洽談主題</label>
                    <textarea id="edit-contact-topic" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditContactModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveEditContact()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Add Routine Task Modal -->
    <div id="add-routine-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增例行任務</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">任務類型</label>
                    <select id="new-routine-type" class="w-full px-3 py-2 border rounded-lg" onchange="updateRoutineFields()">
                        <option value="daily">每日任務</option>
                        <option value="threeWeeks">三週一次</option>
                        <option value="monthly">每月任務</option>
                        <option value="bimonthly">雙月任務</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">任務名稱</label>
                    <input id="new-routine-task" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div id="routine-time-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">執行時間</label>
                    <input id="new-routine-time" type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例：8:00~8:15">
                </div>
                <div id="routine-day-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">每月執行日</label>
                    <input id="new-routine-day" type="number" min="1" max="31" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddRoutineModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewRoutine()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增任務</button>
            </div>
        </div>
    </div>

    <!-- Routine Task Date Setting Modal -->
    <div id="routine-date-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">設定例行任務日期</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">任務名稱</label>
                <input id="routine-task-name" type="text" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">選擇日期</label>
                <input id="routine-task-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeRoutineModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveRoutineDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存</button>
            </div>
        </div>
    </div>

    <!-- Firebase Config Modal -->
    <div id="firebase-config-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Firebase 配置</h3>
            <div class="space-y-3">
                <input type="text" id="fb-apiKey" placeholder="API Key" class="w-full px-3 py-2 border rounded">
                <input type="text" id="fb-authDomain" placeholder="Auth Domain" class="w-full px-3 py-2 border rounded">
                <input type="text" id="fb-databaseURL" placeholder="Database URL" class="w-full px-3 py-2 border rounded">
                <input type="text" id="fb-projectId" placeholder="Project ID" class="w-full px-3 py-2 border rounded">
                <input type="text" id="fb-storageBucket" placeholder="Storage Bucket" class="w-full px-3 py-2 border rounded">
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeFirebaseConfig()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveFirebaseConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存配置</button>
            </div>
        </div>
    </div>

    <script>
        // ===== 權限系統 (URL 參數法) =====
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'manager'; // 預設為專案管理師
        const isReadOnly = userRole === 'supervisor'; // 主管為唯讀模式

        console.log('使用者角色:', userRole, '| 唯讀模式:', isReadOnly);

        // Firebase 初始化
        let database, storage;
        let isFirebaseInitialized = false;
        
        function initFirebase() {
            const config = localStorage.getItem('firebaseConfig');
            if (!config) {
                console.log('Firebase 配置未設置');
                updateSyncStatus('離線模式', false);
                return false;
            }
            
            try {
                const firebaseConfig = JSON.parse(config);
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                storage = firebase.storage();
                isFirebaseInitialized = true;
                
                document.getElementById('firebase-setup').style.display = 'none';
                updateSyncStatus('已連線', true);
                
                // 載入所有資料
                loadAllDataFromFirebase();
                
                return true;
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                updateSyncStatus('連線失敗', false);
                return false;
            }
        }
        
        function showFirebaseConfig() {
            document.getElementById('firebase-config-modal').classList.add('show');
        }
        
        function closeFirebaseConfig() {
            document.getElementById('firebase-config-modal').classList.remove('show');
        }
        
        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('fb-apiKey').value,
                authDomain: document.getElementById('fb-authDomain').value,
                databaseURL: document.getElementById('fb-databaseURL').value,
                projectId: document.getElementById('fb-projectId').value,
                storageBucket: document.getElementById('fb-storageBucket').value,
                messagingSenderId: "dummy",
                appId: "dummy"
            };
            
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            closeFirebaseConfig();
            location.reload();
        }
        
        function updateSyncStatus(text, success = true) {
            const statusEl = document.getElementById('sync-status');
            if (!statusEl) return;

            if (success) {
                statusEl.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i><span class="text-sm text-green-600">${text}</span>`;
            } else {
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i><span class="text-sm text-yellow-600">${text}</span>`;
            }
        }

        // ===== 權限系統 - 套用權限限制 =====
        function applyPermissions() {
            if (!isReadOnly) {
                console.log('專案管理師模式 - 所有功能可用');
                return; // 管理師不限制
            }

            console.log('套用主管檢視模式權限');

            // 1. 隱藏所有「新增」按鈕
            const addButtons = [
                'button[onclick="showAddProjectModal()"]',
                'button[onclick="showAddRoutineModal()"]',
                'button[onclick="showAddSharingModal()"]',
                'button[onclick="showAddEventModal()"]',
                'button[onclick="showAddContactModal()"]'
            ];

            addButtons.forEach(selector => {
                const btn = document.querySelector(selector);
                if (btn) {
                    btn.style.display = 'none';
                    console.log('隱藏新增按鈕:', selector);
                }
            });

            // 2. 隱藏「編輯專案資訊」按鈕
            const editToggle = document.getElementById('toggle-edit-mode');
            if (editToggle) {
                editToggle.style.display = 'none';
            }

            // 3. 隱藏所有「刪除」按鈕
            setTimeout(() => {
                document.querySelectorAll('button[onclick*="delete"]').forEach(btn => {
                    if (!btn.classList.contains('comment-delete')) { // 保留評論刪除按鈕
                        btn.style.display = 'none';
                    }
                });
            }, 500);

            // 4. 禁用進度說明編輯
            const notesField = document.getElementById('project-notes');
            if (notesField) {
                notesField.disabled = true;
                notesField.style.backgroundColor = '#f3f4f6';
                notesField.style.cursor = 'not-allowed';
            }

            // 5. 隱藏「儲存說明」按鈕
            const saveNotesBtn = document.getElementById('save-notes');
            if (saveNotesBtn) {
                saveNotesBtn.style.display = 'none';
            }

            // 6. 隱藏「編輯」按鈕（分享會、活動、接洽企業）
            setTimeout(() => {
                document.querySelectorAll('button[onclick*="edit"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }, 500);

            // 7. 在頁面頂部顯示角色標識
            const container = document.querySelector('.max-w-7xl');
            if (container && !document.getElementById('role-indicator')) {
                const roleIndicator = document.createElement('div');
                roleIndicator.id = 'role-indicator';
                roleIndicator.className = 'bg-blue-100 border border-blue-300 text-blue-800 px-4 py-2 rounded-lg mb-4 text-center font-semibold';
                roleIndicator.innerHTML = '<i class="fas fa-eye mr-2"></i>檢視模式：主管 - 您可以查看所有資訊並在專案中留言';
                container.insertBefore(roleIndicator, container.firstChild);
            }
        }

        // 資料區域
        let projects = [
            { id: 1, name: "籌料狀態數位化", department: "物管部 (王偉全、董光展)", startTime: "2025-08-19", dueDate: "2025-09-19", priority: "高", progress: 100, status: "已終止", notes: "", files: [], comments: [] },
            { id: 2, name: "客製化軍品 AI 瑕疵檢測", department: "品保部 (徐世勇)", startTime: "2025-09-02", dueDate: "2025-12-31", priority: "低", progress: 5, status: "規劃中", notes: "", files: [], comments: [] },
            { id: 3, name: "圖面繪製標準建議系統", department: "技術部 (林佳汝)", startTime: "unknown", dueDate: "unknown", priority: "低", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
            { id: 4, name: "ERP+RPA交期提醒工具", department: "生管部 (王偉全)", startTime: "unknown", dueDate: "unknown", priority: "低", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
            { id: 5, name: "地端GPT開發", department: "經企室 (Porter)", startTime: "2025-07-01", dueDate: "2026-6-30", priority: "高", progress: 15, status: "開發中", notes: "", files: [], comments: [] },
            { id: 6, name: "NFC工廠夜間巡檢", department: "管理部 (淑惠姊)", startTime: "2025-06-09", dueDate: "2025-10-01", priority: "高", progress: 80, status: "測試中", notes: "", files: [], comments: [] },
            { id: 7, name: "機台換刀預測系統", department: "加工部 (林昆弘)", startTime: "unknown", dueDate: "unknown", priority: "低", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
            { id: 8, name: "AI合約排程輔助建議", department: "軍品業務部 (許協理)", startTime: "unknown", dueDate: "unknown", priority: "中", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
            { id: 9, name: "AI Agent潛在客戶推播系統", department: "壓鑄業務部 (陳瑩盈)", startTime: "2025-07-30", dueDate: "2025-08-01", priority: "低", progress: 100, status: "已完成", notes: "", files: [], comments: [] },
            { id: 10, name: "資安Teams Bot建置", department: "資安小隊", startTime: "2025-05-30", dueDate: "2025-06-04", priority: "高", progress: 100, status: "已完成", notes: "", files: [], comments: [] },
            { id: 11, name: "會議記錄逐字稿及重點整理工具", department: "會議記錄人員(薪桉)", startTime: "2025-04-30", dueDate: "2025-05-26", priority: "高", progress: 100, status: "已完成", notes: "", files: [], comments: [] },
            { id: 12, name: "壓鑄機SCADA整合系統", department: "電控部(胡協理)", startTime: "2025-08-25", dueDate: "2026-05-31", priority: "中", progress: 5, status: "規劃中", notes: "", files: [], comments: [] },
            { id: 13, name: "壓鑄機射料曲線系統數據擷取分析", department: "電控部(胡協理)", startTime: "2025-08-25", dueDate: "2026-01-31", priority: "中", progress: 5, status: "規劃中", notes: "", files: [], comments: [] },
            { id: 14, name: "壓鑄機觸控型工業電腦", department: "電控部(胡協理)", startTime: "unknown", dueDate: "unknown", priority: "中", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
            { id: 15, name: "Dynabook-APS排程管理方案", department: "經企室(林佳賢)", startTime: "2025-07-29", dueDate: "unknown", priority: "中", progress: 5, status: "規劃中", notes: "", files: [], comments: [] },
            { id: 16, name: "Google AgentSpace(Simhope KM+EIP開發)", department: "經企室 (Porter)", startTime: "unknown", dueDate: "unknown", priority: "低", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
            { id: 17, name: "檢驗流程SOP呈現優化", department: "品保部 (薛瑞文)", startTime: "2025-09-03", dueDate: "unknown", priority: "低", progress: 5, status: "規劃中", notes: "", files: [], comments: [] },
            { id: 18, name: "MasterCAM外掛程式開發", department: "加工部 (林昆弘)", startTime: "2025-09-11", dueDate: "2025-09-25", priority: "高", progress: 20, status: "開發中", notes: "直接指派任務", files: [], comments: [] },
            { id: 19, name: "加工部日報表數位化", department: "加工部 (林昆弘)", startTime: "2025-09-11", dueDate: "2025-09-25", priority: "高", progress: 90, status: "測試中", notes: "直接指派任務", files: [], comments: [] },
            { id: 20, name: "發票識別申報覆核", department: "管理部 (蕭瑄萱)", startTime: "2025-09-25", dueDate: "2025-12-31", priority: "中", progress: 0, status: "構思中", notes: "", files: [], comments: [] },
        ];

        let routineTasks = {
            daily: [
                { time: "8:00~8:15", task: "清潔洗手台 & 泡茶" },
                { time: "13:00~13:30", task: "巡檢主辦公室 & 資訊辦公室 (各約15分鐘)" },
                { time: "16:45~17:00", task: "倒垃圾" },
            ],
            threeWeeks: [
                { time: "8:00~8:15", task: "掃地", lastDate: "2025-08-25"},
            ],
            monthly: [
                { day: 15, task: "技術部電腦巡檢 (若遇假日則調整)" },
                { task: "打掃廁所", dates: {} },
            ],
            bimonthly: [
                { task: "至餐廳備餐", dates: {} },
            ]
        };
        
        let sharingSessions = [
            { 
                id: Date.now() + 1,
                date: "2025-09-25", 
                theme: "LLM實戰分享會", 
                speaker: "我", 
                status: "upcoming", 
                schedule: [ 
                    "16:00-16:05 開場與介紹", 
                    "16:05-16:30 解決各部門提出的一項問題", 
                    "16:30-16:45 Q&A 與交流", 
                ]
            },
            { 
                id: Date.now() + 2,
                date: "2025-09-02", 
                theme: "AI應用分享-1", 
                speaker: "我", 
                status: "upcoming", 
                schedule: [
                    "11:30-11:50 AI時代的知識管理利器：Google NotebookLM",
                    "16:05-16:30 解決各部門提出的一項問題",
                    "16:30-16:45 Q&A 與交流",
                ]
            },
            // 過去的分享會保持原樣...
        ];
        
        let eventsAttended = [
            { 
                id: Date.now() + 100,
                eventName: "勞工安全教育訓練", 
                date: "2025-04-29", 
                summary: "114年度 勞工安全教育訓練。", 
                learnings: [
                    "工廠安全注意事項。",
                    "工業電腦 (IPC) 結合邊緣 AI 的解決方案。",
                ], 
                files: [], 
                type: "internal", 
            },
            // 其他活動保持原樣...
        ];
        
        let businessContacts = [
            { 
                id: Date.now() + 200,
                companyName: "超數科技HyperData", 
                contactPerson: "張鈞程", 
                date: "2025-07-07", 
                topic: "了解公司目前AI規劃應用與挑戰。", 
                files: []
            },
            // 其他聯絡保持原樣...
        ];

        // 全域變數
        let calendarDate = new Date();
        let currentProjectId = null;
        let currentRoutineTask = null;
        let currentSharingId = null;
        let currentEventId = null;
        let currentContactId = null;
        let editMode = false;

        // 全域錯誤處理
        window.addEventListener('error', (e) => {
            console.error('全域錯誤:', e.error);
            if (document.getElementById('sync-status')) {
                updateSyncStatus('發生錯誤', false);
            }
        });

        // 檢查資源加載
        window.addEventListener('load', () => {
            console.log('頁面已完全加載');
            if (!window.firebase) {
                console.warn('Firebase SDK 未加載，部分功能將不可用');
                if (document.getElementById('sync-status')) {
                    updateSyncStatus('離線模式 (Firebase 未加載)', false);
                }
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initFirebase();
                setupEventListeners();
                renderAllDashboards();

                // 延遲執行權限套用以確保 DOM 完全載入
                setTimeout(() => {
                    applyPermissions();
                }, 100);
            } catch (error) {
                console.error('初始化失敗:', error);
                updateSyncStatus('初始化失敗', false);
            }
        });

        function setupEventListeners() {
            // Tab 切換
            const tabs = document.querySelectorAll('.dashboard-tab');
            const contents = document.querySelectorAll('.dashboard-content');
            tabs.forEach(tab => tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.remove('hidden');
            }));

            // Modal 事件
            setupModalEvents();
        }

        function renderAllDashboards() {
            renderAiDashboard();
            renderRoutineDashboard();
            renderSharingDashboard();
            renderEventsDashboard();
            renderContactsDashboard();
        }

        // === Firebase 同步函數 ===
        function loadAllDataFromFirebase() {
            if (!isFirebaseInitialized) return;

            // 載入專案資料
            database.ref('projects').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    projects = Object.values(data).sort((a, b) => a.id - b.id);
                    renderAiDashboard();
                }
            });

            // 載入例行任務
            database.ref('routineTasks').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    routineTasks = data;
                    renderRoutineDashboard();
                }
            });

            // 載入分享會
            database.ref('sharingSessions').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    sharingSessions = Object.values(data);
                    renderSharingDashboard();
                }
            });

            // 載入活動
            database.ref('events').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    eventsAttended = Object.values(data);
                    renderEventsDashboard();
                }
            });

            // 載入企業接洽
            database.ref('contacts').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    businessContacts = Object.values(data);
                    renderContactsDashboard();
                }
            });
        }

        function syncToFirebase(path, data) {
            if (!isFirebaseInitialized) return;
            database.ref(path).set(data);
            updateSyncStatus('已同步', true);
        }

        // === 1. AI 專案儀表板 ===
        function renderAiDashboard() {
            const board = document.getElementById('ai-kanban-board');
            const summaryContainer = document.getElementById('ai-summary-stats');
            const monthFilter = document.getElementById('month-filter');

            if (!board || !summaryContainer || !monthFilter) {
                console.error('AI Dashboard 元素未找到');
                return;
            }

            // 填充月份篩選器
            const months = [...new Set(projects.map(p => p.startTime.substring(0, 7)))].sort().reverse();
            monthFilter.innerHTML = '<option value="all">所有月份</option>';
            months.forEach(m => {
                if (m !== 'unknow' && m !== 'unknown') {
                    monthFilter.innerHTML += `<option value="${m}">${m}</option>`;
                }
            });
            
            monthFilter.onchange = () => displayProjects();
            displayProjects();

            function displayProjects() {
                const selectedMonth = monthFilter.value;
                const filteredProjects = selectedMonth === 'all' ? projects : projects.filter(p => p.startTime.startsWith(selectedMonth));
                
                board.innerHTML = '';
                summaryContainer.innerHTML = '';

                const statuses = ["構思中", "規劃中", "開發中", "測試中", "已終止", "已完成"];
                const priorityColors = { '高': 'bg-red-100 text-red-800', '中': 'bg-yellow-100 text-yellow-800', '低': 'bg-green-100 text-green-800' };
                const columnHeaderColors = { "構思中": "bg-purple-500", "規劃中": "bg-blue-500", "開發中": "bg-orange-500", "測試中": "bg-teal-500", "已終止": "bg-red-500", "已完成": "bg-green-600" };

                statuses.forEach(status => {
                    const column = document.createElement('div');
                    column.className = 'bg-gray-100 rounded-lg flex flex-col h-full';
                    const projectsInStatus = filteredProjects.filter(p => p.status === status);
                    
                    column.innerHTML = `
                        <div class="p-4 rounded-t-lg ${columnHeaderColors[status]} text-white flex justify-between items-center">
                            <h2 class="font-bold text-lg">${status}</h2>
                            <span class="bg-white/30 text-white text-sm font-semibold rounded-full px-2 py-0.5">${projectsInStatus.length}</span>
                        </div>
                        <div class="kanban-column-content p-4 space-y-4 overflow-y-auto flex-grow" style="min-height: 400px;"></div>
                    `;
                    
                    projectsInStatus.forEach(project => {
                        const card = document.createElement('div');
                        const borderColor = { '高': 'border-red-500', '中': 'border-yellow-500', '低': 'border-green-500' }[project.priority] || 'border-gray-300';
                        card.className = `bg-white p-4 rounded-lg shadow-md border-l-4 ${borderColor} project-card`;
                        
                        const commentCount = project.comments ? project.comments.length : 0;
                        const commentBadge = commentCount > 0 ? `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full"><i class="fas fa-comment mr-1"></i>${commentCount}</span>` : '';
                        
                        card.innerHTML = `
                            <h3 class="font-bold text-gray-800">${project.name}</h3>
                            <p class="text-sm text-gray-500 mt-1">${project.department}</p>
                            <div class="text-xs text-gray-400 mt-2">
                                <span>始: ${project.startTime}</span> | <span>終: ${project.dueDate}</span>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                ${commentBadge}
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${priorityColors[project.priority]}">${project.priority}</span>
                            </div>
                            <div class="mt-2">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-medium text-gray-700">進度</span>
                                    <span class="text-sm font-medium text-gray-700">${project.progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${project.progress}%"></div>
                                </div>
                            </div>
                        `;
                        
                        card.addEventListener('click', () => openProjectModal(project));
                        column.querySelector('.kanban-column-content').appendChild(card);
                    });
                    
                    board.appendChild(column);
                });

                // 統計資料
                const total = filteredProjects.length;
                const completed = filteredProjects.filter(p => p.status === '已完成').length;
                const inProgress = filteredProjects.filter(p => ['開發中', '測試中'].includes(p.status)).length;
                const planning = filteredProjects.filter(p => ['構思中', '規劃中'].includes(p.status)).length;
                const shutdown = filteredProjects.filter(p => ['已終止'].includes(p.status)).length;
                [
                    { label: '總專案數', value: total, color: 'bg-blue-100 text-blue-800' },
                    { label: '進行中', value: inProgress, color: 'bg-orange-100 text-orange-800' },
                    { label: '規劃/構思中', value: planning, color: 'bg-purple-100 text-purple-800' },
                    { label: '已終止', value: shutdown, color: 'bg-red-100 text-red-800' },
                    { label: '已完成', value: completed, color: 'bg-green-100 text-green-800' }
                ].forEach(stat => {
                    const statCard = document.createElement('div');
                    statCard.className = `p-4 rounded-lg shadow ${stat.color}`;
                    statCard.innerHTML = `
                        <div class="text-2xl font-bold">${stat.value}</div>
                        <div class="text-sm font-medium">${stat.label}</div>
                    `;
                    summaryContainer.appendChild(statCard);
                });
            }
        }

        // 專案相關函數
        function showAddProjectModal() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProjectModal() {
            document.getElementById('add-project-modal').classList.remove('show');
        }

        function addNewProject() {
            const newProject = {
                id: Date.now(),
                name: document.getElementById('new-project-name').value,
                department: document.getElementById('new-project-department').value,
                startTime: document.getElementById('new-project-start').value || 'unknown',
                dueDate: document.getElementById('new-project-due').value || 'unknown',
                priority: document.getElementById('new-project-priority').value,
                status: document.getElementById('new-project-status').value,
                progress: 0,
                notes: "",
                files: [],
                comments: []
            };

            if (!newProject.name || !newProject.department) {
                alert('請填寫專案名稱和負責部門');
                return;
            }

            projects.push(newProject);
            syncToFirebase('projects/' + newProject.id, newProject);
            
            closeAddProjectModal();
            renderAiDashboard();
            
            // 清空表單
            document.getElementById('new-project-name').value = '';
            document.getElementById('new-project-department').value = '';
            document.getElementById('new-project-start').value = '';
            document.getElementById('new-project-due').value = '';
        }

        function openProjectModal(project) {
            currentProjectId = project.id;
            editMode = false;

            // 顯示檢視模式，隱藏編輯模式
            document.getElementById('project-info-view').classList.remove('hidden');
            document.getElementById('project-info-edit').classList.add('hidden');
            document.getElementById('toggle-edit-mode').textContent = '編輯專案資訊';

            // 填充資料
            document.getElementById('modal-project-name').textContent = project.name;
            document.getElementById('modal-project-department').textContent = project.department;
            document.getElementById('modal-start-date').textContent = project.startTime;
            document.getElementById('modal-due-date').textContent = project.dueDate;
            document.getElementById('modal-priority').textContent = project.priority;
            document.getElementById('modal-status').textContent = project.status;
            document.getElementById('modal-progress-text').textContent = `${project.progress}%`;
            document.getElementById('modal-progress-bar').style.width = `${project.progress}%`;

            // 備註
            document.getElementById('project-notes').value = project.notes || '';

            // 評論
            renderComments(project.comments || []);

            // 檔案
            renderFilesList(project.files || []);

            document.getElementById('project-modal').classList.add('show');
        }

        function toggleEditMode() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            editMode = !editMode;

            if (editMode) {
                // 進入編輯模式
                document.getElementById('project-info-view').classList.add('hidden');
                document.getElementById('project-info-edit').classList.remove('hidden');
                document.getElementById('toggle-edit-mode').textContent = '取消編輯';

                // 填充編輯表單
                document.getElementById('edit-project-name').value = project.name;
                document.getElementById('edit-department').value = project.department;
                document.getElementById('edit-start-date').value = project.startTime !== 'unknown' ? project.startTime : '';
                document.getElementById('edit-due-date').value = project.dueDate !== 'unknown' ? project.dueDate : '';
                document.getElementById('edit-priority').value = project.priority;
                document.getElementById('edit-status').value = project.status;
                document.getElementById('edit-progress').value = project.progress;
            } else {
                // 退出編輯模式
                document.getElementById('project-info-view').classList.remove('hidden');
                document.getElementById('project-info-edit').classList.add('hidden');
                document.getElementById('toggle-edit-mode').textContent = '編輯專案資訊';
            }
        }

        function saveProjectEdit() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                console.error('找不到專案');
                return;
            }

            // 檢查所有編輯欄位是否存在
            const nameField = document.getElementById('edit-project-name');
            const deptField = document.getElementById('edit-department');
            const startField = document.getElementById('edit-start-date');
            const dueField = document.getElementById('edit-due-date');
            const priorityField = document.getElementById('edit-priority');
            const statusField = document.getElementById('edit-status');
            const progressField = document.getElementById('edit-progress');

            if (!nameField || !deptField || !priorityField || !statusField || !progressField) {
                console.error('編輯欄位不存在');
                alert('編輯欄位載入錯誤，請重新開啟專案');
                return;
            }

            // 更新專案資料
            project.name = nameField.value;
            project.department = deptField.value;
            project.startTime = startField?.value || 'unknown';
            project.dueDate = dueField?.value || 'unknown';
            project.priority = priorityField.value;
            project.status = statusField.value;
            project.progress = parseInt(progressField.value) || 0;

            // 同步到Firebase
            syncToFirebase('projects/' + project.id, project);

            // 切換回檢視模式
            editMode = false;

            // 更新顯示
            openProjectModal(project);
            renderAiDashboard();

            console.log('專案已更新:', project);
            alert('專案資訊已儲存');
        }

        function deleteProject() {
            if (isReadOnly) {
                alert('主管角色無法刪除專案');
                return;
            }
            if (!currentProjectId) return;

            if (!confirm('確定要刪除此專案嗎？此操作無法復原。')) return;

            const index = projects.findIndex(p => p.id === currentProjectId);
            if (index > -1) {
                projects.splice(index, 1);
                if (isFirebaseInitialized) {
                    database.ref('projects/' + currentProjectId).remove();
                }
            }

            closeProjectModal();
            renderAiDashboard();
        }

        function saveNotes() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                console.error('找不到專案');
                alert('找不到專案，請重新開啟');
                return;
            }

            const notesField = document.getElementById('project-notes');
            if (!notesField) {
                console.error('找不到說明欄位');
                alert('說明欄位載入錯誤');
                return;
            }

            // 更新專案說明
            project.notes = notesField.value;

            // 同步到Firebase (同步整個專案以確保一致性)
            syncToFirebase('projects/' + project.id, project);

            console.log('說明已儲存:', project.notes);
            alert('專案說明已儲存');
        }

        function addComment() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const text = document.getElementById('new-comment').value.trim();
            if (!text) {
                alert('請輸入評論內容');
                return;
            }

            if (!project.comments) project.comments = [];

            const comment = {
                id: Date.now(),
                author: document.getElementById('comment-author').value,
                text: text,
                timestamp: new Date().toISOString()
            };

            project.comments.push(comment);
            syncToFirebase('projects/' + project.id + '/comments', project.comments);

            document.getElementById('new-comment').value = '';
            renderComments(project.comments);
        }

        function renderComments(comments) {
            const list = document.getElementById('comments-list');

            if (!comments || comments.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 text-center">尚無評論</p>';
                return;
            }

            list.innerHTML = comments.map(comment => {
                const date = new Date(comment.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isManager = comment.author === '主管';

                return `
                    <div class="comment-bubble ${isManager ? 'manager' : ''}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm ${isManager ? 'text-red-800' : 'text-gray-800'}">
                                <i class="fas fa-user-circle mr-1"></i>${comment.author}
                            </span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <p class="text-gray-700">${comment.text}</p>
                    </div>
                `;
            }).join('');
        }

        function renderFilesList(files) {
            const list = document.getElementById('files-list');
            
            if (!files || files.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400">尚未上傳檔案</p>';
                return;
            }

            list.innerHTML = files.map((file, idx) => `
                <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-3 py-2">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-gray-400"></i>
                        <span class="text-sm text-gray-700 break-all">${file.name}</span>
                        ${file.size ? `<span class="text-xs text-gray-400">(${formatSize(file.size)})</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        ${file.url ? `<a href="${file.url}" target="_blank" class="text-blue-600 text-sm hover:underline">下載</a>` : ''}
                        <button onclick="deleteFileAt(${idx})" class="text-red-600 text-sm">刪除</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteFileAt(index) {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project || !project.files) return;

            const file = project.files[index];
            
            if (isFirebaseInitialized && file.url) {
                storage.refFromURL(file.url).delete().catch(err => console.error('刪除檔案失敗:', err));
            }

            project.files.splice(index, 1);
            syncToFirebase('projects/' + project.id + '/files', project.files);
            renderFilesList(project.files);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes/1024).toFixed(1)} KB`;
            return `${(bytes/1024/1024).toFixed(1)} MB`;
        }

        function exportCurrentProject() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                console.error('找不到專案');
                alert('找不到專案，請重新開啟');
                return;
            }

            try {
                // 準備匯出資料
                const exportData = {
                    ...project,
                    exportTime: new Date().toISOString(),
                    exportBy: '系統管理員'
                };

                // 創建JSON內容
                const jsonContent = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // 創建下載連結
                const a = document.createElement('a');
                a.href = url;
                a.download = `${project.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}-專案詳情-${new Date().toISOString().slice(0, 10)}.json`;

                // 執行下載
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // 清理URL
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log('專案已匯出:', project.name);
                alert('專案匯出成功！');

            } catch (error) {
                console.error('匯出失敗:', error);
                alert('匯出失敗，請稍後再試');
            }
        }

        function closeProjectModal() {
            document.getElementById('project-modal').classList.remove('show');
            currentProjectId = null;
        }

        // === 2. 例行公事儀表板 ===
        function renderRoutineDashboard() {
            const container = document.getElementById('routine-tasks-content');
            if (!container) {
                console.error('例行公事容器未找到');
                return;
            }
            container.innerHTML = '';

            const today = new Date();
            const dayOfWeek = today.getDay();
            let todayTasksHtml = '';

            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                routineTasks.daily.forEach(t => {
                    todayTasksHtml += `
                        <div class="flex justify-between items-center py-2 border-b border-blue-100 last:border-b-0">
                            <span class="text-blue-800 font-medium">${t.task}</span>
                            <span class="text-blue-600 text-sm">${t.time}</span>
                        </div>
                    `;
                });
            } else {
                todayTasksHtml = '<p class="text-blue-600">今日為假日，無例行公事。</p>';
            }

            const taskSections = [
                { title: '每日任務 (週一至週五)', tasks: routineTasks.daily, icon: 'fa-calendar-day', color: 'blue', type: 'daily' },
                { title: '三週一次', tasks: routineTasks.threeWeeks, icon: 'fa-calendar-week', color: 'green', type: 'threeWeeks' },
                { title: '每月任務', tasks: routineTasks.monthly, icon: 'fa-calendar-alt', color: 'purple', type: 'monthly' },
                { title: '雙月任務', tasks: routineTasks.bimonthly, icon: 'fa-calendar', color: 'orange', type: 'bimonthly' }
            ];

            const taskSectionsHtml = taskSections.map(section => {
                const tasksHtml = section.tasks.map((t, index) => {
                    let display = '';
                    if (t.time) display = `<span class="text-${section.color}-600 text-sm">${t.time}</span>`;
                    if (t.day) display = `<span class="text-${section.color}-600 text-sm">每月${t.day}日</span>`;

                    let dateButton = '';
                    if ((section.type === 'monthly' && !t.day) || section.type === 'bimonthly') {
                        const currentMonth = new Date().toISOString().substring(0, 7);
                        const dateDisplay = t.dates && t.dates[currentMonth]
                            ? `<span class="text-sm text-${section.color}-700">本月: ${t.dates[currentMonth]}</span>`
                            : `<span class="text-sm text-gray-500">本月未設定</span>`;

                        dateButton = `
                            <div class="flex items-center space-x-2">
                                ${dateDisplay}
                                <button onclick="openRoutineDateModal('${section.type}', ${index})" 
                                        class="text-${section.color}-600 hover:text-${section.color}-800 text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        `;
                    }

                    return `
                        <div class="flex justify-between items-center py-2 border-b border-${section.color}-100 last:border-b-0">
                            <span class="text-${section.color}-800">${t.task}</span>
                            <div class="flex items-center space-x-2">
                                ${display}
                                ${dateButton}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-${section.color}-50 p-4 rounded-lg border border-${section.color}-200">
                        <h3 class="flex items-center text-lg font-bold text-${section.color}-800 mb-3">
                            <i class="fas ${section.icon} mr-2"></i>${section.title}
                        </h3>
                        <div class="space-y-2">${tasksHtml}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                    <h2 class="text-xl font-bold text-blue-800 mb-2">今日待辦</h2>
                    <div class="space-y-2">${todayTasksHtml}</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">${taskSectionsHtml}</div>
            `;

            renderCalendar();
        }

        function renderCalendar() {
            const header = document.getElementById('calendar-header');
            const body = document.getElementById('calendar-body');
            
            header.innerHTML = `
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-bold text-gray-800 w-32 text-center">${calendarDate.getFullYear()} / ${String(calendarDate.getMonth() + 1).padStart(2, '0')}</h2>
                    <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="text-sm text-gray-500">顯示所有例行任務</div>
            `;

            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            let calendarHtml = `
                <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
                    ${['日', '一', '二', '三', '四', '五', '六'].map(d => 
                        `<div class="text-center font-semibold py-2 bg-gray-100">${d}</div>`
                    ).join('')}
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
            `;

            for (let i = 0; i < startDayOfWeek; i++) {
                calendarHtml += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let tasksHtml = '';

                // 每日任務
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    routineTasks.daily.forEach(t => {
                        const shortTask = t.task.length > 15 ? t.task.substring(0, 12) + '...' : t.task;
                        tasksHtml += `<div class="calendar-task bg-blue-100 text-blue-800">${shortTask}</div>`;
                    });
                }

                // 每月任務
                if (day === 15) {
                    const monthlyTask = routineTasks.monthly.find(t => t.day === 15);
                    if (monthlyTask) {
                        const shortTask = monthlyTask.task.length > 15 ? monthlyTask.task.substring(0, 12) + '...' : monthlyTask.task;
                        tasksHtml += `<div class="calendar-task bg-green-100 text-green-800">${shortTask}</div>`;
                    }
                }

                // 手動設定的任務
                routineTasks.monthly.forEach(task => {
                    if (task.dates && task.dates[currentMonthStr] === dateStr) {
                        tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${task.task}</div>`;
                    }
                });

                routineTasks.bimonthly.forEach(task => {
                    if (task.dates && task.dates[currentMonthStr] === dateStr) {
                        tasksHtml += `<div class="calendar-task bg-orange-100 text-orange-800">${task.task}</div>`;
                    }
                });

                const isToday = new Date().toDateString() === currentDate.toDateString() ? 'bg-blue-100' : 'bg-white';
                calendarHtml += `
                    <div class="calendar-day p-2 ${isToday}">
                        <div class="font-semibold text-right">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }

            calendarHtml += `</div>`;
            body.innerHTML = calendarHtml;
        }

        function changeMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            renderCalendar();
        }

        function showAddRoutineModal() {
            document.getElementById('add-routine-modal').classList.add('show');
        }

        function closeAddRoutineModal() {
            document.getElementById('add-routine-modal').classList.remove('show');
        }

        function updateRoutineFields() {
            const type = document.getElementById('new-routine-type').value;
            const timeField = document.getElementById('routine-time-field');
            const dayField = document.getElementById('routine-day-field');

            if (type === 'monthly') {
                timeField.classList.add('hidden');
                dayField.classList.remove('hidden');
            } else if (type === 'bimonthly') {
                timeField.classList.add('hidden');
                dayField.classList.add('hidden');
            } else {
                timeField.classList.remove('hidden');
                dayField.classList.add('hidden');
            }
        }

        function addNewRoutine() {
            const type = document.getElementById('new-routine-type').value;
            const task = document.getElementById('new-routine-task').value;

            if (!task) {
                alert('請輸入任務名稱');
                return;
            }

            const newTask = { task };

            if (type === 'daily' || type === 'threeWeeks') {
                newTask.time = document.getElementById('new-routine-time').value;
            } else if (type === 'monthly') {
                const day = document.getElementById('new-routine-day').value;
                if (day) newTask.day = parseInt(day);
                else newTask.dates = {};
            } else if (type === 'bimonthly') {
                newTask.dates = {};
            }

            if (!routineTasks[type]) routineTasks[type] = [];
            routineTasks[type].push(newTask);

            syncToFirebase('routineTasks', routineTasks);
            closeAddRoutineModal();
            renderRoutineDashboard();

            // 清空表單
            document.getElementById('new-routine-task').value = '';
            document.getElementById('new-routine-time').value = '';
            document.getElementById('new-routine-day').value = '';
        }

        function openRoutineDateModal(type, index) {
            const task = routineTasks[type][index];
            currentRoutineTask = { type, index };

            document.getElementById('routine-task-name').value = task.task;
            document.getElementById('routine-task-date').value = '';
            document.getElementById('routine-date-modal').classList.add('show');
        }

        function closeRoutineModal() {
            document.getElementById('routine-date-modal').classList.remove('show');
            currentRoutineTask = null;
        }

        function saveRoutineDate() {
            if (!currentRoutineTask) return;

            const date = document.getElementById('routine-task-date').value;
            if (!date) {
                alert('請選擇日期');
                return;
            }

            const task = routineTasks[currentRoutineTask.type][currentRoutineTask.index];
            const month = date.substring(0, 7);

            if (!task.dates) task.dates = {};
            task.dates[month] = date;

            syncToFirebase('routineTasks', routineTasks);
            closeRoutineModal();
            renderRoutineDashboard();
        }

        // === 3. 分享會儀表板 ===
        function renderSharingDashboard() {
            const container = document.getElementById('sharing-session-content');
            
            const upcoming = sharingSessions.filter(s => s.status === 'upcoming');
            const past = sharingSessions.filter(s => s.status === 'past');

            let upcomingHtml = upcoming.length > 0 ? upcoming.map(s => {
                const scheduleHtml = s.schedule.map(item => `<li class="text-gray-600">${item}</li>`).join('');
                return `
                    <div class="bg-green-50 border border-green-200 p-6 rounded-lg mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-green-800">${s.theme}</h3>
                                <p class="text-green-600 mt-1">日期：${s.date} | 講者：${s.speaker}</p>
                            </div>
                            <div class="space-x-2">
                                <button onclick="editSharing(${s.id})" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSharing(${s.id})" class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">議程安排：</h4>
                            <ul class="list-disc list-inside space-y-1">${scheduleHtml}</ul>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500">目前沒有已排程的分享會。</p>';

            const pastHtml = past.map(s => {
                const content = s.schedule.map(item => {
                    if (item.startsWith('http')) {
                        return `<li><a href="${item}" target="_blank" class="text-blue-600 hover:underline break-all">
                            <i class="fas fa-link mr-2"></i>連結</a></li>`;
                    }
                    if (/\.(pdf|pptx|zip|jpg)/i.test(item)) {
                        return `<li><i class="fas fa-file mr-2 text-gray-400"></i>${item}</li>`;
                    }
                    return `<li>${item}</li>`;
                }).join('');

                return `
                    <details class="p-4 border-b last:border-b-0">
                        <summary class="flex justify-between items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <div>
                                <p class="text-sm text-gray-500">${s.date}</p>
                                <p class="font-semibold text-gray-700">${s.theme}</p>
                            </div>
                            <i class="fas fa-chevron-right summary-icon text-gray-400"></i>
                        </summary>
                        <div class="mt-4 pl-4 border-l-2 border-gray-200">
                            <ul class="list-disc list-inside space-y-1 text-gray-600">${content}</ul>
                        </div>
                    </details>
                `;
            }).join('');

            container.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4">即將舉行的分享會</h2>
                ${upcomingHtml}
                <h2 class="text-xl font-bold text-gray-800 mt-10 mb-4">過往分享會紀錄</h2>
                <div class="border rounded-lg bg-gray-50">${pastHtml}</div>
            `;
        }

        function showAddSharingModal() {
            document.getElementById('add-sharing-modal').classList.add('show');
        }

        function closeAddSharingModal() {
            document.getElementById('add-sharing-modal').classList.remove('show');
        }

        function addNewSharing() {
            const schedule = document.getElementById('new-sharing-schedule').value.split('\n').filter(s => s.trim());
            
            const newSharing = {
                id: Date.now(),
                date: document.getElementById('new-sharing-date').value,
                theme: document.getElementById('new-sharing-theme').value,
                speaker: document.getElementById('new-sharing-speaker').value,
                status: 'upcoming',
                schedule: schedule
            };

            if (!newSharing.date || !newSharing.theme || !newSharing.speaker) {
                alert('請填寫所有必填欄位');
                return;
            }

            sharingSessions.push(newSharing);
            // 同步整個 sharingSessions 陣列以避免覆蓋問題
            syncToFirebase('sharingSessions', sharingSessions);
            
            closeAddSharingModal();
            renderSharingDashboard();
            
            // 清空表單
            document.getElementById('new-sharing-date').value = '';
            document.getElementById('new-sharing-theme').value = '';
            document.getElementById('new-sharing-speaker').value = '';
            document.getElementById('new-sharing-schedule').value = '';
        }

        function deleteSharing(id) {
            if (isReadOnly) {
                alert('主管角色無法刪除分享會');
                return;
            }
            if (!confirm('確定要刪除此分享會嗎？')) return;
            
            const index = sharingSessions.findIndex(s => s.id === id);
            if (index > -1) {
                sharingSessions.splice(index, 1);
                // 同步整個 sharingSessions 陣列以避免覆蓋問題
                syncToFirebase('sharingSessions', sharingSessions);
            }
            renderSharingDashboard();
        }

        function editSharing(id) {
            if (isReadOnly) {
                alert('主管角色無法編輯分享會');
                return;
            }

            const sharing = sharingSessions.find(s => s.id === id);
            if (!sharing) {
                alert('找不到該分享會');
                return;
            }

            currentSharingId = id;

            // 填充表單
            document.getElementById('edit-sharing-date').value = sharing.date;
            document.getElementById('edit-sharing-theme').value = sharing.theme;
            document.getElementById('edit-sharing-speaker').value = sharing.speaker;
            document.getElementById('edit-sharing-status').value = sharing.status;
            document.getElementById('edit-sharing-schedule').value = sharing.schedule.join('\n');

            // 顯示模態框
            document.getElementById('edit-sharing-modal').classList.add('show');
        }

        function closeEditSharingModal() {
            document.getElementById('edit-sharing-modal').classList.remove('show');
            currentSharingId = null;
        }

        function saveEditSharing() {
            if (!currentSharingId) return;

            const sharing = sharingSessions.find(s => s.id === currentSharingId);
            if (!sharing) {
                alert('找不到該分享會');
                return;
            }

            const schedule = document.getElementById('edit-sharing-schedule').value.split('\n').filter(s => s.trim());

            sharing.date = document.getElementById('edit-sharing-date').value;
            sharing.theme = document.getElementById('edit-sharing-theme').value;
            sharing.speaker = document.getElementById('edit-sharing-speaker').value;
            sharing.status = document.getElementById('edit-sharing-status').value;
            sharing.schedule = schedule;

            if (!sharing.date || !sharing.theme || !sharing.speaker) {
                alert('請填寫所有必填欄位');
                return;
            }

            syncToFirebase('sharingSessions', sharingSessions);
            closeEditSharingModal();
            renderSharingDashboard();
            alert('分享會已更新');
        }

        // === 4. 活動參與儀表板 ===
        function renderEventsDashboard(filteredEvents = null) {
            const container = document.getElementById('event-participation-content');

            const events = filteredEvents || eventsAttended;

            const internalEvents = events.filter(e => e.type === 'internal');
            const externalEvents = events.filter(e => e.type === 'external');

            const renderEventSection = (title, events) => {
                if (events.length === 0) return '';

                const eventsHtml = events.map(event => {
                    const learningsHtml = event.learnings.map(learning => `<li class="text-gray-600">${learning}</li>`).join('');
                    const filesHtml = event.files ? event.files.map(file => {
                        if (file.link === '#' || !file.link) {
                            return `<span class="inline-block bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm mr-2 mb-2">
                                <i class="fas fa-file mr-1"></i>${file.name}
                            </span>`;
                        } else {
                            return `<a href="${file.link}" target="_blank" class="inline-block bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1 rounded-full text-sm mr-2 mb-2 transition-colors">
                                <i class="fas fa-download mr-1"></i>${file.name}
                            </a>`;
                        }
                    }).join('') : '';

                    return `
                        <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${event.eventName}</h3>
                                    <p class="text-gray-500 mt-1">${event.date}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="bg-${event.type === 'external' ? 'blue' : 'green'}-100 text-${event.type === 'external' ? 'blue' : 'green'}-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${event.type === 'external' ? '外部活動' : '內部活動'}
                                    </span>
                                    <button onclick="editEvent(${event.id})" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteEvent(${event.id})" class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">活動概述：</h4>
                                <p class="text-gray-600">${event.summary}</p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">主要學習與收穫：</h4>
                                <ul class="list-disc list-inside space-y-1">${learningsHtml}</ul>
                            </div>
                            ${event.files && event.files.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">相關資料：</h4>
                                <div class="flex flex-wrap">${filesHtml}</div>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');

                return `
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-gray-200">${title}</h2>
                        <div class="space-y-6">${eventsHtml}</div>
                    </section>
                `;
            };

            container.innerHTML = renderEventSection('外部活動', externalEvents) + renderEventSection('內部活動', internalEvents);
        }

        function showAddEventModal() {
            document.getElementById('add-event-modal').classList.add('show');
        }

        function closeAddEventModal() {
            document.getElementById('add-event-modal').classList.remove('show');
        }

        function addNewEvent() {
            const learnings = document.getElementById('new-event-learnings').value.split('\n').filter(l => l.trim());
            
            const newEvent = {
                id: Date.now(),
                eventName: document.getElementById('new-event-name').value,
                date: document.getElementById('new-event-date').value,
                type: document.getElementById('new-event-type').value,
                summary: document.getElementById('new-event-summary').value,
                learnings: learnings,
                files: []
            };

            if (!newEvent.eventName || !newEvent.date || !newEvent.summary) {
                alert('請填寫所有必填欄位');
                return;
            }

            eventsAttended.push(newEvent);
            // 同步整個 events 陣列以避免覆蓋問題
            syncToFirebase('events', eventsAttended);
            
            closeAddEventModal();
            renderEventsDashboard();
            
            // 清空表單
            document.getElementById('new-event-name').value = '';
            document.getElementById('new-event-date').value = '';
            document.getElementById('new-event-summary').value = '';
            document.getElementById('new-event-learnings').value = '';
        }

        function deleteEvent(id) {
            if (isReadOnly) {
                alert('主管角色無法刪除活動紀錄');
                return;
            }
            if (!confirm('確定要刪除此活動紀錄嗎？')) return;

            const index = eventsAttended.findIndex(e => e.id === id);
            if (index > -1) {
                eventsAttended.splice(index, 1);
                // 同步整個 events 陣列以避免覆蓋問題
                syncToFirebase('events', eventsAttended);
            }
            renderEventsDashboard();
        }

        function editEvent(id) {
            if (isReadOnly) {
                alert('主管角色無法編輯活動');
                return;
            }

            const event = eventsAttended.find(e => e.id === id);
            if (!event) {
                alert('找不到該活動');
                return;
            }

            currentEventId = id;

            // 填充表單
            document.getElementById('edit-event-name').value = event.eventName;
            document.getElementById('edit-event-date').value = event.date;
            document.getElementById('edit-event-type').value = event.type;
            document.getElementById('edit-event-summary').value = event.summary;
            document.getElementById('edit-event-learnings').value = event.learnings.join('\n');

            // 顯示模態框
            document.getElementById('edit-event-modal').classList.add('show');
        }

        function closeEditEventModal() {
            document.getElementById('edit-event-modal').classList.remove('show');
            currentEventId = null;
        }

        function saveEditEvent() {
            if (!currentEventId) return;

            const event = eventsAttended.find(e => e.id === currentEventId);
            if (!event) {
                alert('找不到該活動');
                return;
            }

            const learnings = document.getElementById('edit-event-learnings').value.split('\n').filter(l => l.trim());

            event.eventName = document.getElementById('edit-event-name').value;
            event.date = document.getElementById('edit-event-date').value;
            event.type = document.getElementById('edit-event-type').value;
            event.summary = document.getElementById('edit-event-summary').value;
            event.learnings = learnings;

            if (!event.eventName || !event.date || !event.summary) {
                alert('請填寫所有必填欄位');
                return;
            }

            syncToFirebase('events', eventsAttended);
            closeEditEventModal();
            renderEventsDashboard();
            alert('活動已更新');
        }

        function filterEvents() {
            const searchTerm = document.getElementById('event-search').value.toLowerCase();
            const typeFilter = document.getElementById('event-type-filter').value;

            let filtered = eventsAttended;

            // 類型篩選
            if (typeFilter !== 'all') {
                filtered = filtered.filter(e => e.type === typeFilter);
            }

            // 搜尋篩選
            if (searchTerm) {
                filtered = filtered.filter(e =>
                    e.eventName.toLowerCase().includes(searchTerm) ||
                    e.summary.toLowerCase().includes(searchTerm) ||
                    e.learnings.some(l => l.toLowerCase().includes(searchTerm))
                );
            }

            renderEventsDashboard(filtered);
        }

        // === 5. 接洽企業儀表板 ===
        function renderContactsDashboard(filteredContacts = null) {
            const container = document.getElementById('business-contacts-content');

            const contacts = filteredContacts || businessContacts;

            const tableRows = contacts.map(contact => {
                const filesHtml = contact.files && contact.files.length > 0 ? contact.files.map(file => {
                    if (file.link === '#' || !file.link) {
                        return `<span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs mr-1 mb-1">
                            <i class="fas fa-file mr-1"></i>${file.name}
                        </span>`;
                    } else {
                        return `<a href="${file.link}" target="_blank" class="inline-block bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded text-xs mr-1 mb-1 transition-colors">
                            <i class="fas fa-download mr-1"></i>${file.name}
                        </a>`;
                    }
                }).join('') : '<span class="text-sm text-gray-400">無</span>';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${contact.companyName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${contact.contactPerson}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${contact.date}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 max-w-xs">${contact.topic}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap">${filesHtml}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <button onclick="editContact(${contact.id})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteContact(${contact.id})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">企業名稱</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">聯絡人</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">接洽日期</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">洽談主題</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">相關資料</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAddContactModal() {
            document.getElementById('add-contact-modal').classList.add('show');
        }

        function closeAddContactModal() {
            document.getElementById('add-contact-modal').classList.remove('show');
        }

        function addNewContact() {
            const newContact = {
                id: Date.now(),
                companyName: document.getElementById('new-contact-company').value,
                contactPerson: document.getElementById('new-contact-person').value,
                date: document.getElementById('new-contact-date').value,
                topic: document.getElementById('new-contact-topic').value,
                files: []
            };

            if (!newContact.companyName || !newContact.contactPerson || !newContact.date || !newContact.topic) {
                alert('請填寫所有欄位');
                return;
            }

            businessContacts.push(newContact);
            // 同步整個 contacts 陣列以避免覆蓋問題
            syncToFirebase('contacts', businessContacts);
            
            closeAddContactModal();
            renderContactsDashboard();
            
            // 清空表單
            document.getElementById('new-contact-company').value = '';
            document.getElementById('new-contact-person').value = '';
            document.getElementById('new-contact-date').value = '';
            document.getElementById('new-contact-topic').value = '';
        }

        function deleteContact(id) {
            if (isReadOnly) {
                alert('主管角色無法刪除接洽紀錄');
                return;
            }
            if (!confirm('確定要刪除此接洽紀錄嗎？')) return;

            const index = businessContacts.findIndex(c => c.id === id);
            if (index > -1) {
                businessContacts.splice(index, 1);
                // 同步整個 contacts 陣列以避免覆蓋問題
                syncToFirebase('contacts', businessContacts);
            }
            renderContactsDashboard();
        }

        function editContact(id) {
            if (isReadOnly) {
                alert('主管角色無法編輯接洽紀錄');
                return;
            }

            const contact = businessContacts.find(c => c.id === id);
            if (!contact) {
                alert('找不到該接洽紀錄');
                return;
            }

            currentContactId = id;

            // 填充表單
            document.getElementById('edit-contact-company').value = contact.companyName;
            document.getElementById('edit-contact-person').value = contact.contactPerson;
            document.getElementById('edit-contact-date').value = contact.date;
            document.getElementById('edit-contact-topic').value = contact.topic;

            // 顯示模態框
            document.getElementById('edit-contact-modal').classList.add('show');
        }

        function closeEditContactModal() {
            document.getElementById('edit-contact-modal').classList.remove('show');
            currentContactId = null;
        }

        function saveEditContact() {
            if (!currentContactId) return;

            const contact = businessContacts.find(c => c.id === currentContactId);
            if (!contact) {
                alert('找不到該接洽紀錄');
                return;
            }

            contact.companyName = document.getElementById('edit-contact-company').value;
            contact.contactPerson = document.getElementById('edit-contact-person').value;
            contact.date = document.getElementById('edit-contact-date').value;
            contact.topic = document.getElementById('edit-contact-topic').value;

            if (!contact.companyName || !contact.contactPerson || !contact.date || !contact.topic) {
                alert('請填寫所有欄位');
                return;
            }

            syncToFirebase('contacts', businessContacts);
            closeEditContactModal();
            renderContactsDashboard();
            alert('接洽紀錄已更新');
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contact-search').value.toLowerCase();

            if (!searchTerm) {
                renderContactsDashboard();
                return;
            }

            const filtered = businessContacts.filter(c =>
                c.companyName.toLowerCase().includes(searchTerm) ||
                c.contactPerson.toLowerCase().includes(searchTerm) ||
                c.topic.toLowerCase().includes(searchTerm)
            );

            renderContactsDashboard(filtered);
        }

        // === 檔案上傳功能 ===
        function setupFileUpload() {
            const area = document.getElementById('file-upload-area');
            const input = document.getElementById('file-input');
            const selectBtn = document.getElementById('select-files');

            if (!area || !input || !selectBtn) return;

            selectBtn.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => handleFiles(e.target.files));

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer && e.dataTransfer.files) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }

        async function handleFiles(fileList) {
            if (!currentProjectId) return;
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            if (!project.files) project.files = [];

            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-bar');
            const progressPercent = document.getElementById('upload-percent');

            for (let file of fileList) {
                // 檢查檔案大小（最大 10MB）
                if (file.size > 10 * 1024 * 1024) {
                    alert(`檔案 ${file.name} 超過 10MB 限制`);
                    continue;
                }

                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';

                if (isFirebaseInitialized) {
                    // 上傳到 Firebase Storage
                    const storageRef = storage.ref(`projects/${currentProjectId}/${Date.now()}_${file.name}`);
                    const uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressPercent.textContent = Math.round(progress) + '%';
                        },
                        (error) => {
                            console.error('上傳失敗:', error);
                            alert('檔案上傳失敗');
                            progressDiv.classList.add('hidden');
                        },
                        async () => {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            const fileInfo = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                url: downloadURL,
                                uploadTime: new Date().toISOString()
                            };

                            project.files.push(fileInfo);
                            syncToFirebase('projects/' + currentProjectId + '/files', project.files);
                            renderFilesList(project.files);
                            progressDiv.classList.add('hidden');
                        }
                    );
                } else {
                    // 離線模式：使用 blob URL
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: URL.createObjectURL(file),
                        uploadTime: new Date().toISOString()
                    };
                    project.files.push(fileInfo);
                    renderFilesList(project.files);
                    progressDiv.classList.add('hidden');
                }
            }
        }

        // === Modal 事件設置 ===
        function setupModalEvents() {
            // 專案 Modal
            document.getElementById('close-modal')?.addEventListener('click', closeProjectModal);
            document.getElementById('close-modal-btn')?.addEventListener('click', closeProjectModal);
            document.getElementById('toggle-edit-mode')?.addEventListener('click', toggleEditMode);
            document.getElementById('save-notes')?.addEventListener('click', saveNotes);
            document.getElementById('add-comment')?.addEventListener('click', addComment);
            document.getElementById('export-project')?.addEventListener('click', exportCurrentProject);

            // 評論 Enter 發送
            document.getElementById('new-comment')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addComment();
                }
            });

            // ESC 關閉所有 Modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });

            // 點擊遮罩關閉 Modal
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // 檔案上傳
            setupFileUpload();
        }
    </script>
</body>
</html>



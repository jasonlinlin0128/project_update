<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="多功能專案管理與溝通儀表板">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>多功能整合儀表板 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 備用字體和樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Theme (Default) */
            --bg-gradient-1: #e0f2fe;
            --bg-gradient-2: #dbeafe;
            --bg-gradient-3: #fce7f3;
            --bg-gradient-4: #e0e7ff;
            --bg-gradient-5: #f0fdfa;

            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;

            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.8);
            --card-bg: rgba(255, 255, 255, 0.85);
            --input-bg: rgba(255, 255, 255, 0.6);
        }

        body.dark-theme {
            /* Dark Theme */
            --bg-gradient-1: #1e293b;
            --bg-gradient-2: #334155;
            --bg-gradient-3: #4c1d95;
            --bg-gradient-4: #1e3a8a;
            --bg-gradient-5: #164e63;

            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-tertiary: #d1d5db;

            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(30, 41, 59, 0.85);
            --input-bg: rgba(15, 23, 42, 0.6);
        }

        /* Glassmorphism - Gradient Background with Theme Support */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg,
                var(--bg-gradient-1) 0%,
                var(--bg-gradient-2) 25%,
                var(--bg-gradient-3) 50%,
                var(--bg-gradient-4) 75%,
                var(--bg-gradient-5) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Scrollbar Styling */
        .kanban-column-content::-webkit-scrollbar, .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .kanban-column-content::-webkit-scrollbar-track, .table-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb:hover, .table-container::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

        /* Glassmorphism - Dashboard Tabs */
        .dashboard-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .dashboard-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .dashboard-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            border-bottom-color: white;
            font-weight: 600;
        }
        .hidden { display: none; }
        
        /* Calendar Styles */
        #calendar-grid { grid-template-rows: repeat(6, minmax(0, 1fr)); }
        .calendar-day { min-height: 100px; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-task {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 響應式設計 - 防止文字溢出 */
        @media (max-width: 768px) {
            /* 專案卡片標題自動換行 */
            .project-card h3,
            .project-card p,
            .project-card span {
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            /* 表格在手機上允許換行 */
            td.whitespace-nowrap {
                white-space: normal !important;
            }

            /* 行事曆任務在手機上縮小字體 */
            .calendar-task {
                font-size: 0.65rem;
            }

            /* 按鈕文字在手機上縮小 */
            button {
                font-size: 0.875rem;
            }

            /* 導航標籤在手機上縮小間距 */
            .dashboard-tab {
                padding: 10px 12px;
                font-size: 0.875rem;
            }

            /* 卡片內容確保不溢出 */
            .bg-white,
            .modal-content {
                max-width: 100%;
                overflow-x: hidden;
            }
        }
        
        /* Details Summary Styling */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details .summary-icon { transition: transform 0.2s; }
        details[open] .summary-icon { transform: rotate(90deg); }
        
        /* Glassmorphism - Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
        }

        /* Glassmorphism - Project Cards */
        .project-card {
            background: rgba(255, 255, 255, 0.25) !important;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
            background: rgba(255, 255, 255, 0.35) !important;
        }
        .file-upload-area { 
            border: 2px dashed #d1d5db; 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            transition: all 0.2s ease; 
        }
        .file-upload-area:hover { border-color: #3b82f6; background-color: #f8fafc; }
        .file-upload-area.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* Comments Section */
        .comment-bubble {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        .comment-bubble.manager {
            background: #fee2e2;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Glassmorphism - Text Styling with High Contrast */
        h1, h2, h3 {
            color: var(--text-primary) !important;
            text-shadow: none;
            font-weight: 700;
        }

        .text-gray-800, .text-gray-700, .text-gray-600, .text-gray-500 {
            color: var(--text-secondary) !important;
            text-shadow: none;
        }

        .text-gray-400 {
            color: var(--text-tertiary) !important;
            text-shadow: none;
        }

        p, span, div, label {
            color: var(--text-secondary) !important;
        }

        /* 確保 Modal 內的元素使用正確的文字顏色 */
        .modal-content p,
        .modal-content span,
        .modal-content div,
        .modal-content label {
            color: inherit;
        }

        .modal-content h1,
        .modal-content h2,
        .modal-content h3,
        .modal-content h4 {
            color: var(--text-primary) !important;
        }

        /* 確保輸入框和文字區域使用正確的顏色 */
        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content input[type="number"],
        .modal-content textarea,
        .modal-content select {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--glass-border);
        }

        .modal-content input[type="text"]::placeholder,
        .modal-content textarea::placeholder {
            color: var(--text-tertiary);
        }

        /* Glassmorphism - Buttons */
        .action-btn, button[class*="bg-"] {
            background: var(--card-bg) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border) !important;
            color: var(--text-primary) !important;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .action-btn:hover, button[class*="bg-"]:hover {
            background: var(--glass-bg) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* Glassmorphism - Input Fields */
        input, select, textarea {
            background: var(--input-bg) !important;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border) !important;
            color: var(--text-primary) !important;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-tertiary) !important;
        }

        input:focus, select:focus, textarea:focus {
            background: var(--card-bg) !important;
            border-color: #3b82f6 !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        /* Glassmorphism - Navigation Bar */
        nav {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            margin: 20px;
        }

        /* Glassmorphism - Main Content Area */
        main {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            margin: 20px;
        }

        /* Glassmorphism - Stat Cards / Summary Cards */
        .bg-blue-100, .bg-orange-100, .bg-purple-100, .bg-red-100, .bg-green-100,
        .bg-teal-50, .bg-blue-50, .bg-purple-50, .bg-green-50, .bg-orange-50 {
            background: var(--card-bg) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Glassmorphism - Kanban Columns */
        .bg-gray-100 {
            background: var(--card-bg) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border) !important;
        }

        /* Glassmorphism - Column Headers keep their solid colors but with glass effect */
        .bg-purple-500, .bg-blue-500, .bg-orange-500, .bg-teal-500, .bg-red-500, .bg-green-600 {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Glassmorphism - Labels and Badges */
        .text-blue-800, .text-blue-600, .text-orange-800, .text-purple-800, .text-green-800, .text-red-800,
        .text-yellow-800, .text-teal-800 {
            color: var(--text-primary) !important;
            font-weight: 600;
        }

        /* Dashboard Tab Styling */
        .dashboard-tab {
            color: var(--text-secondary) !important;
        }

        .dashboard-tab.active {
            color: var(--text-primary) !important;
        }

        /* Theme Toggle Button */
        #theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        #theme-toggle:hover {
            background: var(--glass-bg);
        }

        /* Project Card Improvements */
        .project-card {
            background: var(--card-bg) !important;
        }

        .project-card:hover {
            background: var(--glass-bg) !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Navigation Tabs -->
        <nav class="bg-white rounded-t-lg shadow-sm">
            <div class="flex items-center justify-between p-2">
                <div id="tab-container" class="flex border-b-0 overflow-x-auto flex-1">
                    <button data-target="dashboard-ai" class="dashboard-tab active flex-shrink-0">AI 專案進度</button>
                    <button data-target="dashboard-routine" class="dashboard-tab flex-shrink-0">例行公事</button>
                    <button data-target="dashboard-sharing" class="dashboard-tab flex-shrink-0">分享會</button>
                    <button data-target="dashboard-events" class="dashboard-tab flex-shrink-0">活動參與</button>
                    <button data-target="dashboard-contacts" class="dashboard-tab flex-shrink-0">接洽企業</button>
                </div>
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" onclick="toggleTheme()" class="ml-4 px-4 py-2 rounded-lg transition-all">
                    <i id="theme-icon" class="fas fa-moon"></i>
                    <span id="theme-text" class="ml-2">深色</span>
                </button>
            </div>
        </nav>

        <!-- Dashboard Content Area -->
        <main class="bg-white p-6 rounded-b-lg shadow-sm min-h-[80vh]">
            <!-- 1. AI Project Dashboard -->
            <div id="dashboard-ai" class="dashboard-content">
                <header class="md:flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">AI 專案進度儀表板</h1>
                        <p class="text-gray-500 mt-1">概覽所有進行中與構思中的 AI 導入專案。</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-4">
                        <button onclick="showAddProjectModal()" class="action-btn">
                            <i class="fas fa-plus mr-2"></i>新增專案
                        </button>
                        <button onclick="showFieldConfigModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-cog mr-2"></i>顯示欄位
                        </button>
                        <button onclick="reloadProjects()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>重新載入
                        </button>
                        <button onclick="exportProjects()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>匯出資料
                        </button>
                        <div>
                            <label for="month-filter" class="text-sm font-medium text-gray-700 mr-2">依成立月份篩選:</label>
                            <select id="month-filter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                        </div>
                        <div id="sync-status" class="flex items-center">
                            <div class="spinner mr-2"></div>
                            <span class="text-sm text-gray-500">同步中...</span>
                        </div>
                    </div>
                </header>
                <div id="ai-summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
                <div id="ai-kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6"></div>
            </div>

            <!-- 2. Routine Tasks Dashboard -->
            <div id="dashboard-routine" class="dashboard-content hidden">
                 <header class="mb-6 flex justify-between items-center">
                     <div>
                         <h1 class="text-3xl font-bold text-gray-800">例行公事儀表板</h1>
                         <p class="text-gray-500 mt-1">追蹤每日、每週、每月的重複性任務。</p>
                     </div>
                     <button onclick="showAddRoutineModal()" class="action-btn">
                         <i class="fas fa-plus mr-2"></i>新增任務
                     </button>
                 </header>

                 <!-- 搜尋與篩選區 -->
                 <div class="mb-6 space-y-4">
                     <!-- 搜尋框 -->
                     <div class="relative">
                         <input type="text"
                                id="routine-search"
                                placeholder="🔍 搜尋任務名稱..."
                                oninput="handleRoutineSearch(this.value)"
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                         <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                     </div>

                     <!-- 篩選按鈕組 -->
                     <div class="flex flex-wrap gap-2" id="routine-filter-buttons">
                         <button onclick="filterRoutineTasks('all')"
                                 data-filter="all"
                                 class="routine-filter-btn active px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700">
                             全部
                         </button>
                         <button onclick="filterRoutineTasks('daily')"
                                 data-filter="daily"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             每日任務
                         </button>
                         <button onclick="filterRoutineTasks('threeWeeks')"
                                 data-filter="threeWeeks"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             三週一次
                         </button>
                         <button onclick="filterRoutineTasks('monthly')"
                                 data-filter="monthly"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             每月任務
                         </button>
                         <button onclick="filterRoutineTasks('bimonthly')"
                                 data-filter="bimonthly"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             雙月任務
                         </button>
                         <button onclick="filterRoutineTasks('completed')"
                                 data-filter="completed"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             今日已完成
                         </button>
                         <button onclick="filterRoutineTasks('pending')"
                                 data-filter="pending"
                                 class="routine-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                             今日待完成
                         </button>
                     </div>
                 </div>

                 <div id="routine-tasks-content" class="space-y-8"></div>
                 <div class="mt-12">
                     <div id="calendar-header" class="flex items-center justify-between mb-4"></div>
                     <div id="calendar-body"></div>
                 </div>
            </div>

            <!-- 3. Sharing Session Dashboard -->
            <div id="dashboard-sharing" class="dashboard-content hidden">
                 <header class="mb-6 flex justify-between items-center">
                     <div>
                         <h1 class="text-3xl font-bold text-gray-800">分享會儀表板</h1>
                         <p class="text-gray-500 mt-1">規劃與回顧內部 AI 新知分享會。</p>
                     </div>
                     <button onclick="showAddSharingModal()" class="action-btn">
                         <i class="fas fa-plus mr-2"></i>新增分享會
                     </button>
                 </header>

                 <!-- 搜尋區 -->
                 <div class="mb-6">
                     <div class="relative">
                         <input type="text"
                                id="sharing-search"
                                placeholder="🔍 搜尋分享會主題、講者或議程內容..."
                                oninput="handleSharingSearch(this.value)"
                                class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                         <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                     </div>
                 </div>

                 <div id="sharing-session-content"></div>
            </div>

            <!-- 4. Event Participation Dashboard -->
            <div id="dashboard-events" class="dashboard-content hidden">
                 <header class="mb-8">
                     <div class="flex justify-between items-center mb-4">
                         <div>
                             <h1 class="text-3xl font-bold text-gray-800">活動參與儀表板</h1>
                             <p class="text-gray-500 mt-1">記錄內外部活動的學習與收穫。</p>
                         </div>
                         <button onclick="showAddEventModal()" class="action-btn">
                             <i class="fas fa-plus mr-2"></i>新增活動
                         </button>
                     </div>
                     <div class="flex items-center space-x-4">
                         <div class="flex-1">
                             <input id="event-search" type="text" placeholder="搜尋活動名稱或概述..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    oninput="filterEvents()">
                         </div>
                         <select id="event-type-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterEvents()">
                             <option value="all">所有類型</option>
                             <option value="external">外部活動</option>
                             <option value="internal">內部活動</option>
                         </select>
                     </div>
                 </header>
                 <div id="event-participation-content" class="space-y-10"></div>
            </div>

            <!-- 5. Business Contact Dashboard -->
            <div id="dashboard-contacts" class="dashboard-content hidden">
                 <header class="mb-8">
                     <div class="flex justify-between items-center mb-4">
                         <div>
                             <h1 class="text-3xl font-bold text-gray-800">接洽企業儀表板</h1>
                             <p class="text-gray-500 mt-1">管理與外部企業、廠商的合作與洽談紀錄。</p>
                         </div>
                         <button onclick="showAddContactModal()" class="action-btn">
                             <i class="fas fa-plus mr-2"></i>新增接洽
                         </button>
                     </div>
                     <div class="flex-1">
                         <input id="contact-search" type="text" placeholder="搜尋企業名稱、聯絡人或洽談主題..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                oninput="filterContacts()">
                     </div>
                 </header>
                 <div id="business-contacts-content" class="table-container overflow-x-auto"></div>
            </div>
        </main>
    </div>

    <!-- Enhanced Project Detail Modal -->
    <div id="project-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-5xl mx-4">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="modal-project-name" class="text-2xl font-bold text-gray-800"></h2>
                        <p id="modal-project-department" class="text-gray-600 mt-1"></p>
                    </div>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Edit/View Toggle -->
                <div class="mb-4">
                    <button id="toggle-edit-mode" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-edit mr-2"></i>編輯專案資訊
                    </button>
                </div>

                <!-- Project Basic Info (Editable) -->
                <div id="project-info-view" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">基本資訊</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">開始日期:</span>
                                <span id="modal-start-date" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">預計完成:</span>
                                <span id="modal-due-date" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">優先級:</span>
                                <span id="modal-priority" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">狀態:</span>
                                <span id="modal-status" class="font-medium text-gray-800"></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">進度追蹤</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">完成進度</span>
                                <span id="modal-progress-text" class="text-sm font-medium text-gray-800"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="modal-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Form (Initially Hidden) -->
                <div id="project-info-edit" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                            <input id="edit-project-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">負責部門</label>
                            <input id="edit-department" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                            <input id="edit-start-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">預計完成</label>
                            <input id="edit-due-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">優先級</label>
                            <select id="edit-priority" class="w-full px-3 py-2 border rounded-lg">
                                <option value="高">高</option>
                                <option value="中">中</option>
                                <option value="低">低</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                            <select id="edit-status" class="w-full px-3 py-2 border rounded-lg">
                                <option value="構思中">構思中</option>
                                <option value="規劃中">規劃中</option>
                                <option value="開發中">開發中</option>
                                <option value="測試中">測試中</option>
                                <option value="已終止">已終止</option>
                                <option value="已完成">已完成</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">進度 (%)</label>
                            <input id="edit-progress" type="number" min="0" max="100" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <button onclick="saveProjectEdit()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full">
                                <i class="fas fa-save mr-2"></i>儲存變更
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Project Progress Notes -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">專案進度說明</h3>
                    <textarea id="project-notes" placeholder="在此輸入專案進度說明、遇到的問題、解決方案等詳細資訊..." 
                              class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="save-notes" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>儲存說明
                        </button>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-comments mr-2"></i>評論與討論
                    </h3>
                    
                    <!-- Add New Comment -->
                    <div class="mb-4">
                        <div class="mb-2">
                            <span id="comment-role-indicator" class="inline-block px-3 py-1 rounded-full text-sm font-semibold">
                                <i class="fas fa-user-circle mr-1"></i>以 <span id="comment-role-text">員工</span> 身份留言
                            </span>
                        </div>
                        <div class="flex items-start space-x-3">
                            <input type="hidden" id="comment-author" value="員工">
                            <textarea id="new-comment" placeholder="輸入您的評論或建議..."
                                      class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                      rows="2"></textarea>
                            <button id="add-comment" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Comments List -->
                    <div id="comments-list" class="max-h-64 overflow-y-auto">
                        <!-- Comments will be rendered here -->
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">相關文件</h3>
                    <div id="file-upload-area" class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-sm text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
                        <button id="select-files" class="mt-3 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>選擇檔案
                        </button>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-blue-700">上傳中...</span>
                                    <span id="upload-percent" class="text-sm font-medium text-blue-700">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="upload-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uploaded Files List -->
                    <div id="uploaded-files" class="mt-4">
                        <h4 class="font-medium text-gray-800 mb-2">已上傳的檔案</h4>
                        <div id="files-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-between pt-4 border-t border-gray-200">
                    <button onclick="deleteProject()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>刪除專案
                    </button>
                    <div class="space-x-3">
                        <button id="export-project" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>匯出專案資料
                        </button>
                        <button id="close-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Project Modal -->
    <!-- Field Configuration Modal -->
    <div id="field-config-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-3xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-cog mr-2"></i>設定專案卡片顯示欄位</h3>

            <!-- 快速預設模式 -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-700 mb-3">快速套用預設模式：</h4>
                <div class="flex space-x-3">
                    <button onclick="applyFieldPreset('minimal')" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200">
                        簡潔模式
                    </button>
                    <button onclick="applyFieldPreset('standard')" class="px-4 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200">
                        標準模式（當前）
                    </button>
                    <button onclick="applyFieldPreset('detailed')" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200">
                        詳細模式
                    </button>
                </div>
            </div>

            <!-- 自定義欄位選擇 -->
            <div class="space-y-3">
                <h4 class="font-semibold text-gray-700 mb-3">自定義顯示欄位：</h4>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-name" checked disabled class="mr-3 h-4 w-4">
                        <div>
                            <span class="font-medium">專案名稱</span>
                            <span class="text-xs text-gray-500 block">（必填，無法取消）</span>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-department" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">負責部門</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-startTime" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">開始時間</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-dueDate" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">截止日期</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-priority" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">優先級</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-progress" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">進度</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-status" checked class="mr-3 h-4 w-4">
                        <span class="font-medium">狀態</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="field-comments" class="mr-3 h-4 w-4">
                        <span class="font-medium">評論數量</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeFieldConfigModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveFieldConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">套用設定</button>
            </div>
        </div>
    </div>

    <div id="add-project-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增 AI 專案</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                    <input id="new-project-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">負責部門</label>
                    <input id="new-project-department" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                    <input id="new-project-start" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">預計完成</label>
                    <input id="new-project-due" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">優先級</label>
                    <select id="new-project-priority" class="w-full px-3 py-2 border rounded-lg">
                        <option value="高">高</option>
                        <option value="中">中</option>
                        <option value="低">低</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                    <select id="new-project-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="構思中">構思中</option>
                        <option value="規劃中">規劃中</option>
                        <option value="開發中">開發中</option>
                        <option value="測試中">測試中</option>
                        <option value="已終止">已終止</option>
                        <option value="已完成">已完成</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">完成進度</label>
                    <div class="flex items-center space-x-4">
                        <input id="new-project-progress" type="range" min="0" max="100" value="0"
                               class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                               oninput="document.getElementById('new-project-progress-value').textContent = this.value + '%'">
                        <span id="new-project-progress-value" class="text-lg font-semibold text-blue-600 w-16 text-right">0%</span>
                    </div>
                    <div class="mt-1 text-xs text-gray-500">拖動滑桿設定專案完成進度（0-100%）</div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddProjectModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewProject()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增專案</button>
            </div>
        </div>
    </div>

    <!-- Add Sharing Session Modal -->
    <div id="add-sharing-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增分享會</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分享會日期</label>
                    <input id="new-sharing-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主題</label>
                    <input id="new-sharing-theme" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">講者</label>
                    <input id="new-sharing-speaker" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">議程安排（每行一項）</label>
                    <textarea id="new-sharing-schedule" rows="5" class="w-full px-3 py-2 border rounded-lg"
                              placeholder="16:00-16:05 開場與介紹
16:05-16:30 主題分享
16:30-16:45 Q&A 與交流"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">相關文件</h4>
                    <div id="sharing-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-xs text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="sharing-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="sharing-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddSharingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewSharing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增分享會</button>
            </div>
        </div>
    </div>

    <!-- Edit Sharing Session Modal -->
    <div id="edit-sharing-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯分享會</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分享會日期</label>
                    <input id="edit-sharing-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主題</label>
                    <input id="edit-sharing-theme" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">講者</label>
                    <input id="edit-sharing-speaker" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                    <select id="edit-sharing-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="upcoming">即將舉行</option>
                        <option value="past">過往紀錄</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">議程安排（每行一項）</label>
                    <textarea id="edit-sharing-schedule" rows="5" class="w-full px-3 py-2 border rounded-lg"
                              placeholder="16:00-16:05 開場與介紹
16:05-16:30 主題分享
16:30-16:45 Q&A 與交流"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">相關文件</h4>
                    <div id="edit-sharing-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-xs text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="edit-sharing-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="edit-sharing-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditSharingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveEditSharing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增活動參與</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動名稱</label>
                    <input id="new-event-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動日期</label>
                    <input id="new-event-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動類型</label>
                    <select id="new-event-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="external">外部活動</option>
                        <option value="internal">內部活動</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動概述</label>
                    <textarea id="new-event-summary" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主要學習與收穫（每行一項）</label>
                    <textarea id="new-event-learnings" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">相關文件</h4>
                    <div id="event-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-xs text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="event-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="event-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddEventModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewEvent()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增活動</button>
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="edit-event-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯活動參與</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動名稱</label>
                    <input id="edit-event-name" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動日期</label>
                    <input id="edit-event-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動類型</label>
                    <select id="edit-event-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="external">外部活動</option>
                        <option value="internal">內部活動</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">活動概述</label>
                    <textarea id="edit-event-summary" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">主要學習與收穫（每行一項）</label>
                    <textarea id="edit-event-learnings" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">相關文件</h4>
                    <div id="edit-event-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-xs text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="edit-event-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="edit-event-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditEventModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveEditEvent()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增企業接洽</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">企業名稱</label>
                    <input id="new-contact-company" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label>
                    <input id="new-contact-person" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">接洽日期</label>
                    <input id="new-contact-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">洽談主題</label>
                    <textarea id="new-contact-topic" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">相關文件</h4>
                    <div id="contact-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-xs text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="contact-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="contact-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddContactModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewContact()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增接洽</button>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div id="edit-contact-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯企業接洽</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">企業名稱</label>
                    <input id="edit-contact-company" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label>
                    <input id="edit-contact-person" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">接洽日期</label>
                    <input id="edit-contact-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">洽談主題</label>
                    <textarea id="edit-contact-topic" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- File Upload Section -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">相關文件</h4>
                    <div id="edit-contact-file-upload-area" class="file-upload-area cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1 text-sm">拖拽檔案到此處或點擊選擇檔案</p>
                        <p class="text-xs text-gray-500">支援 PDF、Word、Excel、圖片等格式（最大 10MB）</p>
                        <input type="file" id="edit-contact-file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.ppt,.pptx">
                    </div>
                    <div id="edit-contact-files-list" class="mt-2 space-y-1"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditContactModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveEditContact()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Add Routine Task Modal -->
    <div id="add-routine-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">新增例行任務</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">任務類型</label>
                    <select id="new-routine-type" class="w-full px-3 py-2 border rounded-lg" onchange="updateRoutineFields()">
                        <option value="daily">每日任務 (週一至週五，排除國定假日)</option>
                        <option value="custom">自定義週期</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">任務名稱</label>
                    <input id="new-routine-task" type="text" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div id="routine-time-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">執行時間</label>
                    <input id="new-routine-time" type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例：8:00~8:15">
                </div>
                <div id="routine-day-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">每月執行日（可選）</label>
                    <input id="new-routine-day" type="number" min="1" max="31" class="w-full px-3 py-2 border rounded-lg" placeholder="固定日期請填寫，如15">
                    <p class="text-xs text-gray-500 mt-1">⚠️ 如每月日期不固定（如電腦巡檢），請留空此欄位，之後可為每個月單獨設定日期</p>
                </div>
                <div id="routine-last-date-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">上次執行日期</label>
                    <input id="new-routine-last-date" type="date" class="w-full px-3 py-2 border rounded-lg" onchange="calculateNextDate()">
                </div>
                <div id="routine-next-date-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">下次執行日期</label>
                    <input id="new-routine-next-date" type="date" class="w-full px-3 py-2 border rounded-lg">
                    <p id="next-date-hint" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <div id="routine-weekdays-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">執行日（可多選）</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="1" class="routine-weekday-checkbox">
                            <span>週一</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="2" class="routine-weekday-checkbox">
                            <span>週二</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="3" class="routine-weekday-checkbox">
                            <span>週三</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="4" class="routine-weekday-checkbox">
                            <span>週四</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="5" class="routine-weekday-checkbox">
                            <span>週五</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="6" class="routine-weekday-checkbox">
                            <span>週六</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="0" class="routine-weekday-checkbox">
                            <span>週日</span>
                        </label>
                    </div>
                </div>
                <div id="routine-quarterly-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">季度執行月份與日期</label>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="new-routine-quarter-month" class="w-full px-3 py-2 border rounded-lg">
                            <option value="1">每季第一個月</option>
                            <option value="2">每季第二個月</option>
                            <option value="3">每季第三個月</option>
                        </select>
                        <input id="new-routine-quarter-day" type="number" min="1" max="31" placeholder="日期" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">例如：第一個月 + 15日 = 1/15、4/15、7/15、10/15</p>
                </div>
                <div id="routine-custom-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">快速設定（預設選項）</label>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button type="button" onclick="applyPreset('weekly')" class="px-3 py-2 bg-blue-50 text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors">
                            <i class="fas fa-calendar-week mr-1"></i>每週
                        </button>
                        <button type="button" onclick="applyPreset('monthly')" class="px-3 py-2 bg-purple-50 text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-100 transition-colors">
                            <i class="fas fa-calendar-alt mr-1"></i>每月
                        </button>
                        <button type="button" onclick="applyPreset('quarterly')" class="px-3 py-2 bg-teal-50 text-teal-700 border border-teal-300 rounded-lg hover:bg-teal-100 transition-colors">
                            <i class="fas fa-calendar mr-1"></i>每季
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-gray-700 mb-1">自定義週期</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">每</span>
                            <input id="new-routine-custom-interval" type="number" min="1" placeholder="數量" class="flex-1 px-3 py-2 border rounded-lg" oninput="calculateCustomNextDate()">
                        </div>
                        <select id="new-routine-custom-unit" class="w-full px-3 py-2 border rounded-lg" onchange="calculateCustomNextDate()">
                            <option value="days">天</option>
                            <option value="weeks">週</option>
                            <option value="months">月</option>
                        </select>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                        <input id="new-routine-custom-start" type="date" class="w-full px-3 py-2 border rounded-lg" onchange="calculateCustomNextDate()">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">💡 提示：點擊快速設定按鈕，或手動輸入數值。例如：每 2 週、每 3 月</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddRoutineModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="addNewRoutine()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增任務</button>
            </div>
        </div>
    </div>

    <!-- Routine Task Date Setting Modal -->
    <div id="routine-date-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md mx-4 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">設定例行任務日期</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">任務名稱</label>
                <input id="routine-task-name" type="text" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">選擇日期</label>
                <input id="routine-task-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeRoutineModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">取消</button>
                <button onclick="saveRoutineDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存</button>
            </div>
        </div>
    </div>

    <script>
        // ===== 主題切換系統 =====
        function initTheme() {
            // 從 localStorage 讀取主題偏好，預設為淺色主題
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                updateThemeButton(true);
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeButton(isDark);
            console.log('主題已切換:', isDark ? '深色' : '淺色');
        }

        function updateThemeButton(isDark) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (isDark) {
                icon.className = 'fas fa-sun';
                text.textContent = '淺色';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = '深色';
            }
        }

        // 頁面載入時初始化主題
        initTheme();

        // ===== 權限系統 (URL 參數法) =====
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || 'manager'; // 預設為專案管理師
        const isReadOnly = userRole === 'supervisor'; // 主管為唯讀模式

        console.log('使用者角色:', userRole, '| 唯讀模式:', isReadOnly);

        // Firebase 初始化 - 使用內建配置
        let database, storage;
        let isFirebaseInitialized = false;

        function initFirebase() {
            try {
                // 檢查 Firebase 是否可用
                if (typeof firebase === 'undefined') {
                    console.error('❌ Firebase 庫未載入');
                    updateSyncStatus('離線模式', false);
                    // 使用本地資料渲染所有儀表板
                    setTimeout(() => {
                        renderAllDashboards();
                    }, 100);
                    return false;
                }

                // 內建 Firebase 配置
                const firebaseConfig = {
                    apiKey: "AIzaSyBlOglfZtVNC3wkH8FzxPRWpZjbioOisKA",
                    authDomain: "project-update-ab874.firebaseapp.com",
                    databaseURL: "https://project-update-ab874-default-rtdb.firebaseio.com",
                    projectId: "project-update-ab874",
                    storageBucket: "project-update-ab874.firebasestorage.app",
                    messagingSenderId: "auto",
                    appId: "auto"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                storage = firebase.storage();
                isFirebaseInitialized = true;

                updateSyncStatus('雲端已連線', true);
                console.log('✅ Firebase 已自動連線');

                // 載入所有資料
                loadAllDataFromFirebase();

                return true;
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                updateSyncStatus('離線模式', false);
                isFirebaseInitialized = false;

                // 即使 Firebase 失敗，也要渲染儀表板讓用戶可以使用
                setTimeout(() => {
                    renderAllDashboards();
                }, 100);

                return false;
            }
        }
        
        
        function updateSyncStatus(text, success = true) {
            const statusEl = document.getElementById('sync-status');
            if (!statusEl) return;

            if (success) {
                statusEl.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i><span class="text-sm text-green-600">${text}</span>`;
            } else {
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i><span class="text-sm text-yellow-600">${text}</span>`;
            }
        }

        // ===== 權限系統 - 套用權限限制 =====
        function applyPermissions() {
            if (!isReadOnly) {
                console.log('專案管理師模式 - 所有功能可用');
                return; // 管理師不限制
            }

            console.log('套用主管檢視模式權限');

            // 1. 隱藏所有「新增」按鈕
            const addButtons = [
                'button[onclick="showAddProjectModal()"]',
                'button[onclick="showAddRoutineModal()"]',
                'button[onclick="showAddSharingModal()"]',
                'button[onclick="showAddEventModal()"]',
                'button[onclick="showAddContactModal()"]'
            ];

            addButtons.forEach(selector => {
                const btn = document.querySelector(selector);
                if (btn) {
                    btn.style.display = 'none';
                    console.log('隱藏新增按鈕:', selector);
                }
            });

            // 2. 隱藏「編輯專案資訊」按鈕
            const editToggle = document.getElementById('toggle-edit-mode');
            if (editToggle) {
                editToggle.style.display = 'none';
            }

            // 3. 隱藏所有「刪除」按鈕
            setTimeout(() => {
                document.querySelectorAll('button[onclick*="delete"]').forEach(btn => {
                    if (!btn.classList.contains('comment-delete')) { // 保留評論刪除按鈕
                        btn.style.display = 'none';
                    }
                });
            }, 500);

            // 4. 禁用進度說明編輯
            const notesField = document.getElementById('project-notes');
            if (notesField) {
                notesField.disabled = true;
                notesField.style.backgroundColor = '#f3f4f6';
                notesField.style.cursor = 'not-allowed';
            }

            // 5. 隱藏「儲存說明」按鈕
            const saveNotesBtn = document.getElementById('save-notes');
            if (saveNotesBtn) {
                saveNotesBtn.style.display = 'none';
            }

            // 6. 隱藏「編輯」按鈕（分享會、活動、接洽企業）
            setTimeout(() => {
                document.querySelectorAll('button[onclick*="edit"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }, 500);

            // 7. 在頁面頂部顯示角色標識
            const container = document.querySelector('.max-w-7xl');
            if (container && !document.getElementById('role-indicator')) {
                const roleIndicator = document.createElement('div');
                roleIndicator.id = 'role-indicator';
                roleIndicator.className = 'bg-blue-100 border border-blue-300 text-blue-800 px-4 py-2 rounded-lg mb-4 text-center font-semibold';
                roleIndicator.innerHTML = '<i class="fas fa-eye mr-2"></i>檢視模式：主管 - 您可以查看所有資訊並在專案中留言';
                container.insertBefore(roleIndicator, container.firstChild);
            }
        }

        // 全域變數
        let calendarDate = new Date();
        let currentProjectId = null;
        let currentRoutineTask = null;
        let currentSharingId = null;
        let currentEventId = null;
        let currentContactId = null;
        let editMode = false;
        let isDataLoading = false;  // 全域載入狀態標記
        let isProjectsLoading = false;  // 專案資料載入狀態標記
        let projectIdCounter = 100000;  // ID 生成器，從 100000 開始避免與固定 ID 衝突

        // 資料陣列（從 Firebase 載入，初始為空）
        let projects = [];
        let routineTasks = {
            daily: [],
            custom: [],  // 自定義週期任務（包含預設的每週、每月、每季等）
            // 舊的任務類型保留以便向後兼容（從 Firebase 載入舊資料）
            threeWeeks: [],
            monthly: [],
            bimonthly: [],
            weekly: [],
            quarterly: []
        };
        let sharingSessions = [];
        let eventsAttended = [];
        let businessContacts = [];

        // ===== 台灣國定假日資料庫 (2025-2026) =====
        const taiwanHolidays = {
            '2025': [
                { date: '2025-01-01', name: '中華民國開國紀念日' },
                { date: '2025-01-27', name: '農曆除夕前一日' },
                { date: '2025-01-28', name: '農曆除夕' },
                { date: '2025-01-29', name: '春節' },
                { date: '2025-01-30', name: '春節' },
                { date: '2025-01-31', name: '春節' },
                { date: '2025-02-01', name: '春節' },
                { date: '2025-02-28', name: '和平紀念日' },
                { date: '2025-04-03', name: '兒童節' },
                { date: '2025-04-04', name: '清明節' },
                { date: '2025-05-31', name: '端午節' },
                { date: '2025-10-06', name: '中秋節' },
                { date: '2025-10-10', name: '國慶日' }
            ],
            '2026': [
                { date: '2026-01-01', name: '中華民國開國紀念日' },
                { date: '2026-02-16', name: '農曆除夕前一日' },
                { date: '2026-02-17', name: '農曆除夕' },
                { date: '2026-02-18', name: '春節' },
                { date: '2026-02-19', name: '春節' },
                { date: '2026-02-20', name: '春節' },
                { date: '2026-02-21', name: '春節' },
                { date: '2026-02-28', name: '和平紀念日' },
                { date: '2026-04-03', name: '兒童節' },
                { date: '2026-04-04', name: '清明節' },
                { date: '2026-06-19', name: '端午節' },
                { date: '2026-09-25', name: '中秋節' },
                { date: '2026-10-10', name: '國慶日' }
            ]
        };

        // 檢查是否為台灣國定假日
        function isTaiwanHoliday(date) {
            const year = date.getFullYear().toString();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            if (taiwanHolidays[year]) {
                const holiday = taiwanHolidays[year].find(h => h.date === dateStr);
                return holiday ? holiday.name : null;
            }
            return null;
        }

        // 檢查是否為週末或國定假日
        function isWeekendOrHoliday(date) {
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const holiday = isTaiwanHoliday(date);

            return {
                isOff: isWeekend || holiday !== null,
                reason: holiday || (isWeekend ? '週末' : null)
            };
        }

        // 全域錯誤處理（僅記錄，不影響 UI）
        window.addEventListener('error', (e) => {
            console.error('全域錯誤:', e.error);
            // 移除自動顯示錯誤，避免干擾 Firebase 狀態顯示
        });

        // 檢查資源加載
        window.addEventListener('load', () => {
            console.log('頁面已完全加載');
            if (!window.firebase) {
                console.warn('Firebase SDK 未加載，部分功能將不可用');
                if (document.getElementById('sync-status')) {
                    updateSyncStatus('離線模式 (Firebase 未加載)', false);
                }
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadFieldConfig();  // 載入欄位配置
                initFirebase();  // Firebase 載入完成後會自動調用各 render 函數
                setupEventListeners();
                // ⚠️ 不在這裡調用 renderAllDashboards()，因為 Firebase 資料尚未載入
                // 各儀表板會在 Firebase 載入完成後自動渲染

                // 延遲執行權限套用以確保 DOM 完全載入
                setTimeout(() => {
                    applyPermissions();
                }, 100);
            } catch (error) {
                console.error('初始化失敗:', error);
                updateSyncStatus('初始化失敗', false);
            }
        });

        function setupEventListeners() {
            // Tab 切換
            const tabs = document.querySelectorAll('.dashboard-tab');
            const contents = document.querySelectorAll('.dashboard-content');
            tabs.forEach(tab => tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.remove('hidden');
            }));

            // Modal 事件
            setupModalEvents();
        }

        function renderAllDashboards() {
            renderAiDashboard();
            renderRoutineDashboard();
            renderSharingDashboard();
            renderEventsDashboard();
            renderContactsDashboard();
        }

        // === 輔助函式 ===
        function generateUniqueId() {
            // 使用遞增計數器 + 隨機數確保唯一性
            return projectIdCounter++;
        }

        function findProjectById(projectId) {
            // 安全查找專案，包含錯誤處理
            if (!projectId) {
                console.warn('專案 ID 為空');
                return null;
            }
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.warn('找不到專案 ID:', projectId, '| 當前專案數:', projects.length);
            }
            return project;
        }

        // === Firebase 同步函數 ===
        function loadAllDataFromFirebase() {
            if (!isFirebaseInitialized) return;

            isDataLoading = true;  // 設定全域載入中狀態
            isProjectsLoading = true;  // 設定專案載入中狀態
            console.log('📡 開始從 Firebase 載入資料...');

            // 設置超時處理 - 10秒後如果還沒載入完成，就使用本地資料
            const loadTimeout = setTimeout(() => {
                if (isDataLoading) {
                    console.warn('⚠️ Firebase 載入超時，使用本地資料');
                    isDataLoading = false;
                    isProjectsLoading = false;
                    updateSyncStatus('離線模式', false);

                    // 渲染所有儀表板（使用空資料或本地資料）
                    renderAiDashboard();
                    renderRoutineDashboard();
                    renderSharingDashboard();
                    renderEventsDashboard();
                    renderContactsDashboard();
                }
            }, 10000);

            // 載入專案資料
            database.ref('projects').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    projects = Object.values(data).sort((a, b) => a.id - b.id);
                    console.log('✅ 載入專案資料:', projects.length, '個專案');
                } else {
                    // Firebase 資料庫為空，保持空陣列
                    console.log('📝 Firebase 資料庫為空，可以開始新增專案');
                }
                renderAiDashboard();
                isProjectsLoading = false;  // 專案載入完成，立即允許互動
                console.log('✅ 專案資料載入完成，可以開始互動');
            }).catch(err => {
                console.error('載入專案失敗:', err);
                isProjectsLoading = false;  // 即使失敗也要清除專案載入狀態
            });

            // 載入例行任務
            database.ref('routineTasks').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    routineTasks = data;
                    console.log('✅ 載入例行任務');
                } else {
                    console.log('📝 例行任務資料庫為空，可以開始新增任務');
                }
                renderRoutineDashboard();
            }).catch(err => console.error('載入例行任務失敗:', err));

            // 載入分享會
            database.ref('sharingSessions').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    sharingSessions = Object.values(data);
                    console.log('✅ 載入分享會:', sharingSessions.length, '場');
                } else {
                    console.log('📝 分享會資料庫為空，可以開始新增分享會');
                }
                renderSharingDashboard();
            }).catch(err => console.error('載入分享會失敗:', err));

            // 載入活動
            database.ref('events').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    eventsAttended = Object.values(data);
                    console.log('✅ 載入活動:', eventsAttended.length, '個活動');
                } else {
                    console.log('📝 活動資料庫為空，可以開始新增活動');
                }
                renderEventsDashboard();
            }).catch(err => console.error('載入活動失敗:', err));

            // 載入企業接洽
            database.ref('contacts').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    businessContacts = Object.values(data);
                    console.log('✅ 載入企業接洽:', businessContacts.length, '筆');
                } else {
                    console.log('📝 企業接洽資料庫為空，可以開始新增聯絡人');
                }
                renderContactsDashboard();

                // 所有資料載入完成
                clearTimeout(loadTimeout);  // 清除超時定時器
                isDataLoading = false;
                console.log('✅ 所有資料載入完成');
            }).catch(err => {
                console.error('載入企業接洽失敗:', err);
                clearTimeout(loadTimeout);  // 清除超時定時器
                isDataLoading = false;  // 即使失敗也要清除載入狀態
            });
        }

        function syncToFirebase(path, data) {
            if (!isFirebaseInitialized) {
                console.error('❌ Firebase 未初始化，無法同步資料');
                alert('Firebase 未初始化，資料無法儲存！');
                return Promise.reject('Firebase not initialized');
            }

            console.log('🔄 正在同步資料到 Firebase:', path);

            return database.ref(path).set(data)
                .then(() => {
                    console.log('✅ 資料同步成功:', path);
                    updateSyncStatus('已同步', true);
                })
                .catch((error) => {
                    console.error('❌ Firebase 同步失敗:', error);
                    console.error('路徑:', path);
                    console.error('錯誤代碼:', error.code);
                    console.error('錯誤訊息:', error.message);

                    // 顯示錯誤給用戶
                    if (error.code === 'PERMISSION_DENIED') {
                        alert('⚠️ Firebase 權限不足！\n\n請檢查 Firebase Realtime Database 規則設定。\n\n請前往 Firebase Console → Realtime Database → 規則，確認允許讀寫。');
                    } else {
                        alert('資料儲存失敗：' + error.message);
                    }

                    updateSyncStatus('同步失敗', false);
                    throw error;
                });
        }

        // === 1. AI 專案儀表板 ===
        function renderAiDashboard() {
            const board = document.getElementById('ai-kanban-board');
            const summaryContainer = document.getElementById('ai-summary-stats');
            const monthFilter = document.getElementById('month-filter');

            if (!board || !summaryContainer || !monthFilter) {
                console.error('AI Dashboard 元素未找到');
                return;
            }

            // 安全檢查：確保 projects 已初始化
            if (!projects || !Array.isArray(projects)) {
                console.warn('專案資料尚未載入');
                board.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">資料載入中...</div>';
                summaryContainer.innerHTML = '';
                return;
            }

            // 如果資料為空，顯示友善提示
            if (projects.length === 0) {
                console.log('📝 專案資料庫為空');
                board.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8 bg-blue-50 rounded-lg p-12"><i class="fas fa-folder-open text-6xl text-blue-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">尚無專案資料</p><p class="text-gray-500">點擊上方「新增專案」按鈕開始建立您的第一個專案</p></div>';
                summaryContainer.innerHTML = '<div class="col-span-full text-center text-gray-400 text-sm">新增專案後將顯示統計資料</div>';
                monthFilter.innerHTML = '<option value="all">所有月份</option>';
                return;
            }

            // 填充月份篩選器（安全處理 startTime）
            const months = [...new Set(
                projects
                    .filter(p => p.startTime && typeof p.startTime === 'string' && p.startTime.length >= 7)
                    .map(p => p.startTime.substring(0, 7))
            )].sort().reverse();

            monthFilter.innerHTML = '<option value="all">所有月份</option>';
            months.forEach(m => {
                if (m !== 'unknow' && m !== 'unknown') {
                    monthFilter.innerHTML += `<option value="${m}">${m}</option>`;
                }
            });

            monthFilter.onchange = () => displayProjects();
            displayProjects();

            function displayProjects() {
                const selectedMonth = monthFilter.value;
                const filteredProjects = selectedMonth === 'all' ? projects : projects.filter(p => p.startTime.startsWith(selectedMonth));
                
                board.innerHTML = '';
                summaryContainer.innerHTML = '';

                const statuses = ["構思中", "規劃中", "開發中", "測試中", "已終止", "已完成"];
                const priorityColors = { '高': 'bg-red-100 text-red-800', '中': 'bg-yellow-100 text-yellow-800', '低': 'bg-green-100 text-green-800' };
                const columnHeaderColors = {
                    "構思中": "bg-purple-400",
                    "規劃中": "bg-blue-400",
                    "開發中": "bg-orange-400",
                    "測試中": "bg-teal-400",
                    "已終止": "bg-red-400",
                    "已完成": "bg-green-500"
                };

                statuses.forEach(status => {
                    const column = document.createElement('div');
                    column.className = 'bg-gray-100 rounded-lg flex flex-col h-full';
                    const projectsInStatus = filteredProjects.filter(p => p.status === status);
                    
                    column.innerHTML = `
                        <div class="p-4 rounded-t-lg ${columnHeaderColors[status]} text-white flex justify-between items-center">
                            <h2 class="font-bold text-lg">${status}</h2>
                            <span class="bg-white/30 text-white text-sm font-semibold rounded-full px-2 py-0.5">${projectsInStatus.length}</span>
                        </div>
                        <div class="kanban-column-content p-4 space-y-4 overflow-y-auto flex-grow" style="min-height: 400px;"></div>
                    `;
                    
                    projectsInStatus.forEach(project => {
                        const card = document.createElement('div');
                        const borderColor = { '高': 'border-red-500', '中': 'border-yellow-500', '低': 'border-green-500' }[project.priority] || 'border-gray-300';
                        card.className = `bg-white p-4 rounded-lg shadow-md border-l-4 ${borderColor} project-card`;

                        // 根據配置動態構建卡片內容
                        let cardContent = `<h3 class="font-bold text-gray-800">${project.name}</h3>`;

                        // 部門
                        if (fieldConfig.department) {
                            cardContent += `<p class="text-sm text-gray-500 mt-1">${project.department}</p>`;
                        }

                        // 時間
                        if (fieldConfig.startTime || fieldConfig.dueDate) {
                            cardContent += `<div class="text-xs text-gray-400 mt-2">`;
                            if (fieldConfig.startTime) cardContent += `<span>始: ${project.startTime}</span>`;
                            if (fieldConfig.startTime && fieldConfig.dueDate) cardContent += ` | `;
                            if (fieldConfig.dueDate) cardContent += `<span>終: ${project.dueDate}</span>`;
                            cardContent += `</div>`;
                        }

                        // 評論和優先級
                        if (fieldConfig.comments || fieldConfig.priority) {
                            cardContent += `<div class="flex justify-between items-center mt-2">`;

                            if (fieldConfig.comments) {
                                const commentCount = project.comments ? project.comments.length : 0;
                                if (commentCount > 0) {
                                    cardContent += `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full"><i class="fas fa-comment mr-1"></i>${commentCount}</span>`;
                                } else {
                                    cardContent += `<span></span>`; // 佔位
                                }
                            }

                            if (fieldConfig.priority) {
                                cardContent += `<span class="text-xs font-semibold px-2 py-1 rounded-full ${priorityColors[project.priority]}">${project.priority}</span>`;
                            }

                            cardContent += `</div>`;
                        }

                        // 進度
                        if (fieldConfig.progress) {
                            cardContent += `
                                <div class="mt-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">進度</span>
                                        <span class="text-sm font-medium text-gray-700">${project.progress}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${project.progress}%"></div>
                                    </div>
                                </div>
                            `;
                        }

                        card.innerHTML = cardContent;
                        card.addEventListener('click', () => openProjectModal(project));
                        column.querySelector('.kanban-column-content').appendChild(card);
                    });
                    
                    board.appendChild(column);
                });

                // 統計資料（添加詳細除錯日誌）
                console.log('📊 專案統計除錯：');
                console.log('所有專案:', filteredProjects.map(p => ({ id: p.id, name: p.name, status: p.status })));

                const total = filteredProjects.length;
                const completed = filteredProjects.filter(p => p.status === '已完成').length;
                const inProgress = filteredProjects.filter(p => ['開發中', '測試中'].includes(p.status)).length;
                const planning = filteredProjects.filter(p => ['構思中', '規劃中'].includes(p.status)).length;
                const shutdown = filteredProjects.filter(p => ['已終止'].includes(p.status)).length;

                // 檢查是否有未分類的專案
                const categorized = completed + inProgress + planning + shutdown;
                const uncategorized = filteredProjects.filter(p =>
                    !['已完成', '開發中', '測試中', '構思中', '規劃中', '已終止'].includes(p.status)
                );

                if (uncategorized.length > 0) {
                    console.warn('⚠️ 發現未分類的專案:', uncategorized.map(p => ({ id: p.id, name: p.name, status: p.status })));
                }

                console.log(`總計: ${total}, 已完成: ${completed}, 進行中: ${inProgress}, 規劃中: ${planning}, 已終止: ${shutdown}`);
                console.log(`分類總和: ${categorized}, 差異: ${total - categorized}`);
                [
                    { label: '總專案數', value: total, color: 'bg-blue-100 text-blue-800' },
                    { label: '進行中', value: inProgress, color: 'bg-orange-100 text-orange-800' },
                    { label: '規劃/構思中', value: planning, color: 'bg-purple-100 text-purple-800' },
                    { label: '已終止', value: shutdown, color: 'bg-red-100 text-red-800' },
                    { label: '已完成', value: completed, color: 'bg-green-100 text-green-800' }
                ].forEach(stat => {
                    const statCard = document.createElement('div');
                    statCard.className = `p-4 rounded-lg shadow ${stat.color}`;
                    statCard.innerHTML = `
                        <div class="text-2xl font-bold">${stat.value}</div>
                        <div class="text-sm font-medium">${stat.label}</div>
                    `;
                    summaryContainer.appendChild(statCard);
                });
            }
        }

        // 專案相關函數
        function showAddProjectModal() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProjectModal() {
            document.getElementById('add-project-modal').classList.remove('show');
        }

        function addNewProject() {
            const newProject = {
                id: generateUniqueId(),  // 使用可靠的 ID 生成器
                name: document.getElementById('new-project-name').value,
                department: document.getElementById('new-project-department').value,
                startTime: document.getElementById('new-project-start').value || 'unknown',
                dueDate: document.getElementById('new-project-due').value || 'unknown',
                priority: document.getElementById('new-project-priority').value,
                status: document.getElementById('new-project-status').value,
                progress: parseInt(document.getElementById('new-project-progress').value) || 0,
                notes: "",
                files: [],
                comments: []
            };

            if (!newProject.name || !newProject.department) {
                alert('請填寫專案名稱和負責部門');
                return;
            }

            console.log('📝 準備新增專案:', newProject);

            // 先添加到本地陣列
            projects.push(newProject);

            // 同步到 Firebase 並等待結果
            syncToFirebase('projects/' + newProject.id, newProject)
                .then(() => {
                    console.log('✅ 專案新增成功:', newProject.name);
                    alert('✅ 專案「' + newProject.name + '」新增成功！');
                    closeAddProjectModal();
                    renderAiDashboard();

                    // 清空表單
                    document.getElementById('new-project-name').value = '';
                    document.getElementById('new-project-department').value = '';
                    document.getElementById('new-project-start').value = '';
                    document.getElementById('new-project-due').value = '';
                    document.getElementById('new-project-progress').value = '0';
                    document.getElementById('new-project-progress-value').textContent = '0%';
                })
                .catch((error) => {
                    // 同步失敗，從本地陣列移除
                    const index = projects.findIndex(p => p.id === newProject.id);
                    if (index > -1) {
                        projects.splice(index, 1);
                    }
                    console.error('❌ 專案新增失敗，已回滾本地資料');
                    renderAiDashboard();
                });
        }

        function reloadProjects() {
            if (!isFirebaseInitialized) {
                alert('Firebase 尚未初始化，無法重新載入');
                console.error('❌ Firebase 未初始化');
                return;
            }

            console.log('🔄 手動重新載入專案...');
            isProjectsLoading = true;

            database.ref('projects').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    projects = Object.values(data).sort((a, b) => a.id - b.id);
                    console.log('✅ 重新載入成功:', projects.length, '個專案');
                    alert(`成功載入 ${projects.length} 個專案`);
                } else {
                    console.warn('⚠️ Firebase 資料庫為空');
                    alert('資料庫中沒有專案資料');
                }
                renderAiDashboard();
                isProjectsLoading = false;
            }).catch(err => {
                console.error('❌ 重新載入失敗:', err);
                alert('載入失敗：' + err.message);
                isProjectsLoading = false;
            });
        }

        // 欄位配置管理
        let fieldConfig = {
            name: true,       // 必填，無法取消
            department: true,
            startTime: true,
            dueDate: true,
            priority: true,
            progress: true,
            status: true,
            comments: false
        };

        function loadFieldConfig() {
            const saved = localStorage.getItem('projectFieldConfig');
            if (saved) {
                try {
                    fieldConfig = JSON.parse(saved);
                    console.log('✅ 載入欄位配置:', fieldConfig);
                } catch (e) {
                    console.error('載入欄位配置失敗:', e);
                }
            }
        }

        function saveFieldConfig() {
            fieldConfig = {
                name: true, // 必填
                department: document.getElementById('field-department').checked,
                startTime: document.getElementById('field-startTime').checked,
                dueDate: document.getElementById('field-dueDate').checked,
                priority: document.getElementById('field-priority').checked,
                progress: document.getElementById('field-progress').checked,
                status: document.getElementById('field-status').checked,
                comments: document.getElementById('field-comments').checked
            };

            localStorage.setItem('projectFieldConfig', JSON.stringify(fieldConfig));
            console.log('✅ 儲存欄位配置:', fieldConfig);
            closeFieldConfigModal();
            renderAiDashboard();
            alert('欄位配置已套用');
        }

        function showFieldConfigModal() {
            // 根據當前配置設定勾選框
            document.getElementById('field-department').checked = fieldConfig.department;
            document.getElementById('field-startTime').checked = fieldConfig.startTime;
            document.getElementById('field-dueDate').checked = fieldConfig.dueDate;
            document.getElementById('field-priority').checked = fieldConfig.priority;
            document.getElementById('field-progress').checked = fieldConfig.progress;
            document.getElementById('field-status').checked = fieldConfig.status;
            document.getElementById('field-comments').checked = fieldConfig.comments;

            document.getElementById('field-config-modal').classList.add('show');
        }

        function closeFieldConfigModal() {
            document.getElementById('field-config-modal').classList.remove('show');
        }

        function applyFieldPreset(preset) {
            const presets = {
                minimal: {
                    name: true,
                    department: false,
                    startTime: false,
                    dueDate: false,
                    priority: true,
                    progress: true,
                    status: true,
                    comments: false
                },
                standard: {
                    name: true,
                    department: true,
                    startTime: true,
                    dueDate: true,
                    priority: true,
                    progress: true,
                    status: true,
                    comments: false
                },
                detailed: {
                    name: true,
                    department: true,
                    startTime: true,
                    dueDate: true,
                    priority: true,
                    progress: true,
                    status: true,
                    comments: true
                }
            };

            const config = presets[preset];
            if (config) {
                document.getElementById('field-department').checked = config.department;
                document.getElementById('field-startTime').checked = config.startTime;
                document.getElementById('field-dueDate').checked = config.dueDate;
                document.getElementById('field-priority').checked = config.priority;
                document.getElementById('field-progress').checked = config.progress;
                document.getElementById('field-status').checked = config.status;
                document.getElementById('field-comments').checked = config.comments;

                console.log('✅ 套用預設模式:', preset);
            }
        }

        function exportProjects() {
            const exportData = {
                exportDate: new Date().toISOString(),
                totalProjects: projects.length,
                projects: projects
            };

            // 提供選擇：JSON 或 CSV
            const format = confirm('選擇匯出格式：\n\n確定 = JSON\n取消 = CSV') ? 'json' : 'csv';

            if (format === 'json') {
                // JSON 匯出
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `projects_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('✅ 匯出 JSON 完成');
            } else {
                // CSV 匯出
                const headers = ['ID', '專案名稱', '負責部門', '開始時間', '截止日期', '優先級', '進度%', '狀態', '說明'];
                const csvRows = [headers.join(',')];

                projects.forEach(p => {
                    const row = [
                        p.id,
                        `"${p.name}"`,
                        `"${p.department}"`,
                        p.startTime,
                        p.dueDate,
                        p.priority,
                        p.progress,
                        p.status,
                        `"${(p.notes || '').replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvStr = '\uFEFF' + csvRows.join('\n'); // \uFEFF 是 BOM，讓 Excel 正確顯示中文
                const blob = new Blob([csvStr], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `projects_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('✅ 匯出 CSV 完成');
            }
        }

        function openProjectModal(project) {
            // 驗證專案存在性
            if (!project || !project.id) {
                alert('專案資料無效，請重新整理頁面');
                console.error('openProjectModal: 專案物件無效', project);
                return;
            }

            // 檢查專案是否正在載入（使用專案專用的載入標記）
            if (isProjectsLoading) {
                alert('專案資料載入中，請稍候再試');
                console.warn('專案資料載入中，無法開啟專案');
                return;
            }

            // 再次確認專案仍存在於陣列中（防止 Firebase 同步導致的競態條件）
            const verifiedProject = findProjectById(project.id);
            if (!verifiedProject) {
                alert('找不到此專案，可能已被刪除或資料尚未同步完成\n請重新整理頁面後再試');
                console.error('openProjectModal: 找不到專案 ID', project.id, '| 當前專案列表:', projects.map(p => p.id));
                return;
            }

            currentProjectId = project.id;
            editMode = false;

            // 顯示檢視模式，隱藏編輯模式
            document.getElementById('project-info-view').classList.remove('hidden');
            document.getElementById('project-info-edit').classList.add('hidden');
            document.getElementById('toggle-edit-mode').textContent = '編輯專案資訊';

            // 使用已驗證的專案資料
            // 填充資料
            document.getElementById('modal-project-name').textContent = verifiedProject.name;
            document.getElementById('modal-project-department').textContent = verifiedProject.department;
            document.getElementById('modal-start-date').textContent = verifiedProject.startTime;
            document.getElementById('modal-due-date').textContent = verifiedProject.dueDate;
            document.getElementById('modal-priority').textContent = verifiedProject.priority;
            document.getElementById('modal-status').textContent = verifiedProject.status;
            document.getElementById('modal-progress-text').textContent = `${verifiedProject.progress}%`;
            document.getElementById('modal-progress-bar').style.width = `${verifiedProject.progress}%`;

            // 備註
            document.getElementById('project-notes').value = verifiedProject.notes || '';

            // 根據 URL 角色參數設定評論者身份
            const commentAuthor = userRole === 'supervisor' ? '主管' : '員工';
            document.getElementById('comment-author').value = commentAuthor;
            document.getElementById('comment-role-text').textContent = commentAuthor;

            // 設定身份標籤樣式
            const roleIndicator = document.getElementById('comment-role-indicator');
            if (commentAuthor === '主管') {
                roleIndicator.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
            } else {
                roleIndicator.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800';
            }

            // 評論
            renderComments(verifiedProject.comments || []);

            // 檔案
            renderFilesList(verifiedProject.files || []);

            document.getElementById('project-modal').classList.add('show');
        }

        function toggleEditMode() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            editMode = !editMode;

            if (editMode) {
                // 進入編輯模式
                document.getElementById('project-info-view').classList.add('hidden');
                document.getElementById('project-info-edit').classList.remove('hidden');
                document.getElementById('toggle-edit-mode').textContent = '取消編輯';

                // 填充編輯表單
                document.getElementById('edit-project-name').value = project.name;
                document.getElementById('edit-department').value = project.department;
                document.getElementById('edit-start-date').value = project.startTime !== 'unknown' ? project.startTime : '';
                document.getElementById('edit-due-date').value = project.dueDate !== 'unknown' ? project.dueDate : '';
                document.getElementById('edit-priority').value = project.priority;
                document.getElementById('edit-status').value = project.status;
                document.getElementById('edit-progress').value = project.progress;
            } else {
                // 退出編輯模式
                document.getElementById('project-info-view').classList.remove('hidden');
                document.getElementById('project-info-edit').classList.add('hidden');
                document.getElementById('toggle-edit-mode').textContent = '編輯專案資訊';
            }
        }

        function saveProjectEdit() {
            const project = findProjectById(currentProjectId);
            if (!project) {
                console.error('saveProjectEdit: 找不到專案 ID:', currentProjectId);
                alert('找不到專案，可能已被刪除\n請關閉視窗並重新整理頁面');
                return;
            }

            // 檢查所有編輯欄位是否存在
            const nameField = document.getElementById('edit-project-name');
            const deptField = document.getElementById('edit-department');
            const startField = document.getElementById('edit-start-date');
            const dueField = document.getElementById('edit-due-date');
            const priorityField = document.getElementById('edit-priority');
            const statusField = document.getElementById('edit-status');
            const progressField = document.getElementById('edit-progress');

            if (!nameField || !deptField || !priorityField || !statusField || !progressField) {
                console.error('編輯欄位不存在');
                alert('編輯欄位載入錯誤，請重新開啟專案');
                return;
            }

            // 更新專案資料
            project.name = nameField.value;
            project.department = deptField.value;
            project.startTime = startField?.value || 'unknown';
            project.dueDate = dueField?.value || 'unknown';
            project.priority = priorityField.value;
            project.status = statusField.value;
            project.progress = parseInt(progressField.value) || 0;

            // 同步到Firebase
            syncToFirebase('projects/' + project.id, project);

            // 切換回檢視模式
            editMode = false;

            // 更新顯示
            openProjectModal(project);
            renderAiDashboard();

            console.log('專案已更新:', project);
            alert('專案資訊已儲存');
        }

        function deleteProject() {
            if (isReadOnly) {
                alert('主管角色無法刪除專案');
                return;
            }
            if (!currentProjectId) return;

            if (!confirm('確定要刪除此專案嗎？此操作無法復原。')) return;

            const index = projects.findIndex(p => p.id === currentProjectId);
            if (index > -1) {
                projects.splice(index, 1);
                if (isFirebaseInitialized) {
                    database.ref('projects/' + currentProjectId).remove();
                }
            }

            closeProjectModal();
            renderAiDashboard();
        }

        function saveNotes() {
            const project = findProjectById(currentProjectId);
            if (!project) {
                console.error('saveNotes: 找不到專案 ID:', currentProjectId);
                alert('找不到專案，可能已被刪除或資料尚未同步\n請關閉視窗並重新整理頁面');
                return;
            }

            const notesField = document.getElementById('project-notes');
            if (!notesField) {
                console.error('saveNotes: 找不到說明欄位');
                alert('說明欄位載入錯誤，請重新整理頁面');
                return;
            }

            // 更新專案說明
            project.notes = notesField.value;

            // 同步到Firebase (同步整個專案以確保一致性)
            syncToFirebase('projects/' + project.id, project);

            console.log('說明已儲存:', project.notes);
            alert('專案說明已儲存');
        }

        function addComment() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const text = document.getElementById('new-comment').value.trim();
            if (!text) {
                alert('請輸入評論內容');
                return;
            }

            if (!project.comments) project.comments = [];

            const comment = {
                id: generateUniqueId(),
                author: document.getElementById('comment-author').value,
                text: text,
                timestamp: new Date().toISOString()
            };

            project.comments.push(comment);
            syncToFirebase('projects/' + project.id + '/comments', project.comments);

            document.getElementById('new-comment').value = '';
            renderComments(project.comments);
        }

        function renderComments(comments) {
            const list = document.getElementById('comments-list');

            if (!comments || comments.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 text-center">尚無評論</p>';
                return;
            }

            list.innerHTML = comments.map(comment => {
                const date = new Date(comment.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isManager = comment.author === '主管';

                return `
                    <div class="comment-bubble ${isManager ? 'manager' : ''}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm ${isManager ? 'text-red-800' : 'text-gray-800'}">
                                <i class="fas fa-user-circle mr-1"></i>${comment.author}
                            </span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <p class="text-gray-700">${comment.text}</p>
                    </div>
                `;
            }).join('');
        }

        function renderFilesList(files) {
            const list = document.getElementById('files-list');
            
            if (!files || files.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400">尚未上傳檔案</p>';
                return;
            }

            list.innerHTML = files.map((file, idx) => `
                <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-3 py-2">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-gray-400"></i>
                        <span class="text-sm text-gray-700 break-all">${file.name}</span>
                        ${file.size ? `<span class="text-xs text-gray-400">(${formatSize(file.size)})</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        ${file.url ? `<a href="${file.url}" target="_blank" class="text-blue-600 text-sm hover:underline">下載</a>` : ''}
                        <button onclick="deleteFileAt(${idx})" class="text-red-600 text-sm">刪除</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteFileAt(index) {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project || !project.files) return;

            const file = project.files[index];
            
            if (isFirebaseInitialized && file.url) {
                storage.refFromURL(file.url).delete().catch(err => console.error('刪除檔案失敗:', err));
            }

            project.files.splice(index, 1);
            syncToFirebase('projects/' + project.id + '/files', project.files);
            renderFilesList(project.files);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes/1024).toFixed(1)} KB`;
            return `${(bytes/1024/1024).toFixed(1)} MB`;
        }

        function exportCurrentProject() {
            const project = findProjectById(currentProjectId);
            if (!project) {
                console.error('exportCurrentProject: 找不到專案 ID:', currentProjectId);
                alert('找不到專案，無法匯出\n請關閉視窗並重新整理頁面');
                return;
            }

            try {
                // 準備匯出資料
                const exportData = {
                    ...project,
                    exportTime: new Date().toISOString(),
                    exportBy: '系統管理員'
                };

                // 創建JSON內容
                const jsonContent = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // 創建下載連結
                const a = document.createElement('a');
                a.href = url;
                a.download = `${project.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}-專案詳情-${new Date().toISOString().slice(0, 10)}.json`;

                // 執行下載
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // 清理URL
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log('專案已匯出:', project.name);
                alert('專案匯出成功！');

            } catch (error) {
                console.error('匯出失敗:', error);
                alert('匯出失敗，請稍後再試');
            }
        }

        function closeProjectModal() {
            document.getElementById('project-modal').classList.remove('show');
            currentProjectId = null;
        }

        // === 2. 例行公事儀表板 ===

        // 搜尋與篩選狀態
        let routineSearchTerm = '';
        let routineFilterType = 'all';
        let searchDebounceTimer = null;

        // 防抖搜尋處理
        function handleRoutineSearch(searchTerm) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                routineSearchTerm = searchTerm.toLowerCase().trim();
                renderRoutineDashboard();
                console.log('搜尋任務:', routineSearchTerm);
            }, 300); // 300ms 防抖延遲
        }

        // 篩選處理
        function filterRoutineTasks(filterType) {
            routineFilterType = filterType;

            // 更新按鈕樣式
            document.querySelectorAll('.routine-filter-btn').forEach(btn => {
                if (btn.dataset.filter === filterType) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white', 'active');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'active');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            renderRoutineDashboard();
            console.log('篩選類型:', filterType);
        }

        // 檢查任務是否符合搜尋和篩選條件
        function shouldShowTask(task, taskType) {
            const today = new Date();

            // 搜尋過濾
            if (routineSearchTerm && !task.task.toLowerCase().includes(routineSearchTerm)) {
                return false;
            }

            // 類型篩選
            if (routineFilterType !== 'all') {
                // 完成狀態篩選
                if (routineFilterType === 'completed') {
                    const status = getTaskCompletionStatus(task, today);
                    if (!status.completed) return false;
                } else if (routineFilterType === 'pending') {
                    const status = getTaskCompletionStatus(task, today);
                    if (status.completed) return false;
                }
                // 任務類型篩選
                else if (routineFilterType !== taskType) {
                    return false;
                }
            }

            return true;
        }

        // 完成追蹤輔助函式
        function getDateKey(date = new Date()) {
            // 將日期轉換為 YYYY-MM-DD 格式作為鍵值
            return date.toISOString().split('T')[0];
        }

        function getTaskCompletionStatus(task, date = new Date()) {
            // 查詢特定日期的完成狀態
            if (!task.completionHistory) task.completionHistory = {};
            const dateKey = getDateKey(date);
            return task.completionHistory[dateKey] || { completed: false };
        }

        function toggleTaskCompletion(taskType, taskIndex, date = new Date()) {
            // 切換任務完成狀態
            const task = routineTasks[taskType][taskIndex];
            if (!task) {
                console.error('找不到任務:', taskType, taskIndex);
                return;
            }

            if (!task.completionHistory) task.completionHistory = {};
            const dateKey = getDateKey(date);

            // 切換狀態
            const currentStatus = task.completionHistory[dateKey] || { completed: false };
            task.completionHistory[dateKey] = {
                completed: !currentStatus.completed,
                timestamp: new Date().toISOString()
            };

            // 同步到 Firebase
            syncToFirebase('routineTasks', routineTasks);

            // 重新渲染儀表板
            renderRoutineDashboard();

            console.log(`任務 "${task.task}" 於 ${dateKey} 標記為 ${task.completionHistory[dateKey].completed ? '已完成' : '未完成'}`);
        }

        function calculateTodayCompletionRate() {
            // 計算今日完成率
            const today = new Date();
            const offCheck = isWeekendOrHoliday(today);

            // 週末或國定假日沒有任務
            if (offCheck.isOff) {
                return { completed: 0, total: 0, rate: 0 };
            }

            let totalTasks = 0;
            let completedTasks = 0;

            // 計算每日任務
            if (routineTasks.daily && Array.isArray(routineTasks.daily)) {
                routineTasks.daily.forEach(task => {
                    totalTasks++;
                    const status = getTaskCompletionStatus(task, today);
                    if (status.completed) completedTasks++;
                });
            }

            // 檢查是否在掃地週內
            if (routineTasks.threeWeeks && Array.isArray(routineTasks.threeWeeks)) {
                routineTasks.threeWeeks.forEach(task => {
                    if (task.nextWeekStart) {
                        // 修正：使用本地時區解析日期
                        const [y, m, d] = task.nextWeekStart.split('-').map(Number);
                        const weekStart = new Date(y, m - 1, d);
                        const weekEnd = new Date(y, m - 1, d + 4);

                        if (today >= weekStart && today <= weekEnd) {
                            totalTasks++;
                            const status = getTaskCompletionStatus(task, today);
                            if (status.completed) completedTasks++;
                        }
                    }
                });
            }

            const rate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            return { completed: completedTasks, total: totalTasks, rate };
        }

        function renderRoutineDashboard() {
            const container = document.getElementById('routine-tasks-content');
            if (!container) {
                console.error('例行公事容器未找到');
                return;
            }

            // 安全檢查：確保 routineTasks 已初始化
            if (!routineTasks) {
                console.warn('例行任務資料尚未載入');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">資料載入中...</div>';
                return;
            }

            // 檢查是否有任何任務
            const hasAnyTask = (routineTasks.daily && routineTasks.daily.length > 0) ||
                              (routineTasks.custom && routineTasks.custom.length > 0) ||
                              (routineTasks.threeWeeks && routineTasks.threeWeeks.length > 0) ||
                              (routineTasks.monthly && routineTasks.monthly.length > 0) ||
                              (routineTasks.bimonthly && routineTasks.bimonthly.length > 0);

            if (!hasAnyTask) {
                console.log('📝 例行任務資料庫為空');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-purple-50 rounded-lg p-12"><i class="fas fa-calendar-check text-6xl text-purple-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">尚無例行任務資料</p><p class="text-gray-500">點擊上方「新增任務」按鈕開始建立您的第一個例行任務</p></div>';
                return;
            }

            container.innerHTML = '';

            const today = new Date();
            const offCheck = isWeekendOrHoliday(today);
            let todayTasksHtml = '';

            // 計算今日完成率
            const completionStats = calculateTodayCompletionRate();

            if (!offCheck.isOff) {
                // 每日任務（加入勾選框）
                if (routineTasks.daily && Array.isArray(routineTasks.daily)) {
                    routineTasks.daily.forEach((t, index) => {
                        const status = getTaskCompletionStatus(t, today);
                        const checkedClass = status.completed ? 'line-through opacity-60' : '';
                        const checkIcon = status.completed ? 'fa-check-square' : 'fa-square';

                        todayTasksHtml += `
                            <div class="flex justify-between items-center py-2 border-b border-blue-100 last:border-b-0 hover:bg-blue-50 transition-colors">
                                <div class="flex items-center space-x-3 flex-1">
                                    <button onclick="toggleTaskCompletion('daily', ${index})"
                                            class="text-blue-600 hover:text-blue-800 text-xl">
                                        <i class="far ${checkIcon}"></i>
                                    </button>
                                    <span class="text-blue-800 font-medium ${checkedClass}">${t.task}</span>
                                </div>
                                <span class="text-blue-600 text-sm">${t.time}</span>
                            </div>
                        `;
                    });
                }

                // 檢查是否在掃地週內（加入勾選框）
                if (routineTasks.threeWeeks && Array.isArray(routineTasks.threeWeeks)) {
                    routineTasks.threeWeeks.forEach((t, index) => {
                        if (t.nextWeekStart) {
                            // 修正：使用本地時區解析日期
                            const [y, m, d] = t.nextWeekStart.split('-').map(Number);
                            const weekStart = new Date(y, m - 1, d);
                            const weekEnd = new Date(y, m - 1, d + 4); // 週五

                            if (today >= weekStart && today <= weekEnd) {
                                const status = getTaskCompletionStatus(t, today);
                                const checkedClass = status.completed ? 'line-through opacity-60' : '';
                                const checkIcon = status.completed ? 'fa-check-square' : 'fa-square';

                                todayTasksHtml += `
                                    <div class="flex justify-between items-center py-2 border-b border-blue-100 last:border-b-0 hover:bg-green-50 transition-colors">
                                        <div class="flex items-center space-x-3 flex-1">
                                            <button onclick="toggleTaskCompletion('threeWeeks', ${index})"
                                                    class="text-green-600 hover:text-green-800 text-xl">
                                                <i class="far ${checkIcon}"></i>
                                            </button>
                                            <span class="text-green-800 font-medium ${checkedClass}">${t.task}</span>
                                        </div>
                                        <span class="text-green-600 text-sm">${t.time}</span>
                                    </div>
                                `;
                            }
                        }
                    });
                }
            } else {
                // 顯示假日訊息
                const holidayMessage = offCheck.reason === '週末'
                    ? '今日為週末，無例行公事。'
                    : `今日為國定假日 (${offCheck.reason})，無例行公事。`;
                todayTasksHtml = `<p class="text-blue-600"><i class="fas fa-calendar-times mr-2"></i>${holidayMessage}</p>`;
            }

            const taskSections = [
                { title: '每日任務 (週一至週五，排除國定假日)', tasks: routineTasks.daily, icon: 'fa-calendar-day', color: 'blue', type: 'daily' },
                { title: '自定義週期任務', tasks: routineTasks.custom || [], icon: 'fa-calendar-check', color: 'teal', type: 'custom' },
                // 舊的任務類型（向後兼容）
                { title: '三週一次', tasks: routineTasks.threeWeeks || [], icon: 'fa-calendar-week', color: 'green', type: 'threeWeeks' },
                { title: '每月任務', tasks: routineTasks.monthly || [], icon: 'fa-calendar-alt', color: 'purple', type: 'monthly' },
                { title: '雙月任務', tasks: routineTasks.bimonthly || [], icon: 'fa-calendar', color: 'orange', type: 'bimonthly' }
            ];

            const taskSectionsHtml = taskSections.map(section => {
                // 安全檢查：確保 tasks 數組存在
                if (!section.tasks || !Array.isArray(section.tasks)) {
                    return '';
                }

                // 應用搜尋和篩選
                const filteredTasks = section.tasks.filter(t => shouldShowTask(t, section.type));

                // 如果該區塊沒有符合的任務，不顯示整個區塊
                if (filteredTasks.length === 0 && (routineSearchTerm || routineFilterType !== 'all')) {
                    return '';
                }

                const tasksHtml = filteredTasks.map((t, index) => {
                    // 需要找到原始索引以正確操作
                    const originalIndex = section.tasks.indexOf(t);
                    let display = '';
                    if (t.time) display = `<span class="text-${section.color}-600 text-sm">${t.time}</span>`;
                    if (t.day) display = `<span class="text-${section.color}-600 text-sm">每月${t.day}日</span>`;

                    // 顯示下次執行日期
                    let nextDateDisplay = '';
                    if (section.type === 'custom' && t.customPeriod) {
                        // 自定義週期任務
                        const unitNames = { days: '天', weeks: '週', months: '月' };
                        const periodText = `每 ${t.customPeriod.interval} ${unitNames[t.customPeriod.unit] || t.customPeriod.unit}`;
                        nextDateDisplay = `
                            <div class="flex flex-col space-y-1">
                                <span class="text-xs text-${section.color}-600 bg-${section.color}-100 px-2 py-0.5 rounded-full inline-block w-fit">${periodText}</span>
                                ${t.nextDate ? `<span class="text-sm text-${section.color}-700 font-semibold">下次: ${t.nextDate}</span>` : ''}
                            </div>
                        `;
                    } else if (section.type === 'threeWeeks') {
                        if (t.nextWeekStart) {
                            // 修正：使用本地時區解析和格式化日期
                            const [y, m, d] = t.nextWeekStart.split('-').map(Number);
                            const weekStart = new Date(y, m - 1, d);
                            const weekEnd = new Date(y, m - 1, d + 4); // 週五
                            const startStr = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            const endStr = `${weekEnd.getFullYear()}-${String(weekEnd.getMonth() + 1).padStart(2, '0')}-${String(weekEnd.getDate()).padStart(2, '0')}`;
                            nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">下次掃地週: ${startStr} ~ ${endStr}</span>`;
                        } else if (t.lastWeekStart) {
                            // 自動計算下次掃地週（上次週一 + 21天）- 修正：使用本地時區
                            const [y, m, d] = t.lastWeekStart.split('-').map(Number);
                            const nextStart = new Date(y, m - 1, d + 21);
                            const weekEnd = new Date(y, m - 1, d + 25); // 3週後的週五
                            const startStr = `${nextStart.getFullYear()}-${String(nextStart.getMonth() + 1).padStart(2, '0')}-${String(nextStart.getDate()).padStart(2, '0')}`;
                            const endStr = `${weekEnd.getFullYear()}-${String(weekEnd.getMonth() + 1).padStart(2, '0')}-${String(weekEnd.getDate()).padStart(2, '0')}`;
                            nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">下次掃地週: ${startStr} ~ ${endStr}</span>`;
                        } else {
                            nextDateDisplay = `<span class="text-sm text-gray-500">未設定</span>`;
                        }
                    } else if (section.type === 'monthly' && t.nextDate) {
                        nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">下次: ${t.nextDate}</span>`;
                    } else if (section.type === 'bimonthly' && t.nextDate) {
                        nextDateDisplay = `<span class="text-sm text-${section.color}-700 font-semibold">下次: ${t.nextDate}</span>`;
                    }

                    let dateButton = '';
                    if ((section.type === 'monthly' && !t.day) || section.type === 'bimonthly') {
                        const currentMonth = new Date().toISOString().substring(0, 7);
                        const dateDisplay = t.dates && t.dates[currentMonth]
                            ? `<span class="text-sm text-${section.color}-700">本月: ${t.dates[currentMonth]}</span>`
                            : `<span class="text-sm text-orange-600">⚠️ 本月未設定</span>`;

                        dateButton = `
                            <div class="flex items-center space-x-2">
                                ${dateDisplay}
                                <button onclick="openRoutineDateModal('${section.type}', ${originalIndex})"
                                        title="點擊設定本月執行日期"
                                        class="text-${section.color}-600 hover:text-${section.color}-800 text-sm px-2 py-1 border border-${section.color}-300 rounded hover:bg-${section.color}-50">
                                    <i class="fas fa-calendar-plus mr-1"></i>設定日期
                                </button>
                            </div>
                        `;
                    }

                    // 編輯/刪除按鈕（僅專案管理師可見）
                    const editDeleteButtons = !isReadOnly ? `
                        <button onclick="editRoutineTask('${section.type}', ${originalIndex})" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteRoutineTask('${section.type}', ${originalIndex})" class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : '';

                    return `
                        <div class="flex justify-between items-center py-2 border-b border-${section.color}-100 last:border-b-0">
                            <div class="flex-1">
                                <span class="text-${section.color}-800">${t.task}</span>
                                ${nextDateDisplay ? `<div class="mt-1">${nextDateDisplay}</div>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                ${display}
                                ${dateButton}
                                ${editDeleteButtons}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-${section.color}-50 p-4 rounded-lg border border-${section.color}-200">
                        <h3 class="flex items-center text-lg font-bold text-${section.color}-800 mb-3">
                            <i class="fas ${section.icon} mr-2"></i>${section.title}
                        </h3>
                        <div class="space-y-2">${tasksHtml}</div>
                    </div>
                `;
            }).join('');

            // 完成進度條 HTML
            const progressBarHtml = dayOfWeek >= 1 && dayOfWeek <= 5 ? `
                <div class="mt-3 pt-3 border-t border-blue-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-blue-700">今日完成進度</span>
                        <span class="text-sm font-bold text-blue-800">${completionStats.completed}/${completionStats.total} (${completionStats.rate}%)</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${completionStats.rate}%"></div>
                    </div>
                    ${completionStats.rate === 100 ? '<p class="text-sm text-green-600 font-semibold mt-2">🎉 太棒了！今日任務全部完成！</p>' : ''}
                    ${completionStats.rate === 0 && completionStats.total > 0 ? '<p class="text-sm text-orange-600 mt-2">⚠️ 尚未開始今日任務</p>' : ''}
                </div>
            ` : '';

            container.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm">
                    <h2 class="text-xl font-bold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-tasks mr-2"></i>今日待辦
                    </h2>
                    <div class="space-y-2">${todayTasksHtml}</div>
                    ${progressBarHtml}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">${taskSectionsHtml}</div>
            `;

            renderCalendar();
        }

        function renderCalendar() {
            const header = document.getElementById('calendar-header');
            const body = document.getElementById('calendar-body');
            
            header.innerHTML = `
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-bold text-gray-800 w-32 text-center">${calendarDate.getFullYear()} / ${String(calendarDate.getMonth() + 1).padStart(2, '0')}</h2>
                    <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="text-sm text-gray-500">顯示所有例行任務</div>
            `;

            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            let calendarHtml = `
                <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
                    ${['日', '一', '二', '三', '四', '五', '六'].map(d => 
                        `<div class="text-center font-semibold py-2 bg-gray-100">${d}</div>`
                    ).join('')}
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
            `;

            for (let i = 0; i < startDayOfWeek; i++) {
                calendarHtml += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const offCheck = isWeekendOrHoliday(currentDate);
                let tasksHtml = '';

                // 標示國定假日
                if (offCheck.reason && offCheck.reason !== '週末') {
                    tasksHtml += `<div class="calendar-task bg-red-100 text-red-600 font-semibold border border-red-300">
                        <i class="fas fa-flag text-xs mr-1"></i>${offCheck.reason}
                    </div>`;
                }

                // 每日任務（排除週末和國定假日）
                if (!offCheck.isOff) {
                    routineTasks.daily.forEach(t => {
                        const shortTask = t.task.length > 15 ? t.task.substring(0, 12) + '...' : t.task;
                        tasksHtml += `<div class="calendar-task bg-blue-100 text-blue-800">${shortTask}</div>`;
                    });
                }

                // 三週一次任務（掃地週：週一到週五，排除國定假日）
                if (!offCheck.isOff) {
                    routineTasks.threeWeeks.forEach(task => {
                        if (task.nextWeekStart) {
                            // 修正：使用本地時區解析日期，避免 UTC 時區差異
                            const [y, m, d] = task.nextWeekStart.split('-').map(Number);
                            const weekStart = new Date(y, m - 1, d); // month 是 0-indexed
                            const weekEnd = new Date(y, m - 1, d + 4); // 週五

                            // 除錯訊息（只在檢查日曆第一天時輸出）
                            if (day === 1) {
                                console.log('日曆三週任務檢查:', {
                                    task: task.task,
                                    nextWeekStart: task.nextWeekStart,
                                    weekStart: weekStart.toLocaleDateString('zh-TW'),
                                    weekEnd: weekEnd.toLocaleDateString('zh-TW'),
                                    currentMonth: `${year}-${String(month + 1).padStart(2, '0')}`,
                                    比較測試: currentDate >= weekStart && currentDate <= weekEnd
                                });
                            }

                            if (currentDate >= weekStart && currentDate <= weekEnd) {
                                const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                                tasksHtml += `<div class="calendar-task bg-green-100 text-green-800">${shortTask}</div>`;
                            }
                        } else if (task.lastWeekStart) {
                            // 自動計算下次掃地週 - 修正：使用本地時區
                            const [y, m, d] = task.lastWeekStart.split('-').map(Number);
                            const nextWeekStart = new Date(y, m - 1, d + 21); // 3週後
                            const weekEnd = new Date(y, m - 1, d + 25); // 3週後的週五

                            if (currentDate >= nextWeekStart && currentDate <= weekEnd) {
                                const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                                tasksHtml += `<div class="calendar-task bg-green-100 text-green-800">${shortTask}</div>`;
                            }
                        }
                    });
                }

                // 自定義週期任務
                if (routineTasks.custom) {
                    routineTasks.custom.forEach(task => {
                        if (task.customPeriod && task.customPeriod.startDate) {
                            const startDate = new Date(task.customPeriod.startDate + 'T00:00:00');
                            const interval = task.customPeriod.interval;
                            const unit = task.customPeriod.unit;

                            // 計算從開始日期到當前日期的天數差
                            const daysDiff = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));

                            let shouldDisplay = false;

                            if (unit === 'days') {
                                // 每 N 天
                                shouldDisplay = daysDiff >= 0 && daysDiff % interval === 0;
                            } else if (unit === 'weeks') {
                                // 每 N 週（7 * N 天）
                                const weekInterval = interval * 7;
                                shouldDisplay = daysDiff >= 0 && daysDiff % weekInterval === 0;
                            } else if (unit === 'months') {
                                // 每 N 月（檢查月份差和日期）
                                const monthsDiff = (currentDate.getFullYear() - startDate.getFullYear()) * 12 +
                                                  (currentDate.getMonth() - startDate.getMonth());
                                shouldDisplay = monthsDiff >= 0 &&
                                               monthsDiff % interval === 0 &&
                                               currentDate.getDate() === startDate.getDate();
                            }

                            if (shouldDisplay) {
                                const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                                tasksHtml += `<div class="calendar-task bg-teal-100 text-teal-800">${shortTask}</div>`;
                            }
                        }
                    });
                }

                // 每月任務
                if (routineTasks.monthly && Array.isArray(routineTasks.monthly)) {
                    routineTasks.monthly.forEach(task => {
                        // 固定日期（每月X日）
                        if (task.day && task.day === day) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${shortTask}</div>`;
                        }
                        // 下次執行日期
                        else if (task.nextDate === dateStr) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${shortTask}</div>`;
                        }
                        // 每月自定義日期
                        else if (task.dates && task.dates[currentMonthStr] === dateStr) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-purple-100 text-purple-800">${shortTask}</div>`;
                        }
                    });
                }

                // 雙月任務（下次執行日期）
                if (routineTasks.bimonthly && Array.isArray(routineTasks.bimonthly)) {
                    routineTasks.bimonthly.forEach(task => {
                        if (task.nextDate === dateStr) {
                            const shortTask = task.task.length > 15 ? task.task.substring(0, 12) + '...' : task.task;
                            tasksHtml += `<div class="calendar-task bg-orange-100 text-orange-800">${shortTask}</div>`;
                        } else if (task.dates && task.dates[currentMonthStr] === dateStr) {
                            // 舊的 dates 格式（向後兼容）
                            tasksHtml += `<div class="calendar-task bg-orange-100 text-orange-800">${task.task}</div>`;
                        }
                    });
                }

                const isToday = new Date().toDateString() === currentDate.toDateString() ? 'bg-blue-100' : 'bg-white';
                calendarHtml += `
                    <div class="calendar-day p-2 ${isToday}">
                        <div class="font-semibold text-right">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }

            calendarHtml += `</div>`;
            body.innerHTML = calendarHtml;
        }

        function changeMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            renderCalendar();
        }

        function showAddRoutineModal() {
            document.getElementById('add-routine-modal').classList.add('show');
        }

        function closeAddRoutineModal() {
            document.getElementById('add-routine-modal').classList.remove('show');
        }

        // 套用快速預設
        function applyPreset(preset) {
            const intervalInput = document.getElementById('new-routine-custom-interval');
            const unitSelect = document.getElementById('new-routine-custom-unit');

            if (preset === 'weekly') {
                intervalInput.value = '1';
                unitSelect.value = 'weeks';
            } else if (preset === 'monthly') {
                intervalInput.value = '1';
                unitSelect.value = 'months';
            } else if (preset === 'quarterly') {
                intervalInput.value = '3';
                unitSelect.value = 'months';
            }

            // 觸發下次日期計算
            calculateCustomNextDate();

            console.log('套用預設:', preset);
        }

        function updateRoutineFields() {
            const type = document.getElementById('new-routine-type').value;
            const timeField = document.getElementById('routine-time-field');
            const customField = document.getElementById('routine-custom-field');
            const nextDateField = document.getElementById('routine-next-date-field');
            const nextDateInput = document.getElementById('new-routine-next-date');
            const nextDateHint = document.getElementById('next-date-hint');
            const nextDateLabel = nextDateField.querySelector('label');

            // 重置所有欄位
            timeField.classList.add('hidden');
            customField.classList.add('hidden');
            nextDateField.classList.add('hidden');

            if (type === 'daily') {
                // 每日任務：顯示時間
                timeField.classList.remove('hidden');
            } else if (type === 'custom') {
                // 自定義週期：顯示週期設定和開始日期
                customField.classList.remove('hidden');
                nextDateField.classList.remove('hidden');
                nextDateLabel.textContent = '下次執行日期（自動計算）';
                nextDateInput.readOnly = true;
                nextDateInput.classList.add('bg-gray-100');
                nextDateHint.textContent = '根據開始日期和週期自動計算';
            }
        }

        function calculateNextDate() {
            const lastDate = document.getElementById('new-routine-last-date').value;
            if (!lastDate) {
                document.getElementById('new-routine-next-date').value = '';
                return;
            }

            // 計算下次日期（上次日期 + 21天）
            const date = new Date(lastDate);
            date.setDate(date.getDate() + 21);

            const nextDate = date.toISOString().split('T')[0];
            document.getElementById('new-routine-next-date').value = nextDate;
        }

        function calculateCustomNextDate() {
            const startDate = document.getElementById('new-routine-custom-start').value;
            const interval = parseInt(document.getElementById('new-routine-custom-interval').value);
            const unit = document.getElementById('new-routine-custom-unit').value;

            if (!startDate || !interval) {
                document.getElementById('new-routine-next-date').value = '';
                return;
            }

            const date = new Date(startDate);

            if (unit === 'days') {
                date.setDate(date.getDate() + interval);
            } else if (unit === 'weeks') {
                date.setDate(date.getDate() + (interval * 7));
            } else if (unit === 'months') {
                date.setMonth(date.getMonth() + interval);
            }

            const nextDate = date.toISOString().split('T')[0];
            document.getElementById('new-routine-next-date').value = nextDate;
        }

        function addNewRoutine() {
            const type = document.getElementById('new-routine-type').value;
            const taskName = document.getElementById('new-routine-task').value;

            if (!taskName) {
                alert('請輸入任務名稱');
                return;
            }

            const taskData = { task: taskName, completionHistory: {} };

            if (type === 'daily') {
                taskData.time = document.getElementById('new-routine-time').value;
            } else if (type === 'weekly') {
                // 每週任務：儲存時間和選中的星期幾
                taskData.time = document.getElementById('new-routine-time').value;
                const weekdayCheckboxes = document.querySelectorAll('.routine-weekday-checkbox:checked');
                taskData.weekdays = Array.from(weekdayCheckboxes).map(cb => parseInt(cb.value));

                if (taskData.weekdays.length === 0) {
                    alert('請至少選擇一個執行日');
                    return;
                }

                console.log('每週任務設定:', { task: taskName, weekdays: taskData.weekdays });
            } else if (type === 'threeWeeks') {
                taskData.time = document.getElementById('new-routine-time').value;
                const lastWeekStart = document.getElementById('new-routine-last-date').value;
                const nextWeekStart = document.getElementById('new-routine-next-date').value;

                taskData.lastWeekStart = lastWeekStart;
                taskData.nextWeekStart = nextWeekStart;

                // 加入除錯訊息
                console.log('三週任務設定:', {
                    task: taskName,
                    lastWeekStart,
                    nextWeekStart
                });
            } else if (type === 'monthly') {
                const day = document.getElementById('new-routine-day').value;
                if (day) {
                    taskData.day = parseInt(day);
                } else {
                    taskData.dates = {};
                }
                const nextDate = document.getElementById('new-routine-next-date').value;
                if (nextDate) taskData.nextDate = nextDate;
            } else if (type === 'quarterly') {
                // 每季任務：儲存季度月份和日期
                const quarterMonth = parseInt(document.getElementById('new-routine-quarter-month').value);
                const quarterDay = parseInt(document.getElementById('new-routine-quarter-day').value);
                const nextDate = document.getElementById('new-routine-next-date').value;

                if (!quarterDay || !nextDate) {
                    alert('請填寫日期和下次執行日期');
                    return;
                }

                taskData.quarterMonth = quarterMonth;  // 1, 2, or 3
                taskData.quarterDay = quarterDay;
                taskData.nextDate = nextDate;

                console.log('每季任務設定:', { task: taskName, quarterMonth, quarterDay, nextDate });
            } else if (type === 'bimonthly') {
                taskData.dates = {};
                const nextDate = document.getElementById('new-routine-next-date').value;
                if (nextDate) taskData.nextDate = nextDate;
            } else if (type === 'custom') {
                // 自定義週期任務
                const interval = parseInt(document.getElementById('new-routine-custom-interval').value);
                const unit = document.getElementById('new-routine-custom-unit').value;
                const startDate = document.getElementById('new-routine-custom-start').value;
                const nextDate = document.getElementById('new-routine-next-date').value;

                if (!interval || !startDate) {
                    alert('請填寫週期數量和開始日期');
                    return;
                }

                taskData.customPeriod = {
                    interval: interval,
                    unit: unit,
                    startDate: startDate
                };
                taskData.nextDate = nextDate;

                console.log('自定義週期任務設定:', { task: taskName, customPeriod: taskData.customPeriod, nextDate });
            }

            // 檢查是否為編輯模式
            if (currentRoutineTask && currentRoutineTask.isEditing) {
                // 編輯模式：更新現有任務
                const { type: oldType, index } = currentRoutineTask;

                // 保留原有的 completionHistory
                const oldTask = routineTasks[oldType][index];
                if (oldTask && oldTask.completionHistory) {
                    taskData.completionHistory = oldTask.completionHistory;
                }

                // 檢查類型是否改變
                if (type === oldType) {
                    // 類型未變：直接更新原位置
                    routineTasks[oldType][index] = taskData;
                    console.log('✅ 任務已更新（類型未變）:', type);
                } else {
                    // 類型已變：從舊陣列刪除，添加到新陣列
                    routineTasks[oldType].splice(index, 1);
                    if (!routineTasks[type]) routineTasks[type] = [];
                    routineTasks[type].unshift(taskData);
                    console.log('✅ 任務已更新（類型改變）:', oldType, '→', type);
                }
                alert('任務已更新');
            } else {
                // 新增模式：添加新任務到列表最上方
                if (!routineTasks[type]) routineTasks[type] = [];
                routineTasks[type].unshift(taskData);  // 使用 unshift 將新任務插入到開頭
                console.log('✅ 新增任務:', type, '-', taskName);
                alert('任務已新增');
            }

            syncToFirebase('routineTasks', routineTasks);
            closeAddRoutineModal();
            renderRoutineDashboard();

            // 清空表單
            document.getElementById('new-routine-task').value = '';
            document.getElementById('new-routine-time').value = '';
            document.getElementById('new-routine-day').value = '';
            document.getElementById('new-routine-last-date').value = '';
            document.getElementById('new-routine-next-date').value = '';
            currentRoutineTask = null;
        }

        function openRoutineDateModal(type, index) {
            const task = routineTasks[type][index];
            currentRoutineTask = { type, index };

            document.getElementById('routine-task-name').value = task.task;
            document.getElementById('routine-task-date').value = '';
            document.getElementById('routine-date-modal').classList.add('show');
        }

        function closeRoutineModal() {
            document.getElementById('routine-date-modal').classList.remove('show');
            currentRoutineTask = null;
        }

        function saveRoutineDate() {
            if (!currentRoutineTask) return;

            const date = document.getElementById('routine-task-date').value;
            if (!date) {
                alert('請選擇日期');
                return;
            }

            const task = routineTasks[currentRoutineTask.type][currentRoutineTask.index];
            const month = date.substring(0, 7);

            if (!task.dates) task.dates = {};
            task.dates[month] = date;

            syncToFirebase('routineTasks', routineTasks);
            closeRoutineModal();
            renderRoutineDashboard();
        }

        function editRoutineTask(type, index) {
            if (isReadOnly) {
                alert('主管角色無法編輯例行任務');
                return;
            }

            const task = routineTasks[type][index];
            if (!task) {
                alert('找不到該任務');
                return;
            }

            // 填充編輯表單
            document.getElementById('new-routine-type').value = type;
            document.getElementById('new-routine-task').value = task.task;

            if (task.time) {
                document.getElementById('new-routine-time').value = task.time;
            }
            if (task.day) {
                document.getElementById('new-routine-day').value = task.day;
            }
            if (task.lastDate) {
                // 向後兼容舊的 lastDate 欄位
                document.getElementById('new-routine-last-date').value = task.lastDate;
            }
            if (task.lastWeekStart) {
                document.getElementById('new-routine-last-date').value = task.lastWeekStart;
            }
            if (task.nextDate) {
                // 向後兼容舊的 nextDate 欄位
                document.getElementById('new-routine-next-date').value = task.nextDate;
            }
            if (task.nextWeekStart) {
                document.getElementById('new-routine-next-date').value = task.nextWeekStart;
            }
            // 自定義週期任務
            if (task.customPeriod) {
                document.getElementById('new-routine-custom-interval').value = task.customPeriod.interval;
                document.getElementById('new-routine-custom-unit').value = task.customPeriod.unit;
                document.getElementById('new-routine-custom-start').value = task.customPeriod.startDate;
            }

            updateRoutineFields();

            // 保存當前編輯的任務資訊
            currentRoutineTask = { type, index, isEditing: true };

            document.getElementById('add-routine-modal').classList.add('show');
        }

        function deleteRoutineTask(type, index) {
            if (isReadOnly) {
                alert('主管角色無法刪除例行任務');
                return;
            }

            if (!confirm('確定要刪除此例行任務嗎？')) return;

            routineTasks[type].splice(index, 1);
            syncToFirebase('routineTasks', routineTasks);
            renderRoutineDashboard();
            alert('任務已刪除');
        }

        // === 3. 分享會儀表板 ===
        let sharingSearchTerm = '';

        function handleSharingSearch(value) {
            sharingSearchTerm = value.toLowerCase();
            renderSharingDashboard();
            console.log('搜尋分享會:', sharingSearchTerm);
        }

        function matchesSearch(session, searchTerm) {
            if (!searchTerm) return true;

            // 搜尋主題
            if (session.theme && session.theme.toLowerCase().includes(searchTerm)) return true;

            // 搜尋講者
            if (session.speaker && session.speaker.toLowerCase().includes(searchTerm)) return true;

            // 搜尋議程內容
            if (session.schedule && Array.isArray(session.schedule)) {
                if (session.schedule.some(item => item.toLowerCase().includes(searchTerm))) {
                    return true;
                }
            }

            return false;
        }

        function renderSharingDashboard() {
            const container = document.getElementById('sharing-session-content');
            if (!container) {
                console.error('分享會容器未找到');
                return;
            }

            // 安全檢查：確保 sharingSessions 已初始化
            if (!sharingSessions || !Array.isArray(sharingSessions)) {
                console.warn('分享會資料尚未載入');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">資料載入中...</div>';
                return;
            }

            // 如果資料為空，顯示友善提示
            if (sharingSessions.length === 0) {
                console.log('📝 分享會資料庫為空');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-teal-50 rounded-lg p-12"><i class="fas fa-comments text-6xl text-teal-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">尚無分享會資料</p><p class="text-gray-500">點擊上方「新增分享會」按鈕開始建立您的第一場分享會</p></div>';
                return;
            }

            // 根據日期自動分類並套用搜尋過濾
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcoming = sharingSessions
                .filter(s => {
                    const sessionDate = new Date(s.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    return sessionDate >= today;
                })
                .filter(s => matchesSearch(s, sharingSearchTerm));

            const past = sharingSessions
                .filter(s => {
                    const sessionDate = new Date(s.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    return sessionDate < today;
                })
                .filter(s => matchesSearch(s, sharingSearchTerm));

            let upcomingHtml = upcoming.length > 0 ? upcoming.map(s => {
                const scheduleHtml = (s.schedule && Array.isArray(s.schedule))
                    ? s.schedule.map(item => `<li class="text-gray-600">${item}</li>`).join('')
                    : '<li class="text-gray-400">議程資料未設定</li>';
                const editDeleteButtons = !isReadOnly ? `
                    <div class="space-x-2">
                        <button onclick="editSharing(${s.id})" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSharing(${s.id})" class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';
                return `
                    <div class="bg-green-50 border border-green-200 p-6 rounded-lg mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-green-800">${s.theme}</h3>
                                <p class="text-green-600 mt-1">日期：${s.date} | 講者：${s.speaker}</p>
                            </div>
                            ${editDeleteButtons}
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">議程安排：</h4>
                            <ul class="list-disc list-inside space-y-1">${scheduleHtml}</ul>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500">目前沒有已排程的分享會。</p>';

            const pastHtml = past.map(s => {
                const content = (s.schedule && Array.isArray(s.schedule)) ? s.schedule.map(item => {
                    if (item.startsWith('http')) {
                        return `<li><a href="${item}" target="_blank" class="text-blue-600 hover:underline break-all">
                            <i class="fas fa-link mr-2"></i>連結</a></li>`;
                    }
                    if (/\.(pdf|pptx|zip|jpg)/i.test(item)) {
                        return `<li><i class="fas fa-file mr-2 text-gray-400"></i>${item}</li>`;
                    }
                    return `<li>${item}</li>`;
                }).join('') : '<li class="text-gray-400">議程資料未設定</li>';

                // 編輯和刪除按鈕（只有非只讀模式才顯示）
                const editDeleteButtons = !isReadOnly ? `
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editSharing(${s.id}); event.stopPropagation();" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSharing(${s.id}); event.stopPropagation();" class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs hover:bg-red-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';

                return `
                    <details class="p-4 border-b last:border-b-0">
                        <summary class="flex justify-between items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">${s.date}</p>
                                <p class="font-semibold text-gray-700">${s.theme}</p>
                            </div>
                            <div class="flex items-center">
                                ${editDeleteButtons}
                                <i class="fas fa-chevron-right summary-icon text-gray-400 ml-2"></i>
                            </div>
                        </summary>
                        <div class="mt-4 pl-4 border-l-2 border-gray-200">
                            <ul class="list-disc list-inside space-y-1 text-gray-600 mb-4">${content}</ul>

                            <!-- 評論區塊 -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-700 mb-3"><i class="fas fa-comments mr-2"></i>主管評論</h4>
                                <div id="sharing-comments-${s.id}" class="space-y-2 mb-3">
                                    ${renderSharingComments(s.comments || [])}
                                </div>
                                ${isReadOnly ? `
                                    <div class="mt-3">
                                        <input type="text" id="sharing-comment-${s.id}" placeholder="輸入您的評論..." class="w-full p-2 border rounded text-sm">
                                        <button onclick="addSharingComment(${s.id})" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                                            <i class="fas fa-paper-plane mr-1"></i>送出評論
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </details>
                `;
            }).join('');

            // 搜尋結果提示
            const totalResults = upcoming.length + past.length;
            const searchResultsHtml = sharingSearchTerm
                ? `<div class="mb-4 text-sm text-gray-600 bg-teal-50 p-3 rounded-lg">
                     找到 ${totalResults} 筆符合「${sharingSearchTerm}」的結果
                   </div>`
                : '';

            container.innerHTML = `
                ${searchResultsHtml}
                <h2 class="text-xl font-bold text-gray-800 mb-4">即將舉行的分享會</h2>
                ${upcomingHtml}
                <h2 class="text-xl font-bold text-gray-800 mt-10 mb-4">過往分享會紀錄</h2>
                <div class="border rounded-lg bg-gray-50">${pastHtml}</div>
            `;
        }

        function showAddSharingModal() {
            document.getElementById('add-sharing-modal').classList.add('show');
        }

        function closeAddSharingModal() {
            document.getElementById('add-sharing-modal').classList.remove('show');
        }

        function addNewSharing() {
            const schedule = document.getElementById('new-sharing-schedule').value.split('\n').filter(s => s.trim());
            
            const newSharing = {
                id: generateUniqueId(),
                date: document.getElementById('new-sharing-date').value,
                theme: document.getElementById('new-sharing-theme').value,
                speaker: document.getElementById('new-sharing-speaker').value,
                status: 'upcoming',
                schedule: schedule,
                comments: []
            };

            if (!newSharing.date || !newSharing.theme || !newSharing.speaker) {
                alert('請填寫所有必填欄位');
                return;
            }

            sharingSessions.push(newSharing);
            // 同步整個 sharingSessions 陣列以避免覆蓋問題
            syncToFirebase('sharingSessions', sharingSessions);
            
            closeAddSharingModal();
            renderSharingDashboard();
            
            // 清空表單
            document.getElementById('new-sharing-date').value = '';
            document.getElementById('new-sharing-theme').value = '';
            document.getElementById('new-sharing-speaker').value = '';
            document.getElementById('new-sharing-schedule').value = '';
        }

        function deleteSharing(id) {
            if (isReadOnly) {
                alert('主管角色無法刪除分享會');
                return;
            }
            if (!confirm('確定要刪除此分享會嗎？')) return;
            
            const index = sharingSessions.findIndex(s => s.id === id);
            if (index > -1) {
                sharingSessions.splice(index, 1);
                // 同步整個 sharingSessions 陣列以避免覆蓋問題
                syncToFirebase('sharingSessions', sharingSessions);
            }
            renderSharingDashboard();
        }

        function editSharing(id) {
            if (isReadOnly) {
                alert('主管角色無法編輯分享會');
                return;
            }

            const sharing = sharingSessions.find(s => s.id === id);
            if (!sharing) {
                alert('找不到該分享會');
                return;
            }

            currentSharingId = id;

            // 填充表單
            document.getElementById('edit-sharing-date').value = sharing.date;
            document.getElementById('edit-sharing-theme').value = sharing.theme;
            document.getElementById('edit-sharing-speaker').value = sharing.speaker;
            document.getElementById('edit-sharing-status').value = sharing.status;
            document.getElementById('edit-sharing-schedule').value = sharing.schedule.join('\n');

            // 顯示模態框
            document.getElementById('edit-sharing-modal').classList.add('show');
        }

        function closeEditSharingModal() {
            document.getElementById('edit-sharing-modal').classList.remove('show');
            currentSharingId = null;
        }

        function saveEditSharing() {
            if (!currentSharingId) return;

            const sharing = sharingSessions.find(s => s.id === currentSharingId);
            if (!sharing) {
                alert('找不到該分享會');
                return;
            }

            const schedule = document.getElementById('edit-sharing-schedule').value.split('\n').filter(s => s.trim());

            sharing.date = document.getElementById('edit-sharing-date').value;
            sharing.theme = document.getElementById('edit-sharing-theme').value;
            sharing.speaker = document.getElementById('edit-sharing-speaker').value;
            sharing.status = document.getElementById('edit-sharing-status').value;
            sharing.schedule = schedule;

            if (!sharing.date || !sharing.theme || !sharing.speaker) {
                alert('請填寫所有必填欄位');
                return;
            }

            syncToFirebase('sharingSessions', sharingSessions);
            closeEditSharingModal();
            renderSharingDashboard();
            alert('分享會已更新');
        }

        // 分享會評論功能
        function renderSharingComments(comments) {
            if (!comments || comments.length === 0) {
                return '<p class="text-sm text-gray-400 text-center py-2">尚無評論</p>';
            }

            return comments.map(comment => {
                const date = new Date(comment.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isManager = comment.author === '主管';

                return `
                    <div class="p-3 rounded-lg ${isManager ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200'}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm ${isManager ? 'text-red-800' : 'text-gray-800'}">
                                <i class="fas fa-user-circle mr-1"></i>${comment.author}
                            </span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <p class="text-sm ${isManager ? 'text-red-700' : 'text-gray-700'}">${comment.text}</p>
                    </div>
                `;
            }).join('');
        }

        function addSharingComment(sessionId) {
            const input = document.getElementById(`sharing-comment-${sessionId}`);
            const text = input.value.trim();

            if (!text) {
                alert('請輸入評論內容');
                return;
            }

            const session = sharingSessions.find(s => s.id === sessionId);
            if (!session) {
                alert('找不到該分享會');
                return;
            }

            if (!session.comments) session.comments = [];

            const comment = {
                id: generateUniqueId(),
                author: '主管',  // 只有主管能評論
                text: text,
                timestamp: new Date().toISOString()
            };

            session.comments.push(comment);
            syncToFirebase('sharingSessions', sharingSessions);

            input.value = '';
            renderSharingDashboard();
        }

        // === 4. 活動參與儀表板 ===
        function renderEventsDashboard(filteredEvents = null) {
            const container = document.getElementById('event-participation-content');
            if (!container) {
                console.error('活動容器未找到');
                return;
            }

            // 安全檢查：確保 eventsAttended 已初始化
            if (!eventsAttended || !Array.isArray(eventsAttended)) {
                console.warn('活動資料尚未載入');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">資料載入中...</div>';
                return;
            }

            // 如果資料為空，顯示友善提示
            if (eventsAttended.length === 0) {
                console.log('📝 活動資料庫為空');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-orange-50 rounded-lg p-12"><i class="fas fa-calendar-alt text-6xl text-orange-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">尚無活動資料</p><p class="text-gray-500">點擊上方「新增活動」按鈕開始記錄您的第一個活動</p></div>';
                return;
            }

            const events = filteredEvents || eventsAttended;

            const internalEvents = events.filter(e => e.type === 'internal');
            const externalEvents = events.filter(e => e.type === 'external');

            const renderEventSection = (title, events) => {
                if (events.length === 0) return '';

                const eventsHtml = events.map(event => {
                    const learningsHtml = (event.learnings && Array.isArray(event.learnings))
                        ? event.learnings.map(learning => `<li class="text-gray-600">${learning}</li>`).join('')
                        : '<li class="text-gray-400">學習心得未設定</li>';
                    const filesHtml = event.files && Array.isArray(event.files) ? event.files.map(file => {
                        if (file.link === '#' || !file.link) {
                            return `<span class="inline-block bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm mr-2 mb-2">
                                <i class="fas fa-file mr-1"></i>${file.name}
                            </span>`;
                        } else {
                            return `<a href="${file.link}" target="_blank" class="inline-block bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1 rounded-full text-sm mr-2 mb-2 transition-colors">
                                <i class="fas fa-download mr-1"></i>${file.name}
                            </a>`;
                        }
                    }).join('') : '';

                    return `
                        <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${event.eventName}</h3>
                                    <p class="text-gray-500 mt-1">${event.date}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="bg-${event.type === 'external' ? 'blue' : 'green'}-100 text-${event.type === 'external' ? 'blue' : 'green'}-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${event.type === 'external' ? '外部活動' : '內部活動'}
                                    </span>
                                    ${!isReadOnly ? `
                                        <button onclick="editEvent(${event.id})" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteEvent(${event.id})" class="bg-red-100 text-red-800 px-3 py-1 rounded text-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">活動概述：</h4>
                                <p class="text-gray-600">${event.summary}</p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">主要學習與收穫：</h4>
                                <ul class="list-disc list-inside space-y-1">${learningsHtml}</ul>
                            </div>
                            ${event.files && event.files.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">相關資料：</h4>
                                <div class="flex flex-wrap">${filesHtml}</div>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');

                return `
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-gray-200">${title}</h2>
                        <div class="space-y-6">${eventsHtml}</div>
                    </section>
                `;
            };

            container.innerHTML = renderEventSection('外部活動', externalEvents) + renderEventSection('內部活動', internalEvents);
        }

        function showAddEventModal() {
            document.getElementById('add-event-modal').classList.add('show');
        }

        function closeAddEventModal() {
            document.getElementById('add-event-modal').classList.remove('show');
        }

        function addNewEvent() {
            const learnings = document.getElementById('new-event-learnings').value.split('\n').filter(l => l.trim());
            
            const newEvent = {
                id: generateUniqueId(),
                eventName: document.getElementById('new-event-name').value,
                date: document.getElementById('new-event-date').value,
                type: document.getElementById('new-event-type').value,
                summary: document.getElementById('new-event-summary').value,
                learnings: learnings,
                files: []
            };

            if (!newEvent.eventName || !newEvent.date || !newEvent.summary) {
                alert('請填寫所有必填欄位');
                return;
            }

            eventsAttended.push(newEvent);
            // 同步整個 events 陣列以避免覆蓋問題
            syncToFirebase('events', eventsAttended);
            
            closeAddEventModal();
            renderEventsDashboard();
            
            // 清空表單
            document.getElementById('new-event-name').value = '';
            document.getElementById('new-event-date').value = '';
            document.getElementById('new-event-summary').value = '';
            document.getElementById('new-event-learnings').value = '';
        }

        function deleteEvent(id) {
            if (isReadOnly) {
                alert('主管角色無法刪除活動紀錄');
                return;
            }
            if (!confirm('確定要刪除此活動紀錄嗎？')) return;

            const index = eventsAttended.findIndex(e => e.id === id);
            if (index > -1) {
                eventsAttended.splice(index, 1);
                // 同步整個 events 陣列以避免覆蓋問題
                syncToFirebase('events', eventsAttended);
            }
            renderEventsDashboard();
        }

        function editEvent(id) {
            if (isReadOnly) {
                alert('主管角色無法編輯活動');
                return;
            }

            const event = eventsAttended.find(e => e.id === id);
            if (!event) {
                alert('找不到該活動');
                return;
            }

            currentEventId = id;

            // 填充表單
            document.getElementById('edit-event-name').value = event.eventName;
            document.getElementById('edit-event-date').value = event.date;
            document.getElementById('edit-event-type').value = event.type;
            document.getElementById('edit-event-summary').value = event.summary;
            document.getElementById('edit-event-learnings').value = event.learnings.join('\n');

            // 顯示模態框
            document.getElementById('edit-event-modal').classList.add('show');
        }

        function closeEditEventModal() {
            document.getElementById('edit-event-modal').classList.remove('show');
            currentEventId = null;
        }

        function saveEditEvent() {
            if (!currentEventId) return;

            const event = eventsAttended.find(e => e.id === currentEventId);
            if (!event) {
                alert('找不到該活動');
                return;
            }

            const learnings = document.getElementById('edit-event-learnings').value.split('\n').filter(l => l.trim());

            event.eventName = document.getElementById('edit-event-name').value;
            event.date = document.getElementById('edit-event-date').value;
            event.type = document.getElementById('edit-event-type').value;
            event.summary = document.getElementById('edit-event-summary').value;
            event.learnings = learnings;

            if (!event.eventName || !event.date || !event.summary) {
                alert('請填寫所有必填欄位');
                return;
            }

            syncToFirebase('events', eventsAttended);
            closeEditEventModal();
            renderEventsDashboard();
            alert('活動已更新');
        }

        function filterEvents() {
            const searchTerm = document.getElementById('event-search').value.toLowerCase();
            const typeFilter = document.getElementById('event-type-filter').value;

            let filtered = eventsAttended;

            // 類型篩選
            if (typeFilter !== 'all') {
                filtered = filtered.filter(e => e.type === typeFilter);
            }

            // 搜尋篩選
            if (searchTerm) {
                filtered = filtered.filter(e =>
                    e.eventName.toLowerCase().includes(searchTerm) ||
                    e.summary.toLowerCase().includes(searchTerm) ||
                    e.learnings.some(l => l.toLowerCase().includes(searchTerm))
                );
            }

            renderEventsDashboard(filtered);
        }

        // === 5. 接洽企業儀表板 ===
        function renderContactsDashboard(filteredContacts = null) {
            const container = document.getElementById('business-contacts-content');
            if (!container) {
                console.error('企業接洽容器未找到');
                return;
            }

            // 安全檢查：確保 businessContacts 已初始化
            if (!businessContacts || !Array.isArray(businessContacts)) {
                console.warn('企業接洽資料尚未載入');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">資料載入中...</div>';
                return;
            }

            // 如果資料為空，顯示友善提示
            if (businessContacts.length === 0) {
                console.log('📝 企業接洽資料庫為空');
                container.innerHTML = '<div class="text-center text-gray-500 py-8 bg-green-50 rounded-lg p-12"><i class="fas fa-building text-6xl text-green-300 mb-4"></i><p class="text-xl font-semibold text-gray-700 mb-2">尚無企業接洽資料</p><p class="text-gray-500">點擊上方「新增企業接洽」按鈕開始記錄您的第一筆接洽記錄</p></div>';
                return;
            }

            const contacts = filteredContacts || businessContacts;

            const tableRows = contacts.map(contact => {
                const filesHtml = contact.files && contact.files.length > 0 ? contact.files.map(file => {
                    if (file.link === '#' || !file.link) {
                        return `<span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs mr-1 mb-1">
                            <i class="fas fa-file mr-1"></i>${file.name}
                        </span>`;
                    } else {
                        return `<a href="${file.link}" target="_blank" class="inline-block bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded text-xs mr-1 mb-1 transition-colors">
                            <i class="fas fa-download mr-1"></i>${file.name}
                        </a>`;
                    }
                }).join('') : '<span class="text-sm text-gray-400">無</span>';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${contact.companyName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${contact.contactPerson}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${contact.date}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 max-w-xs">${contact.topic}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap">${filesHtml}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                ${!isReadOnly ? `
                                    <button onclick="editContact(${contact.id})" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteContact(${contact.id})" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : '<span class="text-sm text-gray-400">-</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">企業名稱</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">聯絡人</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">接洽日期</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">洽談主題</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">相關資料</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAddContactModal() {
            document.getElementById('add-contact-modal').classList.add('show');
        }

        function closeAddContactModal() {
            document.getElementById('add-contact-modal').classList.remove('show');
        }

        function addNewContact() {
            const newContact = {
                id: generateUniqueId(),
                companyName: document.getElementById('new-contact-company').value,
                contactPerson: document.getElementById('new-contact-person').value,
                date: document.getElementById('new-contact-date').value,
                topic: document.getElementById('new-contact-topic').value,
                files: []
            };

            if (!newContact.companyName || !newContact.contactPerson || !newContact.date || !newContact.topic) {
                alert('請填寫所有欄位');
                return;
            }

            businessContacts.push(newContact);
            // 同步整個 contacts 陣列以避免覆蓋問題
            syncToFirebase('contacts', businessContacts);
            
            closeAddContactModal();
            renderContactsDashboard();
            
            // 清空表單
            document.getElementById('new-contact-company').value = '';
            document.getElementById('new-contact-person').value = '';
            document.getElementById('new-contact-date').value = '';
            document.getElementById('new-contact-topic').value = '';
        }

        function deleteContact(id) {
            if (isReadOnly) {
                alert('主管角色無法刪除接洽紀錄');
                return;
            }
            if (!confirm('確定要刪除此接洽紀錄嗎？')) return;

            const index = businessContacts.findIndex(c => c.id === id);
            if (index > -1) {
                businessContacts.splice(index, 1);
                // 同步整個 contacts 陣列以避免覆蓋問題
                syncToFirebase('contacts', businessContacts);
            }
            renderContactsDashboard();
        }

        function editContact(id) {
            if (isReadOnly) {
                alert('主管角色無法編輯接洽紀錄');
                return;
            }

            const contact = businessContacts.find(c => c.id === id);
            if (!contact) {
                alert('找不到該接洽紀錄');
                return;
            }

            currentContactId = id;

            // 填充表單
            document.getElementById('edit-contact-company').value = contact.companyName;
            document.getElementById('edit-contact-person').value = contact.contactPerson;
            document.getElementById('edit-contact-date').value = contact.date;
            document.getElementById('edit-contact-topic').value = contact.topic;

            // 顯示模態框
            document.getElementById('edit-contact-modal').classList.add('show');
        }

        function closeEditContactModal() {
            document.getElementById('edit-contact-modal').classList.remove('show');
            currentContactId = null;
        }

        function saveEditContact() {
            if (!currentContactId) return;

            const contact = businessContacts.find(c => c.id === currentContactId);
            if (!contact) {
                alert('找不到該接洽紀錄');
                return;
            }

            contact.companyName = document.getElementById('edit-contact-company').value;
            contact.contactPerson = document.getElementById('edit-contact-person').value;
            contact.date = document.getElementById('edit-contact-date').value;
            contact.topic = document.getElementById('edit-contact-topic').value;

            if (!contact.companyName || !contact.contactPerson || !contact.date || !contact.topic) {
                alert('請填寫所有欄位');
                return;
            }

            syncToFirebase('contacts', businessContacts);
            closeEditContactModal();
            renderContactsDashboard();
            alert('接洽紀錄已更新');
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contact-search').value.toLowerCase();

            if (!searchTerm) {
                renderContactsDashboard();
                return;
            }

            const filtered = businessContacts.filter(c =>
                c.companyName.toLowerCase().includes(searchTerm) ||
                c.contactPerson.toLowerCase().includes(searchTerm) ||
                c.topic.toLowerCase().includes(searchTerm)
            );

            renderContactsDashboard(filtered);
        }

        // === 檔案上傳功能 ===
        function setupFileUpload() {
            const area = document.getElementById('file-upload-area');
            const input = document.getElementById('file-input');
            const selectBtn = document.getElementById('select-files');

            if (!area || !input || !selectBtn) return;

            selectBtn.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => handleFiles(e.target.files));

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer && e.dataTransfer.files) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }

        async function handleFiles(fileList) {
            if (!currentProjectId) return;
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            if (!project.files) project.files = [];

            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-bar');
            const progressPercent = document.getElementById('upload-percent');

            for (let file of fileList) {
                // 檢查檔案大小（最大 10MB）
                if (file.size > 10 * 1024 * 1024) {
                    alert(`檔案 ${file.name} 超過 10MB 限制`);
                    continue;
                }

                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';

                if (isFirebaseInitialized) {
                    // 上傳到 Firebase Storage
                    const storageRef = storage.ref(`projects/${currentProjectId}/${Date.now()}_${file.name}`);
                    const uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressPercent.textContent = Math.round(progress) + '%';
                        },
                        (error) => {
                            console.error('上傳失敗:', error);
                            alert('檔案上傳失敗');
                            progressDiv.classList.add('hidden');
                        },
                        async () => {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            const fileInfo = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                url: downloadURL,
                                uploadTime: new Date().toISOString()
                            };

                            project.files.push(fileInfo);
                            syncToFirebase('projects/' + currentProjectId + '/files', project.files);
                            renderFilesList(project.files);
                            progressDiv.classList.add('hidden');
                        }
                    );
                } else {
                    // 離線模式：使用 blob URL
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: URL.createObjectURL(file),
                        uploadTime: new Date().toISOString()
                    };
                    project.files.push(fileInfo);
                    renderFilesList(project.files);
                    progressDiv.classList.add('hidden');
                }
            }
        }

        // === 分享會/活動/企業接洽 檔案上傳功能 ===
        let currentSharingFiles = [];
        let currentEventFiles = [];
        let currentContactFiles = [];

        function setupAllFileUploads() {
            setupFileUpload(); // 原有的專案檔案上傳
            setupSharingFileUpload();
            setupEventFileUpload();
            setupContactFileUpload();
        }

        function setupSharingFileUpload() {
            // 新增分享會檔案上傳
            const newArea = document.getElementById('sharing-file-upload-area');
            const newInput = document.getElementById('sharing-file-input');
            if (newArea && newInput) {
                newArea.addEventListener('click', () => newInput.click());
                newInput.addEventListener('change', (e) => handleSharingFiles(e.target.files, 'new'));
                setupDragDrop(newArea, (files) => handleSharingFiles(files, 'new'));
            }

            // 編輯分享會檔案上傳
            const editArea = document.getElementById('edit-sharing-file-upload-area');
            const editInput = document.getElementById('edit-sharing-file-input');
            if (editArea && editInput) {
                editArea.addEventListener('click', () => editInput.click());
                editInput.addEventListener('change', (e) => handleSharingFiles(e.target.files, 'edit'));
                setupDragDrop(editArea, (files) => handleSharingFiles(files, 'edit'));
            }
        }

        function setupEventFileUpload() {
            // 新增活動檔案上傳
            const newArea = document.getElementById('event-file-upload-area');
            const newInput = document.getElementById('event-file-input');
            if (newArea && newInput) {
                newArea.addEventListener('click', () => newInput.click());
                newInput.addEventListener('change', (e) => handleEventFiles(e.target.files, 'new'));
                setupDragDrop(newArea, (files) => handleEventFiles(files, 'new'));
            }

            // 編輯活動檔案上傳
            const editArea = document.getElementById('edit-event-file-upload-area');
            const editInput = document.getElementById('edit-event-file-input');
            if (editArea && editInput) {
                editArea.addEventListener('click', () => editInput.click());
                editInput.addEventListener('change', (e) => handleEventFiles(e.target.files, 'edit'));
                setupDragDrop(editArea, (files) => handleEventFiles(files, 'edit'));
            }
        }

        function setupContactFileUpload() {
            // 新增接洽檔案上傳
            const newArea = document.getElementById('contact-file-upload-area');
            const newInput = document.getElementById('contact-file-input');
            if (newArea && newInput) {
                newArea.addEventListener('click', () => newInput.click());
                newInput.addEventListener('change', (e) => handleContactFiles(e.target.files, 'new'));
                setupDragDrop(newArea, (files) => handleContactFiles(files, 'new'));
            }

            // 編輯接洽檔案上傳
            const editArea = document.getElementById('edit-contact-file-upload-area');
            const editInput = document.getElementById('edit-contact-file-input');
            if (editArea && editInput) {
                editArea.addEventListener('click', () => editInput.click());
                editInput.addEventListener('change', (e) => handleContactFiles(e.target.files, 'edit'));
                setupDragDrop(editArea, (files) => handleContactFiles(files, 'edit'));
            }
        }

        function setupDragDrop(area, handler) {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer && e.dataTransfer.files) {
                    handler(e.dataTransfer.files);
                }
            });
        }

        async function handleSharingFiles(fileList, mode) {
            for (let file of fileList) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`檔案 ${file.name} 超過 10MB 限制`);
                    continue;
                }
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file),
                    file: file
                };
                currentSharingFiles.push(fileInfo);
            }
            renderFilesList(`${mode}-sharing-files-list`, currentSharingFiles);
        }

        async function handleEventFiles(fileList, mode) {
            for (let file of fileList) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`檔案 ${file.name} 超過 10MB 限制`);
                    continue;
                }
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file),
                    file: file
                };
                currentEventFiles.push(fileInfo);
            }
            renderFilesList(`${mode}-event-files-list`, currentEventFiles);
        }

        async function handleContactFiles(fileList, mode) {
            for (let file of fileList) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`檔案 ${file.name} 超過 10MB 限制`);
                    continue;
                }
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file),
                    file: file
                };
                currentContactFiles.push(fileInfo);
            }
            renderFilesList(`${mode}-contact-files-list`, currentContactFiles);
        }

        function renderFilesList(listId, files) {
            const list = document.getElementById(listId);
            if (!list) return;

            list.innerHTML = files.map((f, i) => `
                <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded text-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-gray-400"></i>
                        <span class="text-gray-700">${f.name}</span>
                        <span class="text-gray-400 text-xs">(${(f.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removeFile('${listId}', ${i})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(listId, index) {
            if (listId.includes('sharing')) {
                currentSharingFiles.splice(index, 1);
                renderFilesList(listId, currentSharingFiles);
            } else if (listId.includes('event')) {
                currentEventFiles.splice(index, 1);
                renderFilesList(listId, currentEventFiles);
            } else if (listId.includes('contact')) {
                currentContactFiles.splice(index, 1);
                renderFilesList(listId, currentContactFiles);
            }
        }

        // === Modal 事件設置 ===
        function setupModalEvents() {
            // 專案 Modal
            document.getElementById('close-modal')?.addEventListener('click', closeProjectModal);
            document.getElementById('close-modal-btn')?.addEventListener('click', closeProjectModal);
            document.getElementById('toggle-edit-mode')?.addEventListener('click', toggleEditMode);
            document.getElementById('save-notes')?.addEventListener('click', saveNotes);
            document.getElementById('add-comment')?.addEventListener('click', addComment);
            document.getElementById('export-project')?.addEventListener('click', exportCurrentProject);

            // 評論 Enter 發送
            document.getElementById('new-comment')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addComment();
                }
            });

            // ESC 關閉所有 Modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });

            // 點擊遮罩關閉 Modal
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // 檔案上傳
            setupAllFileUploads();
        }
    </script>
</body>
</html>


